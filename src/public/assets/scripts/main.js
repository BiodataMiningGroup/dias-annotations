angular.module("dias.annotations",["dias.api","dias.ui.messages"]),angular.module("dias.annotations").controller("AnnotationsController",["$scope","mapAnnotations","labels","annotations","shapes",function(e,t,n,o){"use strict";e.selectedFeatures=t.getSelectedFeatures().getArray(),e.$watchCollection("selectedFeatures",function(e){e.forEach(function(e){n.fetchForAnnotation(e.annotation)})});var i=function(){e.annotations=o.current()},r=t.getSelectedFeatures();e.annotations=[],e.clearSelection=t.clearSelection,e.selectAnnotation=function(n,o){n.shiftKey||e.clearSelection(),t.select(o)},e.isSelected=function(e){var t=!1;return r.forEach(function(n){n.annotation&&n.annotation.id==e&&(t=!0)}),t},e.$on("image.shown",i)}]),angular.module("dias.annotations").controller("AnnotatorController",["$scope","$attrs","images","urlParams","msg",function(e,t,n,o,i){"use strict";e.images=n,e.imageLoading=!0,e.editMode=!!t.editMode,e.viewport={zoom:o.get("z"),center:[o.get("x"),o.get("y")]};var r=function(){e.imageLoading=!1,e.$broadcast("image.shown",e.images.currentImage)},a=function(){o.pushState(e.images.currentImage._id)},s=function(){e.imageLoading=!0},c=function(e){return s(),n.show(parseInt(e)).then(r).catch(i.responseError)},l=function(t){switch(t.keyCode){case 37:e.prevImage();break;case 39:e.nextImage()}};e.nextImage=function(){s(),n.next().then(r).then(a).catch(i.responseError)},e.prevImage=function(){s(),n.prev().then(r).then(a).catch(i.responseError)},e.$on("canvas.moveend",function(t,n){e.viewport.zoom=n.zoom,e.viewport.center[0]=Math.round(n.center[0]),e.viewport.center[1]=Math.round(n.center[1]),o.set({z:e.viewport.zoom,x:e.viewport.center[0],y:e.viewport.center[1]})}),window.onpopstate=function(e){var t=e.state;t&&void 0!==t.slug&&c(t.slug)},document.addEventListener("keypress",l),n.init(t.transectId),c(t.imageId).then(a)}]),angular.module("dias.annotations").controller("CanvasController",["$scope","mapImage","mapAnnotations","map","$timeout",function(e,t,n,o,i){"use strict";o.on("moveend",function(){var t=o.getView();e.$emit("canvas.moveend",{center:t.getCenter(),zoom:t.getZoom()})}),t.init(e),n.init(e);var r=function(){i(function(){o.updateSize()},0,!1)};e.$on("sidebar.foldout.open",r),e.$on("sidebar.foldout.close",r)}]),angular.module("dias.annotations").controller("CategoriesController",["$scope","labels",function(e,t){"use strict";e.categories=t.getAll(),e.categoriesTree=t.getTree(),e.selectItem=function(n){t.setSelected(n),e.searchCategory="",e.$broadcast("categories.selected",n)}}]),angular.module("dias.annotations").controller("ConfidenceController",["$scope","labels",function(e,t){"use strict";e.confidence=.5,e.$watch("confidence",function(n){t.setCurrentConfidence(parseFloat(n)),e.confidenceClass=.25>=n?"label-danger":.5>=n?"label-warning":.75>=n?"label-success":"label-primary"})}]),angular.module("dias.annotations").controller("ControlsController",["$scope","mapAnnotations","labels","msg","$attrs",function(e,t,n,o,i){"use strict";var r=!1;e.selectShape=function(a){return n.hasSelected()?(t.finishDrawing(),r||null===a?(e.selectedShape="",r=!1):(e.selectedShape=a,t.startDrawing(a),r=!0),void 0):(e.openFoldout("categories"),o.info(i.selectCategory),void 0)}}]),angular.module("dias.annotations").controller("MinimapController",["$scope","map","mapImage","$element","styles",function(e,t,n,o,i){"use strict";var r=new ol.Map({target:"minimap",controls:[],interactions:[]});r.bindTo("layergroup",t);var a=new ol.FeatureOverlay({map:r,style:i.viewport}),s=new ol.Feature;a.addFeature(s),e.$on("image.shown",function(){r.setView(new ol.View({projection:n.getProjection(),center:ol.extent.getCenter(n.getExtent()),zoom:0}))});var c=function(){var e=t.getView().calculateExtent(t.getSize());s.setGeometry(ol.geom.Polygon.fromExtent(e))};t.on("moveend",c);var l=function(e){t.getView().setCenter(e.coordinate)};r.on("pointerdrag",l),o.on("mouseleave",function(){r.un("pointerdrag",l)}),o.on("mouseenter",function(){r.on("pointerdrag",l)})}]),angular.module("dias.annotations").controller("SidebarController",["$scope","$rootScope","mapAnnotations",function(e,t,n){"use strict";e.foldout="",e.openFoldout=function(n){e.foldout=n,t.$broadcast("sidebar.foldout.open")},e.closeFoldout=function(){e.foldout="",t.$broadcast("sidebar.foldout.close")},e.toggleFoldout=function(t){e.foldout===t?e.closeFoldout():e.openFoldout(t)},e.deleteSelectedAnnotations=n.deleteSelected}]),angular.module("dias.annotations").directive("annotationListItem",["labels",function(e){"use strict";return{scope:!0,controller:["$scope",function(t){t.shapeClass="icon-"+t.annotation.shape.toLowerCase(),t.selected=function(){return t.isSelected(t.annotation.id)},t.attachLabel=function(){e.attachToAnnotation(t.annotation)},t.removeLabel=function(n){e.removeFromAnnotation(t.annotation,n)},t.canAttachLabel=function(){return t.selected()&&e.hasSelected()},t.currentLabel=e.getSelected,t.currentConfidence=e.getCurrentConfidence}]}}]),angular.module("dias.annotations").directive("labelCategoryItem",["$compile","$timeout",function(e,t){"use strict";return{restrict:"C",template:'<span class="item__name" data-ng-click="selectItem(item)">{{item.name}}</span>',scope:!0,link:function(n,o){var i=angular.element('<ul class="label-category-subtree list-unstyled"><li class="label-category-item" data-ng-class="{open: isOpen, expandable: isExpandable, selected: isSelected}" data-ng-repeat="item in categoriesTree[item.id]"></li></ul>');t(function(){o.append(e(i)(n))})},controller:["$scope",function(e){e.isOpen=!1,e.isExpandable=!!e.categoriesTree[e.item.id],e.isSelected=!1,e.$on("categories.selected",function(t,n){e.item.id===n.id?(e.isOpen=!0,e.isSelected=!0,e.$emit("categories.openParents")):(e.isOpen=!1,e.isSelected=!1)}),e.$on("categories.openParents",function(t){e.isOpen=!0,null===e.item.parent_id&&t.stopPropagation()})}]}}]),angular.module("dias.annotations").directive("labelItem",function(){"use strict";return{controller:["$scope",function(e){var t=e.annotationLabel.confidence;e.class=.25>=t?"label-danger":.5>=t?"label-warning":.75>=t?"label-success":"label-primary"}]}}),angular.module("dias.annotations").factory("debounce",["$timeout","$q",function(e,t){"use strict";var n={};return function(o,i,r){var a=t.defer();return function(){var s=this,c=arguments,l=function(){n[r]=void 0,a.resolve(o.apply(s,c)),a=t.defer()};return n[r]&&e.cancel(n[r]),n[r]=e(l,i),a.promise}()}}]),angular.module("dias.annotations").factory("map",function(){"use strict";var e=new ol.Map({target:"canvas",controls:[new ol.control.Zoom,new ol.control.ZoomToExtent,new ol.control.FullScreen]});return e}),angular.module("dias.annotations").service("annotations",["Annotation","shapes","labels","msg",function(e,t,n,o){"use strict";var i,r=function(e){return e.shape=t.getName(e.shape_id),e},a=function(e){return i.push(e),e};this.query=function(t){return i=e.query(t),i.$promise.then(function(e){e.forEach(r)}),i},this.add=function(i){!i.shape_id&&i.shape&&(i.shape_id=t.getId(i.shape));var s=n.getSelected();i.label_id=s.id,i.confidence=n.getCurrentConfidence();var c=e.add(i);return c.$promise.then(r).then(a).catch(o.responseError),c},this.delete=function(e){var t=i.indexOf(e);return t>-1?e.$delete(function(){t=i.indexOf(e),i.splice(t,1)},o.responseError):void 0},this.forEach=function(e){return i.forEach(e)},this.current=function(){return i}}]),angular.module("dias.annotations").service("images",["TransectImage","URL","$q",function(e,t,n){"use strict";var o=this,i=[],r=10,a=[];this.currentImage=void 0;var s=function(e){e=e||o.currentImage._id;var t=i.indexOf(e);return i[(t+1)%i.length]},c=function(e){e=e||o.currentImage._id;var t=i.indexOf(e),n=i.length;return i[(t-1+n)%n]},l=function(e){e=e||o.currentImage._id;for(var t=a.length-1;t>=0;t--)if(a[t]._id==e)return a[t];return void 0},u=function(e){o.currentImage=l(e)},d=function(e){var o=n.defer(),i=l(e);return i?o.resolve(i):(i=document.createElement("img"),i._id=e,i.onload=function(){a.push(i),a.length>r&&a.shift(),o.resolve(i)},i.onerror=function(e){o.reject(e)},i.src=t+"/api/v1/images/"+e+"/file"),o.promise};this.init=function(t){return i=e.query({transect_id:t}),i.$promise},this.show=function(e){var t=d(e).then(function(){u(e)});return i.$promise.then(function(){d(s(e)),d(c(e))}),t},this.next=function(){return o.show(s())},this.prev=function(){return o.show(c())},this.getCurrentId=function(){return o.currentImage._id}}]),angular.module("dias.annotations").service("labels",["AnnotationLabel","Label","msg",function(e,t,n){"use strict";var o,i=.5,r=t.query();this.fetchForAnnotation=function(t){return t?(t.labels||(t.labels=e.query({annotation_id:t.id})),t.labels):void 0},this.attachToAnnotation=function(t){var r=e.attach({annotation_id:t.id,label_id:o.id,confidence:i});return r.$promise.then(function(){t.labels.push(r)}),r.$promise.catch(n.responseError),r},this.removeFromAnnotation=function(e,t){var o=e.labels.indexOf(t);return o>-1?t.$delete(function(){o=e.labels.indexOf(t),e.labels.splice(o,1)},n.responseError):void 0},this.getTree=function(){var e={},t=function(t){var n=t.parent_id;e[n]?e[n].push(t):e[n]=[t]};return r.$promise.then(function(e){e.forEach(t)}),e},this.getAll=function(){return r},this.setSelected=function(e){o=e},this.getSelected=function(){return o},this.hasSelected=function(){return!!o},this.setCurrentConfidence=function(e){i=e},this.getCurrentConfidence=function(){return i}}]),angular.module("dias.annotations").service("mapAnnotations",["map","images","annotations","debounce","styles",function(e,t,n,o,i){"use strict";var r=new ol.FeatureOverlay({style:i.features}),a=new ol.Collection;r.setFeatures(a);var s,c=new ol.interaction.Select({style:i.highlight}),l=c.getFeatures(),u=new ol.interaction.Modify({features:r.getFeatures(),deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}}),d=function(e){return{x:e[0],y:t.currentImage.height-e[1]}},f=function(e){return[e.x,t.currentImage.height-e.y]},g=function(e){switch(e.getType()){case"Circle":return[e.getCenter(),[e.getRadius(),0]];case"Polygon":return e.getCoordinates()[0];case"Point":return[e.getCoordinates()];default:return e.getCoordinates()}},m=function(e){var t=e.target,n=function(){var e=g(t.getGeometry());t.annotation.points=e.map(d),t.annotation.$save()};o(n,500,t.annotation.id)},h=function(e){var t,n=e.points.map(f);switch(e.shape){case"Point":t=new ol.geom.Point(n[0]);break;case"Polygon":n.push(n[0]),t=new ol.geom.Polygon([n]);break;case"LineString":t=new ol.geom.LineString(n);break;case"Circle":t=new ol.geom.Circle(n[0],n[1][0])}var o=new ol.Feature({geometry:t});o.on("change",m),o.annotation=e,a.push(o)},p=function(e,t){a.clear(),l.clear(),n.query({id:t._id}).$promise.then(function(){n.forEach(h)})},v=function(e){var o=e.feature.getGeometry(),i=g(o);e.feature.annotation=n.add({id:t.getCurrentId(),shape:o.getType(),points:i.map(d)}),e.feature.annotation.$promise.catch(function(){a.remove(e.feature)})};this.init=function(t){r.setMap(e),e.addInteraction(c),t.$on("image.shown",p),l.on("change:length",function(){t.$$phase||t.$apply()})},this.startDrawing=function(t){e.removeInteraction(c),t=t||"Point",s=new ol.interaction.Draw({features:a,type:t,style:i.editing}),e.addInteraction(u),e.addInteraction(s),s.on("drawend",v)},this.finishDrawing=function(){e.removeInteraction(s),e.removeInteraction(u),e.addInteraction(c),l.clear()},this.deleteSelected=function(){l.forEach(function(e){n.delete(e.annotation).then(function(){a.remove(e),l.remove(e)})})},this.select=function(e){var t;a.forEach(function(n){n.annotation.id===e&&(t=n)}),l.remove(t)||l.push(t)},this.clearSelection=function(){l.clear()},this.getSelectedFeatures=function(){return l}}]),angular.module("dias.annotations").service("mapImage",["map",function(e){"use strict";var t=[0,0,0,0],n=new ol.proj.Projection({code:"dias-image",units:"pixels",extent:t}),o=new ol.layer.Image;this.init=function(i){e.addLayer(o),i.$on("image.shown",function(r,a){t[2]=a.width,t[3]=a.height;var s=i.viewport.zoom,c=i.viewport.center;void 0===c[0]&&void 0===c[1]&&(c=ol.extent.getCenter(t));var l=new ol.source.ImageStatic({url:a.src,projection:n,imageExtent:t});o.setSource(l),e.setView(new ol.View({projection:n,center:c,zoom:s,zoomFactor:1.5,minResolution:.25,extent:t})),void 0===s&&e.getView().fitExtent(t,e.getSize())})},this.getExtent=function(){return t},this.getProjection=function(){return n}}]),angular.module("dias.annotations").service("styles",function(){"use strict";var e=[255,255,255,1],t=[0,153,255,1],n="#ff5e00";this.features=[new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:5}),image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:t}),stroke:new ol.style.Stroke({color:e,width:2})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:t,width:3})})],this.highlight=[new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:6}),image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:n}),stroke:new ol.style.Stroke({color:e,width:3})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:n,width:3})})],this.editing=[new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:5}),image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:t}),stroke:new ol.style.Stroke({color:e,width:2,lineDash:[3]})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:t,width:3,lineDash:[5]})})],this.viewport=[new ol.style.Style({stroke:new ol.style.Stroke({color:t,width:3})}),new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:1})})]}),angular.module("dias.annotations").service("urlParams",function(){"use strict";var e={},t=function(){var e=location.hash.replace("#","").split("&"),t={};return e.forEach(function(e){var n=e.match(/(.+)\=(.+)/);n&&3===n.length&&(t[n[1]]=decodeURIComponent(n[2]))}),t},n=function(e){var t="";for(var n in e)t+=n+"="+encodeURIComponent(e[n])+"&";return t.substring(0,t.length-1)};this.pushState=function(t){e.slug=t,history.pushState(e,"",e.slug+"#"+n(e))},this.set=function(t){for(var o in t)e[o]=t[o];history.replaceState(e,"",e.slug+"#"+n(e))},this.get=function(t){return e[t]},e=history.state,e||(e=t())});
//# sourceMappingURL=main.js.map