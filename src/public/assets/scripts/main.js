!function(t){var e={};function n(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(i,a,function(e){return t[e]}.bind(null,a));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/",n(n.s=0)}({0:function(t,e,n){n("7p/M"),t.exports=n("zcrr")},"2e9+":function(t,e,n){"use strict";n.r(e);var i=n("E6vj"),a=n("t9jp"),o=n("i25t"),s=n("kLmy"),r={template:'<typeahead\n            :items="items"\n            :placeholder="placeholder"\n            :value="selectedItemName"\n            @select="select"\n        ></typeahead>',components:{typeahead:s.o},data:function(){return{name:"",placeholder:"",selectedItem:null}},computed:{items:function(){return[]},selectedItemName:function(){return this.selectedItem?this.selectedItem.name:""}},methods:{select:function(t){this.selectedItem=t,this.$emit("select",this)},filter:function(t){return t},reset:function(){this.selectedItem=null}},created:function(){this.$mount()}},l=Vue.extend({mixins:[r],components:{typeahead:s.h},data:function(){return{name:"label",annotations:[],placeholder:"label name"}},computed:{items:function(){var t={};return this.annotations.forEach((function(e){e.labels.forEach((function(e){t[e.label.id]=e.label}))})),Object.values(t)}},methods:{filter:function(t){var e=this.selectedItem.id;return t.filter((function(t){return t.labels.reduce((function(t,n){return t||n.label.id===e}),!1)}))}}}),c=Vue.extend({mixins:[r],data:function(){return{name:"session",sessions:[],placeholder:"session name"}},computed:{items:function(){return this.sessions.map((function(t){return t.starts_at=new Date(t.starts_at),t.ends_at=new Date(t.ends_at),t}))}},methods:{filter:function(t){var e=this.selectedItem,n={};return e.users.forEach((function(t){n[t.id]=null})),t.filter((function(t){for(var i=t.labels.length-1;i>=0;i--)if(n.hasOwnProperty(t.labels[i].user_id)){var a=new Date(t.created_at);return a>=e.starts_at&&a<e.ends_at}return!1}))}}}),u=n("u6rQ"),h=Vue.extend({mixins:[r],data:function(){return{name:"shape",shapes:[],placeholder:"shape name"}},computed:{items:function(){var t=this;return Object.keys(this.shapes).map((function(e){return{id:parseInt(e),name:t.shapes[e]}}))}},methods:{filter:function(t){var e=this;return t.filter((function(t){return t.shape_id===e.selectedItem.id}))}}}),d=Vue.extend({mixins:[r],data:function(){return{name:"user",annotations:[],placeholder:"user name"}},computed:{items:function(){var t={};return this.annotations.forEach((function(e){e.labels.forEach((function(e){t[e.user_id]=e.user}))})),Object.values(t).map((function(t){return t.name=t.firstname+" "+t.lastname,t}))}},methods:{filter:function(t){var e=this.selectedItem.id;return t.filter((function(t){return t.labels.reduce((function(t,n){return t||n.user_id===e}),!1)}))}}}),m=n("Nwv/"),f={components:{powerToggle:s.k},data:function(){return{mode:"default",modes:["default","volare","lawnmower","randomSampling","regularSampling"],restoreKeys:["randomSamplingNumber","regularSamplingRows","regularSamplingColumns"],randomSamplingNumber:9,regularSamplingRows:3,regularSamplingColumns:3}},computed:{isVolareActive:function(){return"volare"===this.mode},isLawnmowerActive:function(){return"lawnmower"===this.mode},isRandomSamplingActive:function(){return"randomSampling"===this.mode},isRegularSamplingActive:function(){return"regularSampling"===this.mode}},methods:{startVolare:function(){this.setMode("volare")},startLawnmower:function(){this.setMode("lawnmower")},startRandomSampling:function(){this.setMode("randomSampling")},startRegularSampling:function(){this.setMode("regularSampling")},setMode:function(t){-1!==this.modes.indexOf(t)&&(this.mode=t)},resetMode:function(){this.mode="default"},emitAttachLabel:function(){this.$emit("attach-label")},emitCreateSample:function(){this.$emit("create-sample")}},watch:{mode:function(t,e){switch(e){case"volare":s.f.off("Enter",this.emitAttachLabel);break;case"randomSampling":case"regularSampling":s.f.off("Enter",this.emitCreateSample)}switch(t){case"volare":s.f.on("Enter",this.emitAttachLabel);break;case"randomSampling":case"regularSampling":s.f.on("Enter",this.emitCreateSample)}switch(t){case"randomSampling":this.$emit("change",t,this.randomSamplingNumber);break;case"regularSampling":this.$emit("change",t,[this.regularSamplingRows,this.regularSamplingColumns]);break;default:this.$emit("change",t)}},randomSamplingNumber:function(t){u.a.set("randomSamplingNumber",t)},regularSamplingRows:function(t){u.a.set("regularSamplingRows",t)},regularSamplingColumns:function(t){u.a.set("regularSamplingColumns",t)}},created:function(){var t=this;this.restoreKeys.forEach((function(e){t[e]=u.a.get(e)}));var e=s.p.get("annotationMode");e&&s.b.$once("images.change",(function(){t.setMode(e)}))}},g={data:function(){return{isBrightnessRgbActive:!1,colorAdjustment:{brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]}}},methods:{resetType:function(t,e){void 0!==e?this.colorAdjustment[t].splice(e,1,0):this.colorAdjustment[t]=this.colorAdjustment[t].map((function(){return 0}))},reset:function(){for(var t in this.colorAdjustment)this.colorAdjustment.hasOwnProperty(t)&&this.resetType(t)},toggleBrightnessRgb:function(){this.isBrightnessRgbActive?this.resetType("brightnessRGB"):this.resetType("brightnessContrast",0),this.isBrightnessRgbActive=!this.isBrightnessRgbActive}},watch:{colorAdjustment:{handler:function(){this.$emit("change",this.colorAdjustment)},deep:!0}}};var p,b,v,I=(p={mixins:[s.i],components:{imageLabelList:s.c},props:{imageId:{required:!0,type:Number},selectedLabel:{type:Object,default:null}},data:function(){return{cache:{},open:!1,currentLabels:[],saving:!1,userId:null,isAdmin:!1}},computed:{hasLabels:function(){return this.currentLabels.length>0},hasSelectedLabel:function(){return null!==this.selectedLabel},canAttachSelectedLabel:function(){if(this.hasSelectedLabel){for(var t=this.currentLabels.length-1;t>=0;t--)if(this.currentLabels[t].label.id===this.selectedLabel.id)return!1;return!0}return!1},proposedLabelTitle:function(){return this.hasSelectedLabel?this.canAttachSelectedLabel?"Attach '".concat(this.selectedLabel.name,"' as new image label"):"The selected label is already attached.":"Please select a label first."}},methods:{startSaving:function(){this.saving=!0},finishSaving:function(){this.saving=!1},showImageLabels:function(t){this.cache.hasOwnProperty(t)||(this.startLoading(),this.currentLabels=[],this.cache[t]=s.d.query({image_id:t}),this.cache[t].finally(this.finishLoading)),this.cache[t].then(this.updateCurrentLabels,s.r)},updateCurrentLabels:function(t){this.currentLabels=t.body},handleDeletedLabel:function(t){for(var e=this.currentLabels.length-1;e>=0;e--)if(this.currentLabels[e].id===t.id){this.currentLabels.splice(e,1);break}},attachSelectedLabel:function(){this.startSaving();var t=this.currentLabels;s.d.save({image_id:this.imageId},{label_id:this.selectedLabel.id}).then((function(e){t.push(e.data)}),s.r).finally(this.finishSaving)}},watch:{imageId:function(t){this.open&&this.showImageLabels(t)},open:function(t){t&&this.showImageLabels(this.imageId)}},created:function(){var t=this;this.$parent.$watch("open",(function(e){t.open=e}))}},v=function(){this.userId=biigle.$require("annotations.userId"),this.isAdmin=biigle.$require("annotations.isAdmin")},(b="created")in p?Object.defineProperty(p,b,{value:v,enumerable:!0,configurable:!0,writable:!0}):p[b]=v,p),w=n("m+v4");function A(t){return(A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var y={mixins:[s.i],components:{sidebar:s.m,sidebarTab:s.n,annotationsTab:a.a,labelsTab:m.a,annotationModesTab:f,colorAdjustmentTab:g,imageLabelTab:I,settingsTab:w.a,annotationCanvas:biigle.$require("annotations.components.annotationCanvas")},data:{allImagesIds:[],volumeId:null,isEditor:!1,imageIndex:null,image:null,annotations:[],annotationFilter:null,annotationFilters:[],lastCreatedAnnotation:null,lastCreatedAnnotationTimeout:null,annotationOpacity:1,mapCenter:void 0,mapResolution:void 0,selectedLabel:null,annotationMode:"default",focussedAnnotationIndex:null,annotationModeCarry:null,showMousePosition:!1,showZoomLevel:!1,showLabelTooltip:!1,showMeasureTooltip:!1,showMinimap:!0,showScaleLine:!1,imagesArea:null,openTab:null,userUpdatedVolareResolution:!1},computed:{imageId:function(){return this.imagesIds[this.imageIndex]},hasAnnotationFilter:function(){return null!==this.annotationFilter},filteredAnnotations:function(){var t=this.annotations.filter((function(t){return!t.markedForDeletion}));return this.annotationFilter?this.annotationFilter.filter(t):t},selectedAnnotations:function(){return this.filteredAnnotations.filter((function(t){return t.selected}))},supportsColorAdjustment:function(){return o.a.supportsColorAdjustment},focussedAnnotation:function(){return this.filteredAnnotations[this.focussedAnnotationIndex]},isDefaultAnnotationMode:function(){return"default"===this.annotationMode},isVolareAnnotationMode:function(){return"volare"===this.annotationMode},isLawnmowerAnnotationMode:function(){return"lawnmower"===this.annotationMode},isSamplingAnnotationMode:function(){return this.annotationMode.endsWith("Sampling")},imagesIds:function(){var t=this.allImagesIds.slice(),e=window.localStorage.getItem("biigle.volumes.".concat(this.volumeId,".images"));if(e){var n={};return t.forEach((function(t){n[t]=null})),JSON.parse(e).filter((function(t){return n.hasOwnProperty(t)}))}return t}},methods:{getImageAndAnnotationsPromises:function(t){return[o.a.fetchAndDrawImage(t),i.a.fetchAnnotations(t)]},setCurrentImageAndAnnotations:function(t){t?(this.image=t[0],this.annotations=t[1]):(this.image=null,this.annotations=[])},updateUrlSlug:function(){s.p.setSlug(this.imageId)},getNextIndex:function(t){return(t+1)%this.imagesIds.length},getPreviousIndex:function(t){return(t+this.imagesIds.length-1)%this.imagesIds.length},handleNext:function(){if(!this.loading){if(this.isVolareAnnotationMode){if(this.focussedAnnotationIndex<this.filteredAnnotations.length-1)return void this.focussedAnnotationIndex++;this.focussedAnnotationIndex=-1/0}else if(this.isLawnmowerAnnotationMode){if(this.$refs.canvas.showNextImageSection())return;this.annotationModeCarry=0}else if(this.isSamplingAnnotationMode){if(this.$refs.canvas.showNextSamplingLocation())return;this.annotationModeCarry=0}this.imageIndex=this.getNextIndex(this.imageIndex)}},handlePrevious:function(){if(!this.loading){if(this.isVolareAnnotationMode){if(this.focussedAnnotationIndex>0)return void this.focussedAnnotationIndex--;this.focussedAnnotationIndex=1/0}else if(this.isLawnmowerAnnotationMode){if(this.$refs.canvas.showPreviousImageSection())return;this.annotationModeCarry=1/0}else if(this.isSamplingAnnotationMode){if(this.$refs.canvas.showPreviousSamplingLocation())return;this.annotationModeCarry=1/0}this.imageIndex=this.getPreviousIndex(this.imageIndex)}},maybeUpdateFocussedAnnotation:function(){this.isVolareAnnotationMode?this.filteredAnnotations.length>0?this.focussedAnnotationIndex===1/0?this.focussedAnnotationIndex=this.filteredAnnotations.length-1:this.focussedAnnotationIndex=0:(this.focussedAnnotationIndex=null,this.$refs.canvas.fitImage()):this.focussedAnnotationIndex=null},maybeUpdateShownImageSection:function(){this.isLawnmowerAnnotationMode&&(this.annotationModeCarry===1/0?this.$refs.canvas.showLastImageSection():this.$refs.canvas.showFirstImageSection())},maybeUpdateShownSampling:function(t){this.isSamplingAnnotationMode&&(this.$refs.canvas.setSamplingData(this.annotationMode,t),this.annotationModeCarry===1/0?this.$nextTick(this.$refs.canvas.showLastSamplingLocation):this.$nextTick(this.$refs.canvas.showFirstSamplingLocation))},maybeUpdateAnnotationMode:function(t){this.maybeUpdateFocussedAnnotation(),this.maybeUpdateShownImageSection(),this.maybeUpdateShownSampling(t)},handleMapMoveend:function(t){this.mapCenter=t.center,this.mapResolution=t.resolution,s.p.set({r:Math.round(100*t.resolution),x:Math.round(t.center[0]),y:Math.round(t.center[1])})},handleSelectAnnotation:function(t,e){!0===e||"object"===A(e)&&e.shiftKey?t.selected=!0:this.annotations.forEach((function(e){e.selected=t.id===e.id}))},handleSelectAnnotations:function(t,e){t.forEach((function(t){t.selected=!0})),e.forEach((function(t){t.selected=!1}))},handleDeselectAnnotation:function(t){t?t.selected=!1:this.annotations.forEach((function(t){t.selected=!1}))},focusAnnotation:function(t,e,n){this.$refs.canvas.focusAnnotation(t,e,n)},handleDetachAnnotationLabel:function(t,e){this.isEditor&&(t.labels.length>1?i.a.detachLabel(t,e).catch(s.r):confirm("Detaching the last label of an annotation deletes the whole annotation. Do you want to delete the annotation?")&&this.handleDeleteAnnotation(t))},handleDeleteAnnotation:function(t){this.isEditor&&(this.lastCreatedAnnotation&&this.lastCreatedAnnotation.id===t.id&&(this.lastCreatedAnnotation=null),Vue.set(t,"markedForDeletion",!0),i.a.delete(t).catch((function(e){t.markedForDeletion=!1,Object(s.r)(e)})))},handleDeleteAnnotations:function(t){t.forEach(this.handleDeleteAnnotation)},handleUpdateAnnotations:function(t){this.isEditor&&Vue.Promise.all(t.map(i.a.update)).catch(s.r)},selectAndFocusAnnotation:function(t,e){this.selectedAnnotations.forEach((function(t){t.selected=!1})),t.selected=!0,this.focusAnnotation(t,!0,e)},handleFilter:function(t){this.annotationFilter=t},resetFilter:function(){this.annotationFilter&&this.annotationFilter.reset(),this.annotationFilter=null},handleSelectedLabel:function(t){this.selectedLabel=t},handleNewAnnotation:function(t,e){this.isEditor&&(t.label_id=this.selectedLabel.id,t.confidence=1,i.a.create(this.imageId,t).then(this.setLastCreatedAnnotation).catch(s.r).finally(e))},handleAttachLabel:function(t,e){if(e=e||this.selectedLabel,this.isEditor&&e){var n={label_id:e.id,confidence:1};i.a.attachLabel(t,n).catch(s.r)}},handleAttachAllSelected:function(){this.selectedAnnotations.forEach(this.handleAttachLabel)},emitImageChanged:function(){s.b.$emit("images.change",this.imageId,this.image)},cachePreviousAndNext:function(){var t=this.imagesIds[this.getPreviousIndex(this.imageIndex)],e=this.imagesIds[this.getNextIndex(this.imageIndex)];t!==this.imageId&&Vue.Promise.all([i.a.fetchAnnotations(e),o.a.fetchImage(e),i.a.fetchAnnotations(t),o.a.fetchImage(t)]).catch((function(){}))},setLastCreatedAnnotation:function(t){this.lastCreatedAnnotationTimeout&&window.clearTimeout(this.lastCreatedAnnotationTimeout);var e=this;this.lastCreatedAnnotation=t,this.lastCreatedAnnotationTimeout=window.setTimeout((function(){e.lastCreatedAnnotation=null}),1e4)},updateColorAdjustment:function(t){var e=this.$refs.canvas;Object(s.q)((function(){o.a.updateColorAdjustment(t),e.render()}),100,"annotations.color-adjustment.update")},handleSettingsChange:function(t,e){switch(t){case"annotationOpacity":this.annotationOpacity=e;break;case"mousePosition":this.showMousePosition=e;break;case"zoomLevel":this.showZoomLevel=e;break;case"scaleLine":this.showScaleLine=e;break;case"labelTooltip":this.showLabelTooltip=e;break;case"measureTooltip":this.showMeasureTooltip=e;break;case"minimap":this.showMinimap=e}},handleAnnotationModeChange:function(t,e){this.annotationMode=t,this.annotationModeCarry=null,this.maybeUpdateAnnotationMode(e)},handleOpenedTab:function(t){u.a.set("openTab",t)},handleClosedTab:function(t){u.a.delete("openTab")},handleLoadingError:function(t){s.j.danger(t)},createSampledAnnotation:function(){this.$refs.canvas.createSampledAnnotation()},fetchImagesArea:function(){this.imagesArea||(this.imagesArea={},biigle.$require("annotations.api.volumeImageArea").get({id:this.volumeId}).then(this.setImagesArea,s.r))},setImagesArea:function(t){this.imagesArea=t.body},handleRequiresSelectedLabel:function(){s.j.info("Please select a label first."),this.$refs.sidebar.$emit("open","labels")},maybeShowTilingInProgressMessage:function(){this.image.tilingInProgress&&s.j.warning("This image is currently being processed. Please retry later.")}},watch:{imageId:function(t){t&&(this.startLoading(),Vue.Promise.all(this.getImageAndAnnotationsPromises(t)).catch(this.handleLoadingError).then(this.setCurrentImageAndAnnotations).then(this.updateUrlSlug).then(this.maybeUpdateAnnotationMode).then(this.emitImageChanged).then(this.maybeShowTilingInProgressMessage).then(this.cachePreviousAndNext).finally(this.finishLoading))},focussedAnnotation:function(t){t&&this.selectAndFocusAnnotation(t,this.userUpdatedVolareResolution)},annotationFilter:function(){this.maybeUpdateFocussedAnnotation()},showScaleLine:function(t){t&&this.fetchImagesArea()},showMeasureTooltip:function(t){t&&this.fetchImagesArea()},isVolareAnnotationMode:function(t){t||(this.userUpdatedVolareResolution=!1)},mapResolution:function(t){this.isVolareAnnotationMode&&(this.userUpdatedVolareResolution=!0)},annotations:function(t){this.annotationFilters[0].annotations=t,this.annotationFilters[1].annotations=t}},created:function(){if(this.allImagesIds=biigle.$require("annotations.imagesIds"),this.volumeId=biigle.$require("annotations.volumeId"),this.isEditor=biigle.$require("annotations.isEditor"),this.annotationFilters=[new l,new d,new h({data:{shapes:biigle.$require("annotations.shapes")}}),new c({data:{sessions:biigle.$require("annotations.sessions")}})],0!==this.imagesIds.length){var t=this.imagesIds.indexOf(biigle.$require("annotations.imageId"));if(-1===t&&(t=0,s.j.info("The requested image does not exist in your current volume filtering. Switching to the first image.")),this.imageIndex=t,s.b.$emit("images.sequence",this.imagesIds),void 0!==s.p.get("r")&&(this.mapResolution=parseInt(s.p.get("r"),10)/100),void 0!==s.p.get("x")&&void 0!==s.p.get("y")&&(this.mapCenter=[parseInt(s.p.get("x"),10),parseInt(s.p.get("y"),10)]),s.b.$on("annotations.select",this.handleSelectAnnotation),s.b.$on("annotations.deselect",this.handleDeselectAnnotation),s.b.$on("annotations.detachLabel",this.handleDetachAnnotationLabel),s.b.$on("annotations.delete",this.handleDeleteAnnotation),s.b.$on("annotations.focus",this.focusAnnotation),s.p.get("annotation")){var e=parseInt(s.p.get("annotation")),n=this;s.b.$once("images.change",(function(){for(var t=n.annotations,i=t.length-1;i>=0;i--)if(t[i].id===e)return void n.selectAndFocusAnnotation(t[i])}))}u.a.has("openTab")&&(this.openTab=u.a.get("openTab"))}else s.j.info("Your current volume filtering contains no images.")},mounted:function(){s.b.$emit("annotations.map.init",this.$refs.canvas.map)}},L={mixins:[n("LSvT").a],data:{imageIds:[],imageIdsLeft:[],initialImageId:null,showIndicator:!0},computed:{progressPath:function(){return"M 2 1 A 1 1 0 "+(this.progress>=.5?1:0)+" 1 "+this.arcPosition(this.progress).join(" ")+"L 1 1"},initialProgressPath:function(){return"M 1 1 L "+this.arcPosition(this.initialProgress).join(" ")},progressTitle:function(){var t=["started at ".concat(this.initialImageNumber)];return this.hasSeenAllImages&&t.push("seen all"),"Image ".concat(this.currentImageNumber," of ").concat(this.imageIds.length," (").concat(t.join(", "),")")},currentImageNumber:function(){return this.currentImageId?this.imageIds.indexOf(this.currentImageId)+1:0},progress:function(){return this.currentImageNumber/this.imageIds.length},initialImageNumber:function(){return null===this.initialImageId?1:this.imageIds.indexOf(this.initialImageId)+1},initialProgress:function(){return this.initialImageNumber/this.imageIds.length},hasSeenAllImages:function(){return 0===this.imageIdsLeft.length},showInitialProgressMarker:function(){return 1!==this.initialImageNumber},indicatorClass:function(){return this.hasSeenAllImages?"progress-indicator--all":""},filenameClass:function(){return this.hasSeenAllImages?"text-success":""},filenameTitle:function(){return this.hasSeenAllImages?"You have seen all images":""}},methods:{arcPosition:function(t){return[Math.cos(2*Math.PI*t)+1,Math.sin(2*Math.PI*t)+1]},setInitialImageId:function(t){this.initialImageId=t},updateShowIndicator:function(t){this.showIndicator=!1!==t}},watch:{currentImageId:function(t){for(var e=this.imageIdsLeft,n=e.length-1;n>=0;n--)if(e[n]===t){e.splice(n,1);break}},currentImageFilename:function(t){document.title="Annotate ".concat(t)}},created:function(){var t=this;this.imageIds=biigle.$require("annotations.imagesIds").slice(),this.imageIdsLeft=biigle.$require("annotations.imagesIds").slice(),s.b.$on("images.sequence",(function(e){t.imageIds=e.slice(),t.imageIdsLeft=e.slice()})),s.b.$once("images.change",this.setInitialImageId),this.updateShowIndicator(u.a.get("progressIndicator")),u.a.watch("progressIndicator",this.updateShowIndicator)},mounted:function(){this.defaultFilename=this.$el.attributes.getNamedItem("default-filename").value}};biigle.$mount("annotator-container",y),biigle.$mount("annotations-navbar",L)},"7p/M":function(t,e,n){n("2e9+"),n("BzNh")},BzNh:function(t,e,n){"use strict";n.r(e);var i=n("E6vj"),a=n("i25t"),o=n("t9jp"),s=n("Nwv/"),r=n("m+v4");biigle.$declare("annotations.components.annotationsTabPlugins",o.b),biigle.$declare("annotations.components.labelsTabPlugins",s.b),biigle.$declare("annotations.components.settingsTabPlugins",r.b),biigle.$declare("annotations.stores.annotations",i.a),biigle.$declare("annotations.stores.images",a.a)},E6vj:function(t,e,n){"use strict";var i=n("kLmy");e.a=new Vue({data:{cache:{}},computed:{imageFileUri:function(){return biigle.$require("annotations.imageFileUri")},shapeMap:function(){return biigle.$require("annotations.shapes")},inverseShapeMap:function(){var t={};for(var e in this.shapeMap)t[this.shapeMap[e]]=parseInt(e,10);return t}},methods:{parseResponse:function(t){return t.data},resolveShape:function(t){return t.shape=this.shapeMap[t.shape_id],t},resolveAllShapes:function(t){return t.forEach(this.resolveShape,this),t},setDeselected:function(t){return t.selected=!1,t},setAllDeselected:function(t){return t.forEach(this.setDeselected),t},fetchAnnotations:function(t){return this.cache.hasOwnProperty(t)||(this.cache[t]=i.e.getAnnotations({id:t}).catch((function(){return Vue.Promise.reject("Failed to load annotations for image ".concat(t,"!"))})).then(this.parseResponse).then(this.resolveAllShapes)),this.cache[t].then(this.setAllDeselected)},create:function(t,e){var n=this;return e.shape_id=this.inverseShapeMap[e.shape],delete e.shape,i.e.saveAnnotations({id:t},e).then(this.parseResponse).then(this.resolveShape).then(this.setDeselected).then((function(e){return n.cache[t].then((function(t){t.unshift(e)})),e}))},update:function(t){var e=this,n=i.a.update({id:t.id},{points:t.points});return n.then((function(){e.cache[t.image_id].then((function(e){for(var n=e.length-1;n>=0;n--)if(e[n].id===t.id)return void(e[n].points=t.points)}))})),n},attachLabel:function(t,e){var n=i.a.attachLabel({id:t.id},e);return n.then((function(e){t.labels.unshift(e.data)})),n},detachLabel:function(t,e){var n=i.a.detachLabel({annotation_label_id:e.id});return n.then((function(){for(var n=t.labels.length-1;n>=0;n--)if(t.labels[n].id===e.id)return void t.labels.splice(n,1)})),n},delete:function(t){var e=i.a.delete({id:t.id}),n=this.cache[t.image_id];return e.then((function(){n.then((function(e){for(var n=e.length-1;n>=0;n--)if(e[n].id===t.id)return void e.splice(n,1)}))})),e}}})},LSvT:function(t,e,n){"use strict";var i=n("kLmy");e.a={data:function(){return{filenameMap:{},currentImageId:null,defaultFilename:""}},computed:{currentImageFilename:function(){return this.filenameMap[this.currentImageId]||this.defaultFilename}},methods:{updateImageId:function(t){this.currentImageId=t}},created:function(){var t=biigle.$require("annotations.imagesIds"),e=biigle.$require("annotations.imagesFilenames"),n=this.filenameMap;t.forEach((function(t,i){n[t]=e[i]})),i.b.$on("images.change",this.updateImageId)}}},"Nwv/":function(t,e,n){"use strict";n.d(e,"b",(function(){return a}));var i=n("kLmy"),a={};e.a={components:{labelTrees:i.g},data:function(){return{labelTrees:[],selectedLabel:null}},computed:{plugins:function(){return a}},methods:{handleSelectedLabel:function(t){this.selectedLabel=t,this.$emit("select",t)},handleDeselectedLabel:function(t){this.selectedLabel=null,this.$emit("select",null)}},created:function(){this.labelTrees=biigle.$require("annotations.labelTrees")}}},i25t:function(t,e,n){"use strict";var i,a=n("kLmy"),o=document.createElement("canvas");if(o.style.imageOrientation="none",o.style.visibility="hidden",o.style.position="fixed",document.body.appendChild(o),window.hasOwnProperty("fx"))try{i=fx.canvas();var s=null,r=null}catch(t){console.log("WebGL not supported. Color adjustment disabled.")}window.addEventListener("beforeunload",(function(t){s&&(s.destroy(),i.width=1,i.height=1)})),e.a=new Vue({data:{cache:{},cachedIds:[],maxCacheSize:10,supportsColorAdjustment:!1,currentlyDrawnImage:null,colorAdjustment:{brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]}},computed:{imageFileUri:function(){return biigle.$require("annotations.imageFileUri")},tilesUri:function(){return biigle.$require("annotations.tilesUri")},supportedTextureSize:function(){return i?i._.gl.getParameter(i._.gl.MAX_TEXTURE_SIZE):0},hasColorAdjustment:function(){for(var t in this.colorAdjustment)if(this.colorAdjustment.hasOwnProperty(t)&&this.isAdjustmentActive(t))return!0;return!1}},methods:{isTiledImage:function(t){return!0===t.tiled},isAdjustmentActive:function(t){return 0!==this.colorAdjustment[t].reduce((function(t,e){return t+e}))},checkSupportsColorAdjustment:function(t){if(!i||t.crossOrigin)return!1;if(this.isTiledImage(t))this.supportsColorAdjustment=!1;else{if(this.currentlyDrawnImage&&this.currentlyDrawnImage.width===t.width&&this.currentlyDrawnImage.height===t.height)return this.supportsColorAdjustment;var e=this.supportedTextureSize;if(e<t.width||e<t.height)return console.log("Insufficient WebGL texture size. Required: ".concat(t.width,"x").concat(t.height,", available: ").concat(e,"x").concat(e,". Color adjustment disabled.")),void(this.supportsColorAdjustment=!1);var n=fx.canvas();if(n.width=t.width,n.height=t.height,t.width!==n._.gl.drawingBufferWidth||t.height!==n._.gl.drawingBufferHeight)return console.log("Your browser does not allow a WebGL drawing buffer with the size of the original image. Color adjustment disabled."),void(this.supportsColorAdjustment=!1);this.supportsColorAdjustment=!0}},createImage:function(t){var e=this,n=document.createElement("img"),i={id:t,source:n,width:0,height:0,canvas:document.createElement("canvas"),crossOrigin:!1};n.style.imageOrientation="none",n.style.visibility="hidden",n.style.position="fixed",document.body.appendChild(n);var a=new Vue.Promise((function(e,a){n.onload=function(){i.width=n.width,i.height=n.height,e(i)},n.onerror=function(){a("Failed to load image ".concat(t,"!"))}}));return a.finally((function(){document.body.removeChild(n)})),Vue.http.get(this.imageFileUri.replace(":id",t),{responseType:"blob"}).then((function(t){if("application/json"===t.headers.get("content-type")){var i=t.body.uuid;return t.body.url=e.tilesUri.replace(":uuid",i[0]+i[1]+"/"+i[2]+i[3]+"/"+i),t.body}return t.blob().then((function(t){var e=window.URL||window.webkitURL;n.src=e.createObjectURL(t)})),a})).catch((function(e){return 0===e.status?(i.crossOrigin=!0,n.src=e.url,a):Vue.Promise.reject("Failed to load image ".concat(t,"!"))}))},drawSimpleImage:function(t){return document.body.appendChild(t.source),o.width=t.width,o.height=t.height,o.getContext("2d").drawImage(t.source,0,0),document.body.removeChild(t.source),t.canvas.width=t.width,t.canvas.height=t.height,t.canvas.getContext("2d").drawImage(o,0,0),t},drawColorAdjustedImage:function(t){for(var e in r!==t.source.src&&(document.body.appendChild(t.source),o.width=t.width,o.height=t.height,o.getContext("2d").drawImage(t.source,0,0),document.body.removeChild(t.source),s?s.loadContentsOf(o):s=i.texture(o),r=t.source.src),i.draw(s),this.colorAdjustment)this.colorAdjustment.hasOwnProperty(e)&&this.isAdjustmentActive(e)&&i[e].apply(i,this.colorAdjustment[e]);return i.update(),t.canvas.width=t.width,t.canvas.height=t.height,t.canvas.getContext("2d").drawImage(i,0,0),t},drawImage:function(t){return this.checkSupportsColorAdjustment(t),this.currentlyDrawnImage=t,this.supportsColorAdjustment&&this.hasColorAdjustment?this.drawColorAdjustedImage(t):this.isTiledImage(t)?t:this.drawSimpleImage(t)},fetchImage:function(t){return this.cache.hasOwnProperty(t)||(a.b.$emit("images.fetching",t),this.cache[t]=this.createImage(t),this.cachedIds.push(t)),this.cache[t]},fetchAndDrawImage:function(t){return this.fetchImage(t).then(this.drawImage)},updateColorAdjustment:function(t){if(this.supportsColorAdjustment){var e,n,i=this.colorAdjustment,a=this.hasColorAdjustment;for(e in t)if(t.hasOwnProperty(e))for(n=t[e].length-1;n>=0;n--)i[e].splice(n,1,t[e][n]);this.hasColorAdjustment?this.drawColorAdjustedImage(this.currentlyDrawnImage):a&&this.drawSimpleImage(this.currentlyDrawnImage)}}},watch:{cachedIds:function(t){if(t.length>this.maxCacheSize){var e=t.shift();this.cache[e];delete this.cache[e]}}}})},kLmy:function(t,e,n){"use strict";n.d(e,"a",(function(){return i})),n.d(e,"q",(function(){return a})),n.d(e,"b",(function(){return o})),n.d(e,"r",(function(){return s})),n.d(e,"c",(function(){return r})),n.d(e,"d",(function(){return l})),n.d(e,"e",(function(){return c})),n.d(e,"f",(function(){return u})),n.d(e,"g",(function(){return h})),n.d(e,"h",(function(){return d})),n.d(e,"i",(function(){return m})),n.d(e,"j",(function(){return f})),n.d(e,"k",(function(){return g})),n.d(e,"l",(function(){return p})),n.d(e,"m",(function(){return b})),n.d(e,"n",(function(){return v})),n.d(e,"o",(function(){return I})),n.d(e,"p",(function(){return w}));var i=biigle.$require("api.annotations"),a=biigle.$require("utils.debounce"),o=biigle.$require("events"),s=biigle.$require("messages").handleErrorResponse,r=biigle.$require("volumes.components.imageLabelList"),l=biigle.$require("api.imageLabels"),c=biigle.$require("api.images"),u=biigle.$require("keyboard"),h=biigle.$require("labelTrees.components.labelTrees"),d=biigle.$require("labelTrees.components.labelTypeahead"),m=biigle.$require("core.mixins.loader"),f=biigle.$require("messages"),g=biigle.$require("core.components.powerToggle"),p=biigle.$require("core.models.Settings"),b=biigle.$require("core.components.sidebar"),v=biigle.$require("core.components.sidebarTab"),I=biigle.$require("core.components.typeahead"),w=biigle.$require("utils.urlParams")},"m+v4":function(t,e,n){"use strict";n.d(e,"b",(function(){return r}));var i=n("LSvT"),a=n("kLmy"),o={mixins:[i.a],computed:{filename:function(){if(this.currentImageFilename){var t=this.currentImageFilename.split(".");return t.length>1&&(t[t.length-1]="png"),"biigle_screenshot_"+(t=t.join(".").toLowerCase())}return"biigle_screenshot.png"}},methods:{trimCanvas:function(t){var e,n,i,a=t.getContext("2d"),o=document.createElement("canvas").getContext("2d"),s=a.getImageData(0,0,t.width,t.height),r=s.data.length,l={top:null,left:null,right:null,bottom:null};for(e=0;e<r;e+=4)0!==s.data[e+3]&&(n=e/4%t.width,i=~~(e/4/t.width),null===l.top&&(l.top=i),(null===l.left||n<l.left)&&(l.left=n),(null===l.right||l.right<n)&&(l.right=n),(null===l.bottom||l.bottom<i)&&(l.bottom=i));var c=l.bottom-l.top,u=l.right-l.left,h=a.getImageData(l.left,l.top,u,c);return o.canvas.width=u,o.canvas.height=c,o.putImageData(h,0,0),o.canvas},makeBlob:function(t){try{t=this.trimCanvas(t)}catch(t){return Vue.Promise.reject("Could not create screenshot. Maybe the image is not loaded yet?")}var e="image/png";if(HTMLCanvasElement.prototype.toBlob)return new Vue.Promise((function(n){t.toBlob(n,e)}));for(var n=atob(t.toDataURL(e).split(",")[1]),i=n.length,a=new Uint8Array(i),o=0;o<i;o++)a[o]=n.charCodeAt(o);return new Vue.Promise((function(t){t(new Blob([a],{type:e}))}))},download:function(t){var e=document.createElement("a");e.style="display: none",e.download=this.filename,e.href=URL.createObjectURL(t),document.body.appendChild(e),e.click(),window.setTimeout((function(){document.body.removeChild(e),URL.revokeObjectURL(e.href)}),100)},capture:function(){var t=this;this.map&&(this.map.once("postcompose",(function(e){t.makeBlob(e.context.canvas).then(t.download).catch(t.handleError)})),this.map.renderSync())},handleError:function(t){a.j.danger(t)},setMap:function(t){this.map=t}},created:function(){a.b.$on("annotations.map.init",this.setMap)}},s=n("u6rQ"),r={};e.a={components:{screenshotButton:o,powerToggle:a.k},props:{image:{type:Object,default:null}},data:function(){return{restoreKeys:["annotationOpacity","mousePosition","zoomLevel","scaleLine","labelTooltip","measureTooltip","minimap","progressIndicator"],annotationOpacity:1,mousePosition:!1,zoomLevel:!1,scaleLine:!1,labelTooltip:!1,measureTooltip:!1,minimap:!0,progressIndicator:!0}},computed:{plugins:function(){return r},crossOrigin:function(){return this.image&&this.image.crossOrigin}},methods:{showMousePosition:function(){this.mousePosition=!0},hideMousePosition:function(){this.mousePosition=!1},showZoomLevel:function(){this.zoomLevel=!0},hideZoomLevel:function(){this.zoomLevel=!1},showScaleLine:function(){this.scaleLine=!0},hideScaleLine:function(){this.scaleLine=!1},showLabelTooltip:function(){this.labelTooltip=!0,this.measureTooltip=!1},hideLabelTooltip:function(){this.labelTooltip=!1},showMeasureTooltip:function(){this.measureTooltip=!0,this.labelTooltip=!1},hideMeasureTooltip:function(){this.measureTooltip=!1},showMinimap:function(){this.minimap=!0},hideMinimap:function(){this.minimap=!1},showProgressIndicator:function(){this.progressIndicator=!0},hideProgressIndicator:function(){this.progressIndicator=!1},toggleAnnotationOpacity:function(){this.annotationOpacity>0?this.annotationOpacity=0:this.annotationOpacity=1}},watch:{annotationOpacity:function(t){t=parseFloat(t),this.$emit("change","annotationOpacity",t),s.a.set("annotationOpacity",t)},mousePosition:function(t){this.$emit("change","mousePosition",t),s.a.set("mousePosition",t)},zoomLevel:function(t){this.$emit("change","zoomLevel",t),s.a.set("zoomLevel",t)},scaleLine:function(t){this.$emit("change","scaleLine",t),s.a.set("scaleLine",t)},labelTooltip:function(t){this.$emit("change","labelTooltip",t),s.a.set("labelTooltip",t)},measureTooltip:function(t){this.$emit("change","measureTooltip",t),s.a.set("measureTooltip",t)},minimap:function(t){this.$emit("change","minimap",t),s.a.set("minimap",t)},progressIndicator:function(t){this.$emit("change","progressIndicator",t),s.a.set("progressIndicator",t)}},created:function(){var t=this;this.restoreKeys.forEach((function(e){t[e]=s.a.get(e)})),a.f.on("o",this.toggleAnnotationOpacity)}}},t9jp:function(t,e,n){"use strict";n.d(e,"b",(function(){return a}));var i={components:{filters:{template:'<form\n        class="annotations-tab__filter form-inline"\n        @submit.prevent\n        >\n            <select\n                class="form-control"\n                v-model="chosenFilterIndex"\n                >\n                    <option\n                        v-for="(filter, index) in annotationFilters"\n                        :value="index"\n                        v-text="filter.name"\n                        ></option>\n            </select>\n\n            <span\n                v-show="chosenFilter"\n                ref="filterElement"\n                ></span>\n            <input\n                v-show="!chosenFilter"\n                class="form-control"\n                placeholder="Filter annotations"\n                type="text"\n                disabled="true"\n                ></input>\n\n            <button\n                class="btn btn-default"\n                title="Clear annotation filter"\n                :class="clearButtonClass"\n                :disabled="!hasActiveFilter"\n                @click.prevent="emitUnselectFilter"\n                >\n                    <i class="fa fa-times"></i>\n            </button>\n    </form>',props:{annotationFilters:{type:Array,default:function(){return[]}},hasActiveFilter:{type:Boolean,default:!1}},data:function(){return{chosenFilterIndex:null}},computed:{hasFilters:function(){return this.annotationFilters.length>0},chosenFilter:function(){return this.annotationFilters[this.chosenFilterIndex]},clearButtonClass:function(){return{"btn-info":this.hasActiveFilter}}},methods:{emitSelectFilter:function(t){this.$emit("select",t)},emitUnselectFilter:function(){this.$emit("unselect")}},watch:{chosenFilter:function(t,e){e&&(this.$refs.filterElement.removeChild(e.$el),e.$off("select",this.emitSelectFilter)),this.$refs.filterElement.appendChild(t.$el),t.$on("select",this.emitSelectFilter)}}},labelItem:{template:'<li\n        class="annotations-tab-item"\n        :class="classObject"\n        :title="title"\n        >\n            <div\n                class="annotations-tab-item__title"\n                @click="toggleOpen"\n                >\n                    <span\n                        class="pull-right badge"\n                        v-text="count"\n                        :title="countTitle"\n                        ></span>\n                    <span\n                        class="annotations-tab-item__color"\n                        :style="colorStyle"\n                        ></span>\n                    <span v-text="label.name"></span>\n            </div>\n            <ul class="annotations-tab-item__list list-unstyled" v-show="isSelected">\n                <annotation-item\n                    v-for="item in annotationItems"\n                    :annotation="item.annotation"\n                    :annotation-label="item.annotationLabel"\n                    :can-detach="item.canDetach"\n                    @select="emitSelect"\n                    @detach="emitDetach"\n                    @focus="emitFocus"\n                    ></annotation-item>\n            </ul>\n    </li>',components:{annotationItem:{template:'<li\n        class="annotations-tab-item__sub-item"\n        :class="classObject"\n        :data-annotation-id="annotation.id"\n        @click="emitSelect"\n        @dblclick="emitFocus"\n        >\n            <button\n                v-if="canDetach"\n                type="button"\n                title="Detach this label from the annotation"\n                class="close"\n                @click.stop="emitDetach"\n                >\n                    <span aria-hidden="true">&times;</span>\n            </button>\n            <span\n                class="icon"\n                :class="shapeClass"\n                ></span>\n            <span v-text="username"></span>\n        </li>\n    </li>',props:{annotation:{type:Object,required:!0},annotationLabel:{type:Object,required:!0},canDetach:{type:Boolean,default:!1}},computed:{classObject:function(){return{selected:!1!==this.annotation.selected}},shapeClass:function(){return"icon-"+this.annotation.shape.toLowerCase()},username:function(){return this.annotationLabel.user?this.annotationLabel.user.firstname+" "+this.annotationLabel.user.lastname:"(user deleted)"}},methods:{emitSelect:function(t){this.$emit("select",this.annotation,t.shiftKey)},emitDetach:function(){this.$emit("detach",this.annotation,this.annotationLabel)},emitFocus:function(){this.$emit("focus",this.annotation)}}}},props:{label:{type:Object,default:function(){return{}}},annotations:{type:Array,default:function(){return[]}},canDetachOthers:{type:Boolean,default:!1},ownUserId:{type:Number,default:null}},data:function(){return{open:!1}},computed:{title:function(){return"Annotations with label ".concat(this.label.name)},classObject:function(){return{selected:this.isSelected}},count:function(){return this.annotationItems.length},countTitle:function(){return"There are ".concat(this.count," annotations with label ").concat(this.label.name)},colorStyle:function(){return"background-color: #"+this.label.color},isSelected:function(){return this.open||this.annotations.reduce((function(t,e){return t||!1!==e.selected}),!1)},annotationItems:function(){var t=this,e=[];return this.annotations.forEach((function(n){n.labels.forEach((function(i){i.label_id===t.label.id&&e.push({annotation:n,annotationLabel:i,canDetach:t.canDetachAnnotationLabel(i)})}))})),e}},methods:{toggleOpen:function(){this.open=!this.open},emitSelect:function(t,e){this.$emit("select",t,e)},emitDetach:function(t,e){this.$emit("detach",t,e)},emitFocus:function(t){this.$emit("focus",t)},canDetachAnnotationLabel:function(t){return this.canDetachOthers||this.ownUserId===t.user_id}}}},props:{hasActiveFilter:{type:Boolean,default:!1},annotations:{type:Array,default:function(){return[]}},annotationFilters:{type:Array,default:function(){return[]}},canDetachOthers:{type:Boolean,default:!1},ownUserId:{type:Number,default:null},selectedAnnotations:{type:Array,default:function(){return[]}}},data:function(){return{}},computed:{labelItems:function(){var t={},e={},n={};return this.annotations.forEach((function(i){i.labels.forEach((function(a){t.hasOwnProperty(a.label.id)||(t[a.label_id]=a.label,e[a.label_id]=[]);var o=i.id+"-"+a.label_id;n.hasOwnProperty(o)||(n[o]=null,e[a.label_id].push(i))}))})),Object.values(t).sort((function(t,e){return t.name.toLowerCase()>e.name.toLowerCase()?1:-1})).map((function(t){return{id:t.id,label:t,annotations:e[t.id]}}))}},methods:{handleSelect:function(t,e){!1!==t.selected&&e?this.$emit("deselect",t):this.$emit("select",t,e)},emitDetach:function(t,e){this.$emit("detach",t,e)},emitSelectFilter:function(t){this.$emit("select-filter",t)},emitUnselectFilter:function(){this.$emit("unselect-filter")},emitFocus:function(t){this.$emit("focus",t)},scrollIntoView:function(t){var e,n=this.$refs.scrollList,i=n.scrollTop,a=n.offsetHeight,o=1/0,s=0;t.forEach((function(t){for(var i=n.querySelectorAll('[data-annotation-id="'.concat(t.id,'"]')),a=i.length-1;a>=0;a--)e=i[a],o=Math.min(e.offsetTop,o),s=Math.max(e.offsetTop+e.offsetHeight,s)}),this),i>o?n.scrollTop=o:i+a<s&&(n.scrollTop=a>=s-o?s-n.offsetHeight:o)}},watch:{selectedAnnotations:function(t){t.length>0&&this.$nextTick((function(){this.scrollIntoView(t)}))}}},a={};e.a={mixins:[i],computed:{plugins:function(){return a}}}},u6rQ:function(t,e,n){"use strict";var i=n("kLmy"),a={annotationOpacity:1,mousePosition:!1,zoomLevel:!1,scaleLine:!1,labelTooltip:!1,measureTooltip:!1,minimap:!0,progressIndicator:!0,randomSamplingNumber:9,regularSamplingRows:3,regularSamplingColumns:3};e.a=new i.l({data:{urlParams:Object.keys(a),storageKey:"biigle.annotations.settings",defaults:a}})},zcrr:function(t,e){}});