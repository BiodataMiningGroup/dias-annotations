angular.module("biigle.annotations",["biigle.api","biigle.ui"]),angular.module("biigle.annotations").config(["$compileProvider",function(t){"use strict";t.debugInfoEnabled(!1)}]),angular.module("biigle.annotations").directive("annotationListItem",["annotations","mapAnnotations","USER_ID",function(t,e,n){"use strict";return{controller:["$scope","$element",function(o,i){var a=!1,r=o.a.annotation,l=o.a.label,s=function(){return e.isAnnotationSelected(o.a.annotation)};o.getUsername=function(){return l.user?l.user.firstname+" "+l.user.lastname:"(user deleted)"},o.getClass=function(){return{selected:a}},o.getShapeClass=function(){return"icon-"+o.a.shape.toLowerCase()},o.select=function(t){e.toggleSelect(o.a.annotation,t.shiftKey),o.keepElementPosition(i)},o.zoomTo=function(){e.fit(o.a.annotation)},o.canBeRemoved=function(){return l.user&&l.user.id===n},o.remove=function(n){n.stopPropagation(),r.labels.length>1?t.removeAnnotationLabel(r,l):1===r.labels.length&&confirm("Detaching the last label will delete the annotation. Proceed?")&&e.deleteAnnotation(r)},o.$watch(s,function(t){a=t,a?o.shouldBeVisible(i):o.shouldNotBeVisible(i)}),i.on("$destroy",function(){o.shouldNotBeVisible(i)})}]}}]),angular.module("biigle.annotations").directive("labelCategoryItem",["$compile","$timeout","$templateCache",function(t,e,n){"use strict";return{restrict:"C",templateUrl:"label-item.html",scope:!0,link:function(o,i,a){var r=angular.element(n.get("label-subtree.html"));e(function(){i.append(t(r)(o))})},controller:["$scope","labels",function(t,e){var n=!1,o=!1,i=!1,a=function(){e.isOpen(t.item)?(n=!0,i=!1):e.isSelected(t.item)?(n=!0,i=!0):(n=!1,i=!1)},r=function(){o=t.tree&&!!t.tree[t.item.id]};t.getSubtree=function(){return n&&t.tree?t.tree[t.item.id]:[]},t.getClass=function(){return{open:n,expandable:o,selected:i}},t.$on("categories.selected",a),a(),r()}]}}]),angular.module("biigle.annotations").directive("labelItem",function(){"use strict";return{controller:["$scope",function(t){var e=t.annotationLabel.confidence;e<=.25?t.class="label-danger":e<=.5?t.class="label-warning":e<=.75?t.class="label-success":t.class="label-primary"}]}}),angular.module("biigle.annotations").directive("labelsListItem",["mapAnnotations",function(t){"use strict";return{restrict:"A",controller:["$scope",function(e){var n=!1,o=function(){for(var n=e.item.annotations,o=n.length-1;o>=0;o--)if(t.isAnnotationSelected(n[o].annotation))return!0;return!1},i=function(){return n||o()};e.getClass=function(){return{selected:i()}},e.isSelected=i,e.toggleOpen=function(){n=!n}}]}}]),angular.module("biigle.annotations").factory("AnnotationFilters",["ANNOTATION_SESSIONS",function(t){"use strict";return{label:function(t){return function(e){var n={};e.groupedByLabel.hasOwnProperty(t)&&(n[t]=e.groupedByLabel[t]);var o=e.flat.filter(function(e){return e.labels=e.labels.filter(function(e){return e.label.id===t}),e.labels.length>0});return{groupedByLabel:n,flat:o}}},user:function(t){return function(e){var n,o=e.groupedByLabel;for(var i in o)if(o.hasOwnProperty(i)){n=o[i].annotations;for(var a=n.length-1;a>=0;a--)n[a].label.user.id!==t&&n.splice(a,1);0===n.length&&delete o[i]}var r=e.flat.filter(function(e){return e.labels=e.labels.filter(function(e){return e.user.id===t}),e.labels.length>0});return{groupedByLabel:o,flat:r}}},shape:function(t){return function(e){var n,o=e.groupedByLabel;for(var i in o)if(o.hasOwnProperty(i)){n=o[i].annotations;for(var a=n.length-1;a>=0;a--)n[a].annotation.shape_id!==t&&n.splice(a,1);0===n.length&&delete o[i]}var r=e.flat.filter(function(e){return e.shape_id===t});return{groupedByLabel:o,flat:r}}},session:function(e){for(var n,o=t.length-1;o>=0;o--)if(t[o].id===e){n=t[o];break}n.starts_at=new Date(n.starts_at),n.ends_at=new Date(n.ends_at);var i=n.users.map(function(t){return t.id});return function(t){var e,o,a,r=t.groupedByLabel;for(var l in r)if(r.hasOwnProperty(l)){e=r[l].annotations;for(var s=e.length-1;s>=0;s--)o=new Date(e[s].annotation.created_at),a=e[s].label.user.id,(o<n.starts_at||o>=n.ends_at||i.indexOf(a)===-1)&&e.splice(s,1);0===e.length&&delete r[l]}var c=t.flat.filter(function(t){for(var e=new Date(t.created_at),o=!1,a=t.labels.length-1;a>=0;a--)if(i.indexOf(t.labels[a].user.id)!==-1){o=!0;break}return e>=n.starts_at&&e<n.ends_at&&o});return{groupedByLabel:r,flat:c}}}}}]),angular.module("biigle.annotations").factory("AttachLabelInteraction",["annotations","labels","msg",function(t,e,n){"use strict";function o(t){ol.interaction.Pointer.call(this,{handleUpEvent:o.handleUpEvent,handleDownEvent:o.handleDownEvent,handleMoveEvent:o.handleMoveEvent}),this.features=void 0!==t.features?t.features:null,this.currentFeature=void 0}return ol.inherits(o,ol.interaction.Pointer),o.handleDownEvent=function(t){return this.currentFeature=this.featuresAtPixel(t.pixel,t.map),!!this.currentFeature},o.handleUpEvent=function(n){this.currentFeature&&this.currentFeature.annotation&&e.hasSelected()&&t.attachAnnotationLabel(this.currentFeature.annotation),this.currentFeature=void 0},o.handleMoveEvent=function(t){var e=t.map.getTargetElement(),n=this.featuresAtPixel(t.pixel,t.map);n?e.style.cursor="pointer":e.style.cursor=""},o.prototype.featuresAtPixel=function(t,e){var n=null,o=e.forEachFeatureAtPixel(t,function(t){return t},this);return this.handlesFeature(o)&&(n=o),n},o.prototype.handlesFeature=function(t){return!!this.features&&this.features.getArray().indexOf(t)!==-1},o}]),angular.module("biigle.annotations").factory("ExtendedTranslateInteraction",["keyboard","map",function(t,e){"use strict";function n(t){ol.interaction.Translate.call(this,t),this.features=void 0!==t.features?t.features:null,this.on("change:active",this.toggleListeners);var e=this;this.translateUp=function(){return e.translate(0,1)},this.translateDown=function(){return e.translate(0,-1)},this.translateLeft=function(){return e.translate(-1,0)},this.translateRight=function(){return e.translate(1,0)}}return ol.inherits(n,ol.interaction.Translate),n.prototype.toggleListeners=function(n){n.oldValue?(t.off(37,this.translateLeft),t.off(38,this.translateUp),t.off(39,this.translateRight),t.off(40,this.translateDown),e.getTargetElement().style.cursor=""):(t.on(37,this.translateLeft,10),t.on(38,this.translateUp,10),t.on(39,this.translateRight,10),t.on(40,this.translateDown,10))},n.prototype.translate=function(t,e){return!(this.features&&this.features.getLength()>0)||(this.features.forEach(function(n){var o=n.getGeometry();o.translate(t,e),n.setGeometry(o)}),!1)},n}]),angular.module("biigle.annotations").factory("ZoomToNativeControl",function(){"use strict";function t(t){var e=t||{},n=e.label?e.label:"1",o=document.createElement("button"),i=this;o.innerHTML=n,o.title="Zoom to original resolution",o.addEventListener("click",function(){i.zoomToNative.call(i)});var a=document.createElement("div");a.className="zoom-to-native ol-unselectable ol-control",a.appendChild(o),ol.control.Control.call(this,{element:a,target:e.target}),this.duration_=void 0!==e.duration?e.duration:250}return ol.inherits(t,ol.control.Control),t.prototype.zoomToNative=function(){var t=this.getMap(),e=t.getView();if(e){var n=e.getResolution();n&&(this.duration_>0&&t.beforeRender(ol.animation.zoom({resolution:n,duration:this.duration_,easing:ol.easing.easeOut})),e.setResolution(e.constrainResolution(1)))}},t}),angular.module("biigle.annotations").factory("map",["ZoomToNativeControl",function(t){"use strict";var e=new ol.Map({target:"canvas",renderer:"canvas",controls:[new ol.control.Zoom,new ol.control.ZoomToExtent({tipLabel:"Zoom to show whole image",label:""}),new ol.control.FullScreen({label:""}),new t({label:""})],interactions:ol.interaction.defaults({altShiftDragRotate:!1,doubleClickZoom:!1,keyboard:!1,shiftDragZoom:!1,pinchRotate:!1,pinchZoom:!1})});return e}]),angular.module("biigle.annotations").controller("AnnotationFilterController",["$scope","annotations","AnnotationFilters","ANNOTATION_SESSIONS",function(t,e,n,o){"use strict";var i=function(){t.selected.input=null,e.hasActiveFilters()&&(e.clearActiveFilters(),e.refreshFiltering())};t.available={filters:[{name:"label",typeahead:e.getAvailableLabels,create:n.label},{name:"user",typeahead:function(){var t=e.getAvailableUsers();return t.map(function(t){return t=angular.copy(t),t.name=t.firstname+" "+t.lastname,t})},create:n.user},{name:"shape",typeahead:e.getAvailableShapes,create:n.shape},{name:"session",typeahead:function(){return o},create:n.session}]},t.selected={filter:t.available.filters[0],input:null},t.getTypeaheadItems=function(){return t.selected.filter.typeahead()},t.selectFilter=function(n){e.setFilter(t.selected.filter.create(n.id)),e.refreshFiltering()},t.$on("$destroy",i)}]),angular.module("biigle.annotations").controller("AnnotationsController",["$scope","$element","annotations","mapAnnotations","$timeout",function(t,e,n,o,i){"use strict";var a=e[0],r=[],l=function(){if(0!==r.length){for(var t,e=a.scrollTop,n=a.offsetHeight,o=1/0,i=0,l=r.length-1;l>=0;l--)t=r[l],o=Math.min(t.offsetTop,o),i=Math.max(t.offsetTop+t.offsetHeight,i);e>o?a.scrollTop=o:e+n<i&&(n>=i-o?a.scrollTop=i-a.offsetHeight:a.scrollTop=o)}};t.shouldBeVisible=function(t){r.indexOf(t[0])===-1&&r.push(t[0])},t.shouldNotBeVisible=function(t){var e=r.indexOf(t[0]);e!==-1&&r.splice(e,1)},t.keepElementPosition=function(t){var e=t[0].offsetTop-a.scrollTop;i(function(){var n=t[0].offsetTop-a.scrollTop;a.scrollTop+=n-e})},t.getAnnotations=n.getGroupedByLabel,o.onSelectedAnnotation(l)}]),angular.module("biigle.annotations").controller("AnnotatorController",["$scope","images","urlParams","msg","IMAGE_ID","keyboard","viewport","annotations","mapImage","mapAnnotations",function(t,e,n,o,i,a,r,l,s,c){"use strict";var u=document.querySelector(".navbar-annotations-filename"),f=!1;t.imageLoading=!0;var g=function(t){return u.innerHTML=t._filename,t},d=function(n){return t.imageLoading=!1,s.renderImage(n),l.show(n._id),t.$broadcast("image.shown",n),f||e.hasUnvisitedImages()||(o.info("You have now seen all images of this batch."),f=!0),n},h=function(t){return n.setSlug(t._id),t},p=function(){t.imageLoading=!0},m=function(t){return p(),e.show(t).then(d).catch(o.responseError)};t.nextImage=function(){return p(),e.next().then(g).then(d).then(h).catch(o.responseError)},t.prevImage=function(){return p(),e.prev().then(g).then(d).then(h).catch(o.responseError)},t.$on("image.fetching",function(t,e){l.load(e._id)}),t.$on("canvas.moveend",function(t,e){r.set(e)}),a.on(37,function(){t.prevImage(),t.$apply()}),a.on(39,function(){t.nextImage(),t.$apply()}),a.on(32,function(){t.nextImage(),t.$apply()}),e.init(),m(parseInt(i)).then(h),n.get("annotation")&&c.jumpToAnnotation({id:parseInt(n.get("annotation"))})}]),angular.module("biigle.annotations").controller("CanvasController",["$scope","mapAnnotations","map","$timeout","debounce",function(t,e,n,o,i){"use strict";var a=n.getView();n.on("moveend",function(e){var n=function(){t.$emit("canvas.moveend",{center:a.getCenter(),zoom:Math.round(a.getZoom())})};i(n,100,"annotator.canvas.moveend")}),n.on("change:view",function(){a=n.getView()}),e.init(t);var r=function(){o(function(){n.updateSize()},50,!1)};t.$on("sidebar.foldout.open",r),t.$on("sidebar.foldout.close",r)}]),angular.module("biigle.annotations").controller("CategoriesController",["$scope","labels","keyboard",function(t,e,n){"use strict";var o=9,i="biigle.annotations.label-favourites",a=function(){var e=t.favourites.map(function(t){return t.id});window.localStorage[i]=JSON.stringify(e)},r=function(){if(window.localStorage[i]){var e=JSON.parse(window.localStorage[i]),n=[];t.categories.forEach(function(t){var o=e.indexOf(t.id);o!==-1&&(n[o]=t)}),t.favourites=n.filter(Boolean)}},l=function(e){e>=0&&e<t.favourites.length&&t.selectItem(t.favourites[e])};t.hotkeysMap=["𝟭","𝟮","𝟯","𝟰","𝟱","𝟲","𝟳","𝟴","𝟵"],t.categories=[],t.favourites=[],t.categories=e.getList(),t.categoriesTree=e.getTree(),r(),t.selectItem=function(n){e.setSelected(n),t.searchCategory="",t.$broadcast("categories.selected")},t.isFavourite=function(e){return t.favourites.indexOf(e)!==-1},t.toggleFavourite=function(e,n){e.stopPropagation();var i=t.favourites.indexOf(n);i===-1&&t.favourites.length<o?t.favourites.push(n):t.favourites.splice(i,1),a()},t.favouritesLeft=function(){return t.favourites.length<o},n.on("1",function(){l(0),t.$apply()}),n.on("2",function(){l(1),t.$apply()}),n.on("3",function(){l(2),t.$apply()}),n.on("4",function(){l(3),t.$apply()}),n.on("5",function(){l(4),t.$apply()}),n.on("6",function(){l(5),t.$apply()}),n.on("7",function(){l(6),t.$apply()}),n.on("8",function(){l(7),t.$apply()}),n.on("9",function(){l(8),t.$apply()})}]),angular.module("biigle.annotations").controller("ColorAdjustmentControlController",["$scope","mapImage",function(t,e){"use strict";t.supportsColorAdjustment=e.supportsColorAdjustment}]),angular.module("biigle.annotations").controller("ColorAdjustmentController",["$scope","debounce","mapImage",function(t,e,n){"use strict";var o="biigle.annotations.color-adjustment",i=!1,a={brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]};t.colorAdjustment={brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]};var r=function(){n.colorAdjustment(t.colorAdjustment)};t.reset=function(e,n){void 0===e?(t.colorAdjustment=angular.copy(a),r()):a.hasOwnProperty(e)&&(t.colorAdjustment[e][n]=a[e][n],r())},t.toggleBrightnessRGB=function(){i?t.colorAdjustment.brightnessRGB=angular.copy(a.brightnessRGB):t.colorAdjustment.brightnessContrast[0]=a.brightnessContrast[0],i=!i,r()},t.isBrightnessRgbActive=function(){return i},t.$watch("colorAdjustment",function(){e(r,100,o)},!0)}]),angular.module("biigle.annotations").controller("ConfidenceController",["$scope","labels",function(t,e){"use strict";t.confidence=1,t.$watch("confidence",function(n){e.setCurrentConfidence(parseFloat(n)),n<=.25?t.confidenceClass="label-danger":n<=.5?t.confidenceClass="label-warning":n<=.75?t.confidenceClass="label-success":t.confidenceClass="label-primary"})}]),angular.module("biigle.annotations").controller("DrawingControlsController",["$scope","mapAnnotations","labels","msg","$attrs","keyboard","mapInteractions",function(t,e,n,o,i,a,r){"use strict";var l;t.selectShape=function(a){if(null===a||t.isSelected(a))e.finishDrawing(),l=void 0;else{if(!n.hasSelected())return t.$emit("sidebar.foldout.do-open","categories"),void o.info(i.selectCategory);e.startDrawing(a),l=a}},t.isSelected=function(t){return r.active("draw")&&l===t},a.on(27,function(){t.selectShape(null),t.$apply()}),a.on("a",function(){t.selectShape("Point"),t.$apply()}),a.on("s",function(){t.selectShape("Rectangle"),t.$apply()}),a.on("d",function(){t.selectShape("Circle"),t.$apply()}),a.on("f",function(){t.selectShape("LineString"),t.$apply()}),a.on("g",function(){t.selectShape("Polygon"),t.$apply()})}]),angular.module("biigle.annotations").controller("EditControlsController",["$scope","mapAnnotations","keyboard","$timeout","labels","msg","mapInteractions",function(t,e,n,o,i,a,r){"use strict";var l,s=!1,c=1e4;t.deleteSelectedAnnotations=function(){e.hasSelectedFeatures()&&confirm("Are you sure you want to delete all selected annotations?")&&e.deleteSelected()},t.hasSelectedAnnotations=e.hasSelectedFeatures;var u=function(){r.activate("translate")},f=function(){r.deactivate("translate")},g=function(){r.activate("attachLabel")},d=function(){r.deactivate("attachLabel")};t.toggleMoving=function(e){t.isMoving()?f():(e&&e.target&&e.target.blur(),u())},t.toggleAttaching=function(){t.isAttaching()?d():i.hasSelected()?g():(t.$emit("sidebar.foldout.do-open","categories"),a.info("Please select a label to attach to the annotations."))},t.canDeleteLastAnnotation=function(){return s&&e.hasDrawnAnnotation()},t.deleteLastDrawnAnnotation=function(){e.deleteLastDrawnAnnotation()},t.isMoving=function(){return r.active("translate")},t.isAttaching=function(){return r.active("attachLabel")},t.$on("annotations.drawn",function(t,e){s=!0,o.cancel(l),l=o(function(){s=!1},c)}),n.on(46,function(e){t.deleteSelectedAnnotations(),t.$apply()}),n.on(27,function(){t.isMoving()&&t.$apply(f)}),n.on(8,function(e){t.canDeleteLastAnnotation()&&(e.preventDefault(),t.deleteLastDrawnAnnotation(),t.$apply())}),n.on("m",function(){t.$apply(t.toggleMoving)}),n.on("l",function(){t.$apply(t.toggleAttaching)})}]),angular.module("biigle.annotations").controller("MinimapController",["$scope","map","mapImage","$element","styles",function(t,e,n,o,i){"use strict";var a=o[0],r=new ol.source.Vector,l=new ol.Map({target:a,controls:[],interactions:[]}),s=e.getSize(),c=e.getView();l.addLayer(n.getLayer()),l.addLayer(new ol.layer.Vector({source:r,style:i.viewport}));var u=new ol.Feature;r.addFeature(u),t.$on("image.shown",function(){var t=n.getExtent();l.setView(new ol.View({projection:n.getProjection(),center:ol.extent.getCenter(t),resolution:Math.max(t[2]/a.clientWidth,t[3]/a.clientHeight)}))});var f=function(){u.setGeometry(ol.geom.Polygon.fromExtent(c.calculateExtent(s)))};e.on("change:size",function(){s=e.getSize()}),e.on("change:view",function(){c=e.getView()}),e.on("postcompose",f);var g=function(t){c.setCenter(t.coordinate)};l.on("pointerdrag",g),o.on("mouseleave",function(){l.un("pointerdrag",g)}),o.on("mouseenter",function(){l.on("pointerdrag",g)})}]),angular.module("biigle.annotations").controller("MousePositionController",["$scope","settings","map","debounce",function(t,e,n,o){"use strict";var i=[0,0];t.position=[0,0];var a=function(e){t.position[0]=Math.round(e.coordinate[0]),t.position[1]=Math.round(i[1]-e.coordinate[1])},r=function(t){o(function(){a(t)},50,"mouse-position")};t.shown=function(){return e.getPermanentSettings("show_mouse_position")},t.$watch(t.shown,function(t){t?n.on("pointermove",r):n.un("pointermove",r)}),t.$on("image.shown",function(t,e){i[0]=e.width,i[1]=e.height})}]),angular.module("biigle.annotations").controller("ScreenshotController",["$scope","map","images",function(t,e,n){"use strict";var o=!0,i=function(){if(n.currentImage){var t=n.currentImage._filename.split(".");return t.length>1&&(t[t.length-1]="png"),t=t.join(".").toLowerCase(),"biigle_screenshot_"+t}return"biigle_screenshot.png"},a=function(t){var e,n,o,i=t.getContext("2d"),a=document.createElement("canvas").getContext("2d"),r=i.getImageData(0,0,t.width,t.height),l=r.data.length,s={top:null,left:null,right:null,bottom:null};for(e=0;e<l;e+=4)0!==r.data[e+3]&&(n=e/4%t.width,o=~~(e/4/t.width),null===s.top&&(s.top=o),null===s.left?s.left=n:n<s.left&&(s.left=n),null===s.right?s.right=n:s.right<n&&(s.right=n),null===s.bottom?s.bottom=o:s.bottom<o&&(s.bottom=o));var c=s.bottom-s.top,u=s.right-s.left,f=i.getImageData(s.left,s.top,u,c);return a.canvas.width=u,a.canvas.height=c,a.putImageData(f,0,0),a.canvas},r=function(t,e){var n="image/png";if(HTMLCanvasElement.prototype.toBlob)t.toBlob(e,n);else{for(var o=atob(t.toDataURL(n).split(",")[1]),i=o.length,a=new Uint8Array(i),r=0;r<i;r++)a[r]=o.charCodeAt(r);e(new Blob([a],{type:n}))}},l=function(t){var e=document.createElement("a");e.style="display: none",e.download=i(),e.href=URL.createObjectURL(t),document.body.appendChild(e),e.click(),setTimeout(function(){document.body.removeChild(e),URL.revokeObjectURL(e.href)},100)};t.makeShot=function(){o&&(e.once("postcompose",function(t){r(a(t.context.canvas),l)}),e.renderSync())},t.screenshotsSupported=function(){return o};var s=t.$on("image.shown",function(t,e){s(),biigle.annotations.utils.checkCors(e)||(o=!1)})}]),angular.module("biigle.annotations").controller("SelectedLabelController",["$scope","labels",function(t,e){"use strict";t.getSelectedLabel=e.getSelected,t.hasSelectedLabel=e.hasSelected}]),angular.module("biigle.annotations").controller("SettingsAnnotationOpacityController",["$scope","mapAnnotations","settings",function(t,e,n){"use strict";var o="annotation_opacity";n.setDefaultSettings(o,"1"),t[o]=n.getPermanentSettings(o),t.$watch(o,function(t){n.setPermanentSettings(o,t),e.setOpacity(t)})}]),angular.module("biigle.annotations").controller("SettingsAnnotationsCyclingController",["$scope","mapAnnotations","annotations","labels","keyboard","settings","EDIT_MODE",function(t,e,n,o,i,a,r){"use strict";var l=!1,s="annotations",c=function(n){if(!l&&t.cycling())return e.hasNext()?e.cycleNext():(t.nextImage().then(e.jumpToFirst),l=!0),n&&t.$apply(),!1},u=function(n){if(!l&&t.cycling())return e.hasPrevious()?e.cyclePrevious():(t.prevImage().then(e.jumpToLast),l=!0),n&&t.$apply(),!1},f=function(i){!l&&r&&(i&&i.preventDefault(),t.cycling()&&o.hasSelected()?n.attachAnnotationLabel(e.getCurrent()).$promise.then(function(){e.flicker(1)}):e.flicker())},g=function(e){return e.preventDefault(),t.stopCycling(),t.$apply(),!1};t.attributes={restrict:!1},t.cycling=function(){return a.getVolatileSettings("cycle")===s},t.startCycling=function(){a.setVolatileSettings("cycle",s)},t.stopCycling=function(){a.setVolatileSettings("cycle","")},t.$watch(t.cycling,function(t){t?(i.on(37,u,10),i.on(39,c,10),i.on(32,c,10),i.on(13,f,10),i.on(27,g,10),e.jumpToCurrent(),n.observeFilter(e.jumpToFirst)):(i.off(37,u),i.off(39,c),i.off(32,c),i.off(13,f),i.off(27,g),e.clearSelection(),n.unobserveFilter(e.jumpToFirst))}),t.$on("image.shown",function(){l=!1}),t.prevAnnotation=u,t.nextAnnotation=c,t.attachLabel=f}]),angular.module("biigle.annotations").controller("SettingsExpertController",["$scope","settings",function(t,e){"use strict";var n="show_mouse_position";e.setDefaultSettings(n,!1),t.mouseShown=function(){return e.getPermanentSettings(n)},t.showMouse=function(){e.setPermanentSettings(n,!0)},t.hideMouse=function(){e.setPermanentSettings(n,!1)};var o="disable_modify_interaction";e.setDefaultSettings(o,!1),t.modifyDisabled=function(){return e.getPermanentSettings(o)},t.enableModify=function(){t.modifyDisabled()&&(e.setPermanentSettings(o,!1),location.reload())},t.disableModify=function(){t.modifyDisabled()||(e.setPermanentSettings(o,!0),location.reload())}}]),angular.module("biigle.annotations").controller("SettingsSectionCyclingController",["$scope","map","mapImage","keyboard","settings",function(t,e,n,o,i){"use strict";var a=!1,r="sections",l=e.getView(),s=[0,0],c=[0,0],u=[0,0],f=[0,0],g=function(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))},d=function(t){for(var e=1/0,n=0,o=[0,0],i=0;i<=u[1];i++)for(var a=0;a<=u[0];a++)n=g(t,y([a,i])),n<e&&(o[0]=a,o[1]=i,e=n);return o},h=function(){l=e.getView(),l.on("change:resolution",p);var t=n.getExtent(),o=l.calculateExtent(e.getSize());c[0]=o[2]-o[0],c[1]=o[3]-o[1],s[0]=c[0]/2,s[1]=c[1]/2,u[0]=Math.ceil(t[2]/c[0])-1,u[1]=Math.ceil(t[3]/c[1])-1;var i;u[0]>0?(i=c[0]*(u[0]+1)-t[2],c[0]-=i/u[0]):(c[0]=o[2],s[0]=t[2]/2),u[1]>0?(i=c[1]*(u[1]+1)-t[3],c[1]-=i/u[1]):(c[1]=o[3],s[1]=t[3]/2)},p=function(){h();var t=d(y(f));f[0]=t[0],f[1]=t[1]},m=function(){h(),w(d(l.getCenter()))},v=function(){w([0,0])},b=function(){w(u)},y=function(t){return[t[0]*c[0]+s[0],t[1]*c[1]+s[1]]},w=function(t){f[0]=t[0],f[1]=t[1],l.setCenter(y(f))},S=function(){return f[0]<u[0]?[f[0]+1,f[1]]:[0,f[1]+1]},C=function(){return f[0]>0?[f[0]-1,f[1]]:[u[0],f[1]-1]},$=function(e){if(!a&&t.cycling())return f[0]<u[0]||f[1]<u[1]?w(S()):(t.nextImage().then(h).then(v),a=!0),e&&t.$apply(),!1},A=function(e){if(!a&&t.cycling())return f[0]>0||f[1]>0?w(C()):(t.prevImage().then(h).then(b),a=!0),e&&t.$apply(),!1},L=function(e){return e.preventDefault(),t.stopCycling(),t.$apply(),!1};t.cycling=function(){return i.getVolatileSettings("cycle")===r},t.startCycling=function(){i.setVolatileSettings("cycle",r)},t.stopCycling=function(){i.setVolatileSettings("cycle","")},t.$watch(t.cycling,function(t){t?(e.on("change:size",m),h(),v(),o.on(37,A,10),o.on(39,$,10),o.on(32,$,10),o.on(27,L,10)):(e.un("change:size",m),l.un("change:resolution",p),o.off(37,A),o.off(39,$),o.off(32,$),o.off(27,L))}),t.$on("image.shown",function(){a=!1}),t.prevSection=A,t.nextSection=$}]),angular.module("biigle.annotations").controller("SidebarCategoryFoldoutController",["$scope","keyboard",function(t,e){"use strict";e.on(9,function(e){e.preventDefault(),t.toggleFoldout("categories"),t.$apply()})}]),angular.module("biigle.annotations").controller("SidebarController",["$scope","$rootScope",function(t,e){"use strict";var n="biigle.annotations.sidebar-foldout",o=!1;t.toggleAnnotationFilter=function(){o=!o},t.isAnnotationFilterOpen=function(){return o},t.foldout="",t.openFoldout=function(o){window.localStorage[n]=o,t.foldout=o,e.$broadcast("sidebar.foldout.open",o)},t.closeFoldout=function(){window.localStorage.removeItem(n),t.foldout="",e.$broadcast("sidebar.foldout.close")},t.toggleFoldout=function(e){t.foldout===e?t.closeFoldout():t.openFoldout(e)},e.$on("sidebar.foldout.do-open",function(e,n){t.openFoldout(n)}),window.localStorage[n]&&t.openFoldout(window.localStorage[n])}]),angular.module("biigle.annotations").service("annotations",["Annotation","SHAPES","msg","AnnotationLabel","labels","$q",function(t,e,n,o,i,a){"use strict";var r,l=this,s=a.defer(),c=s.promise,u=[],f=[],g={},d={groupedByLabel:{},flat:[]},h=[],p=[],m=[],v={},b=function(t,e,n){for(var o=t.length-1;o>=0;o--)if(t[o].id===e)return n(t[o],o)},y=function(t){for(var n=e.length-1;n>=0;n--)if(e[n].id===t)return e[n]},w=function(t){for(var n=e.length-1;n>=0;n--)if(e[n].name===t)return e[n]},S=function(t){return t.shape=y(t.shape_id).name,t},C=function(t){return r.push(t),A(t,t.labels[0]),t},$=function(t){var e=r.indexOf(t);return r.splice(e,1),I(t),t},A=function(t,e){var n={annotation:t,label:e,shape:t.shape},o=e.label;g.hasOwnProperty(o.id)?g[o.id].annotations.push(n):g[o.id]={label:o,annotations:[n]}},L=function(t,e){for(var n=g[e.id].annotations,o=n.length-1;o>=0;o--)if(n[o].annotation.id===t.id){n.splice(o,1);break}0===n.length&&delete g[e.id]},I=function(t){for(var e in g)g.hasOwnProperty(e)&&L(t,g[e].label)},F=function(){for(var t in g)g.hasOwnProperty(t)&&delete g[t]},E=function(t){for(var e,n,o=t.length-1;o>=0;o--){e=t[o],n=e.labels;for(var i=n.length-1;i>=0;i--)A(e,n[i])}},P=function(t){for(var e={groupedByLabel:angular.copy(g),flat:angular.copy(r)},n=h.length-1;n>=0;n--)e=h[n](e);var o=e.flat.filter(function(t){for(var e=d.flat.length-1;e>=0;e--)if(d.flat[e].id===t.id)return!1;return!0}),i=d.flat.filter(function(t){for(var n=e.flat.length-1;n>=0;n--)if(e.flat[n].id===t.id)return!1;return!0});d.groupedByLabel=e.groupedByLabel,d.flat=e.flat,t||u.forEach(function(t){t(d.flat,o,i)})},x=function(){p.length=0;for(var t in g)g.hasOwnProperty(t)&&p.push(g[t].label)},_=function(){m.length=0;var t={};r.forEach(function(e){e.labels.forEach(function(e){t.hasOwnProperty(e.user.id)||(t[e.user.id]=1,m.push(e.user))})})},k=function(t){_(),x(),P(t===!0)};this.get=function(){return d.flat},this.getGroupedByLabel=function(){return d.groupedByLabel},this.load=function(e){return v.hasOwnProperty(e)||(v[e]=t.query({id:e}),v[e].$promise.then(function(t){t.forEach(S)})),v[e]},this.show=function(t){F(),r=l.load(t),c=r.$promise.then(E).then(k).then(l.get),s&&(c.then(s.resolve).catch(s.reject),s=void 0)},this.add=function(e){!e.shape_id&&e.shape&&(e.shape_id=w(e.shape).id);var o=t.add(e);return o.$promise.catch(n.responseError).then(S).then(C).then(k),o},this.delete=function(t){return b(r,t.id,function(t){return t.$delete().catch(n.responseError).then($).then(k)})},this.save=function(t){t.$save(function(){b(r,t.id,function(e,n){r[n]=angular.copy(t)})},n.responseError)},this.getPromise=function(){return c},this.attachAnnotationLabel=function(t,e,a){e=e||i.getSelected(),a=a||i.getCurrentConfidence();var l=o.attach({annotation_id:t.id,label_id:e.id,confidence:a},function(){b(r,t.id,function(t){t.labels.push(l),A(t,l),k(!0)})},n.responseError);return l},this.removeAnnotationLabel=function(t,e){return o.delete({id:e.id},function(){b(r,t.id,function(t){b(t.labels,e.id,function(e,n){t.labels.splice(n,1)}),L(t,e.label),k()})},n.responseError)},this.setFilter=function(t){l.clearActiveFilters(),h.push(t)},this.refreshFiltering=function(){P(),f.forEach(function(t){t()})},this.clearActiveFilters=function(){h.length=0},this.hasActiveFilters=function(){return h.length>0},this.getAvailableLabels=function(){return p},this.getAvailableUsers=function(){return m},this.getAvailableShapes=function(){return e},this.observe=function(t){u.push(t)},this.observeFilter=function(t){f.push(t)},this.unobserveFilter=function(t){var e=f.indexOf(t);e!==-1&&f.splice(e,1)}}]),angular.module("biigle.annotations").service("images",["$rootScope","URL","$q","filterSubset","VOLUME_ID","IMAGES_IDS","IMAGES_FILENAMES",function(t,e,n,o,i,a,r){"use strict";var l=this,s=[],c=5,u=[],f=[];this.currentImage=void 0;var g=function(t){var e=a.indexOf(t);return r[e]},d=function(t){t=t||l.currentImage._id;var e=s.indexOf(t);return s[(e+1)%s.length]},h=function(t){t=t||l.currentImage._id;var e=s.indexOf(t),n=s.length;return s[(e-1+n)%n]},p=function(t){t=t||l.currentImage._id;for(var e=u.length-1;e>=0;e--)if(u[e]._id==t)return u[e]},m=function(t){l.currentImage=t;for(var e=f.length-1;e>=0;e--)f[e]===t._id&&f.splice(e,1);return t},v=function(o){var i=n.defer(),a=p(o);return a?i.resolve(a):(a=document.createElement("img"),a._id=o,a._filename=g(o),a.onload=function(){u.push(a),u.length>c&&u.shift(),i.resolve(a)},a.onerror=function(t){i.reject(t)},a.src=e+"/api/v1/images/"+o+"/file"),t.$broadcast("image.fetching",a),i.promise},b=function(t){return v(d(t._id)),v(h(t._id)),t};this.init=function(){s=a;var t=window.localStorage["biigle.volumes."+i+".images"];t&&(t=JSON.parse(t),o(t,s),s=t),angular.copy(s,f)},this.show=function(t){return v(t).then(m).then(b)},this.next=function(){return l.show(d())},this.prev=function(){return l.show(h())},this.getCurrentId=function(){return l.currentImage._id},this.hasUnvisitedImages=function(){return 0!==f.length}}]),angular.module("biigle.annotations").service("labels",["AnnotationLabel","LABEL_TREES",function(t,e){"use strict";var n,o=1,i=e,a={},r=[],l=[],s=function(){for(var t=null,e=function(e){var n=e.parent_id;a[t][n]?a[t][n].push(e):a[t][n]=[e]},n=i.length-1;n>=0;n--)t=i[n].name,a[t]={},i[n].labels.forEach(e),r=r.concat(i[n].labels)},c=function(t){for(var e=r.length-1;e>=0;e--)if(r[e].id===t)return r[e];return null},u=function(t){var e=t;if(l.length=0,e)for(;null!==e.parent_id;)l.unshift(e.parent_id),e=c(e.parent_id)};this.fetchForAnnotation=function(e){if(e)return e.labels||(e.labels=t.query({annotation_id:e.id})),e.labels},this.getTree=function(){return a},this.getList=function(){return r},this.setSelected=function(t){n=t,u(t)},this.getSelected=function(){return n},this.hasSelected=function(){return!!n},this.getSelectedId=function(){return n?n.id:null},this.setCurrentConfidence=function(t){o=t},this.getCurrentConfidence=function(){return o},this.isOpen=function(t){return l.indexOf(t.id)!==-1},this.isSelected=function(t){return n&&n.id===t.id},s()}]),angular.module("biigle.annotations").service("mapAnnotations",["map","images","annotations","debounce","styles","$interval","labels","mapInteractions","settings",function(t,e,n,o,i,a,r,l,s){"use strict";var c=new ol.Collection,u=new ol.source.Vector({features:c}),f=!0,g=new ol.layer.Vector({source:u,style:i.features,zIndex:100,updateWhileAnimating:f,updateWhileInteracting:f});t.addLayer(g);var d=l.init("select",function(t){return t===g}).getFeatures();s.getPermanentSettings("disable_modify_interaction")||(l.init("modify",c),l.deactivate("modify")),l.init("translate",d),l.deactivate("translate"),l.init("attachLabel",c),l.deactivate("attachLabel");var h,p,m=0,v={padding:[50,50,50,50],minResolution:1},b=this,y=function(e){var n=e.length<400;if(n!==f){var o=new ol.layer.Vector({updateWhileAnimating:n,updateWhileInteracting:n});o.setProperties(g.getProperties()),o.setStyle(g.getStyle()),t.removeLayer(g),g=o,f=n,t.addLayer(g)}},w=function(e){b.clearSelection(),e&&(d.push(e),t.getView().fit(e.getGeometry(),t.getSize(),v))},S=function(t,n){return n%2===1?e.currentImage.height-t:t},C=function(t){var e;switch(t.getType()){case"Circle":e=[t.getCenter(),[t.getRadius()]];break;case"Polygon":case"Rectangle":e=t.getCoordinates()[0];
break;case"Point":e=[t.getCoordinates()];break;default:e=t.getCoordinates()}return Array.prototype.concat.apply([],e).map(S)},$=function(t){var e=t.target,i=function(){e.annotation.points=C(e.getGeometry()),n.save(e.annotation)};o(i,500,e.annotation.id)},A=function(t){u.removeFeature(u.getFeatureById(t.id))},L=function(t){for(var n,o=t.points,i=[],a=e.currentImage.height,r=0;r<o.length;r+=2)i.push([o[r],a-(o[r+1]||0)]);switch(t.shape){case"Point":n=new ol.geom.Point(i[0]);break;case"Rectangle":n=new ol.geom.Rectangle([i]);break;case"Polygon":n=new ol.geom.Polygon([i]);break;case"LineString":n=new ol.geom.LineString(i);break;case"Circle":n=new ol.geom.Circle(i[0],i[1][0]);break;default:return void console.error("Unknown annotation shape: "+t.shape)}var l=new ol.Feature({geometry:n});return l.annotation=t,l.setId(t.id),t.labels&&t.labels.length>0&&l.set("color",t.labels[0].label.color),l.on("change",$),l},I=function(t,n,o){o.length>t.length?(u.clear(!0),u.addFeatures(t.map(L))):(o.forEach(A),u.addFeatures(n.map(L))),b.clearSelection(),y(t),h&&h.annotation&&h.annotation.image&&h.annotation.image.id!==e.getCurrentId()&&(h=null)};n.observe(I);var F=function(t){var o=t.feature.getGeometry(),i=r.getSelected();return t.feature.set("color",i.color),t.feature.annotation=n.add({id:e.getCurrentId(),shape:o.getType(),points:C(o),label_id:i.id,confidence:r.getCurrentConfidence()}),t.feature.annotation.$promise.finally(function(){u.removeFeature(t.feature)}),h=t.feature,t.feature.annotation.$promise},E=function(t){t&&t.annotation&&(h&&t.getId()===h.getId()&&(h=null),n.delete(t.annotation))},P=function(t){return u.getFeatureById(t.id)};this.init=function(t){p=t,b.onSelectedAnnotation(function(){t.$$phase||t.$apply()})},this.startDrawing=function(t){l.init("draw",t,u),l.on("draw","drawend",F),l.on("draw","drawend",function(t){p.$broadcast("annotations.drawn",t.feature)})},this.finishDrawing=function(){l.deactivate("draw")},this.hasDrawnAnnotation=function(){return h&&h.annotation&&h.annotation.$resolved},this.deleteLastDrawnAnnotation=function(){E(h)},this.deleteSelected=function(){d.forEach(E)},this.deleteAnnotation=function(t){E(P(t))},this.toggleSelect=function(t,e){var n=P(t);n&&(d.remove(n)||(e||b.clearSelection(),d.push(n)))},this.hasSelectedFeatures=function(){return d.getLength()>0},this.onSelectedAnnotation=function(t){return l.on("select","select",t)},this.offSelectedAnnotation=function(t){return l.un("select","select",t)},this.fit=function(e){var n=P(e);if(n){var o=t.getView(),i=ol.animation.pan({source:o.getCenter()}),a=ol.animation.zoom({resolution:o.getResolution()});t.beforeRender(i,a),o.fit(n.getGeometry(),t.getSize(),v)}},this.isAnnotationSelected=function(t){for(var e=d.getArray(),n=e.length-1;n>=0;n--)if(e[n].annotation&&e[n].annotation.id===t.id)return!0;return!1},this.clearSelection=function(){d.clear()},this.getSelectedFeatures=function(){return d},this.addFeature=function(t){return u.addFeature(t),F({feature:t})},this.setOpacity=function(t){g.setOpacity(t)},this.cycleNext=function(){m=(m+1)%c.getLength(),b.jumpToCurrent()},this.hasNext=function(){return m+1<c.getLength()},this.cyclePrevious=function(){var t=c.getLength();m=(m+t-1)%t,b.jumpToCurrent()},this.hasPrevious=function(){return m>0},this.jumpToCurrent=function(){n.getPromise().then(function(){w(c.item(m))})},this.jumpToFirst=function(){m=0,b.jumpToCurrent()},this.jumpToLast=function(){n.getPromise().then(function(t){0!==t.length&&(m=t.length-1),b.jumpToCurrent()})},this.jumpToAnnotation=function(t){n.getPromise().then(function(){for(var e=c.getArray(),n=e.length-1;n>=0;n--)if(e[n].annotation.id===t.id){w(e[n]);break}})},this.flicker=function(t){var e=d.item(0);if(e){t=t||3;var n=function(){d.getLength()>0?d.clear():d.push(e)};a(n,100,2*t)}},this.getCurrent=function(){return c.item(m).annotation}}]),angular.module("biigle.annotations").service("mapImage",["map","viewport",function(t,e){"use strict";var n=[0,0,0,0],o=null,i=document.createElement("canvas"),a=i.getContext("2d"),r=!0,l=!0;try{var s=fx.canvas(),c=null,u=null}catch(t){r=!1,console.log(t)}window.onbeforeunload=function(){c&&(c.destroy(),s.width=1,s.height=1)};var f=new ol.proj.Projection({code:"biigle-image",units:"pixels",extent:n}),g=new ol.layer.Image;t.addLayer(g);var d={brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]},h={brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]},p=function(t){var e=t.height,n=t.width,o=s._.gl.getParameter(s._.gl.MAX_TEXTURE_SIZE);r=o>=e&&o>=n,r||console.log("Insufficient WebGL texture size. Required: "+n+"x"+e+", available: "+o+"x"+o+"."),s.width=n,s.height=e,n===s._.gl.drawingBufferWidth&&e===s._.gl.drawingBufferHeight||(r=!1,console.log("Your browser does not allow a WebGL drawing buffer with the size of the original image. This would result in distorted display of the image.")),biigle.annotations.utils.checkCors(t)||(r=!1,console.log("Color adjustment is not supported for cross origin resources."))},m=function(){return!angular.equals(h,d)},v=function(e){if(o){u!==o.src&&(c?c.loadContentsOf(o):c=s.texture(o),u=o.src),s.draw(c);for(var n in h)h.hasOwnProperty(n)&&(angular.equals(h[n],d[n])||s[n].apply(s,h[n]));s.update(),a.drawImage(s,0,0),e&&t.render()}};this.renderImage=function(s){o=s;var c=!1;n[2]&&n[3]&&(c=n[2]!==o.width||n[3]!==o.height),n[2]=o.width,n[3]=o.height,i.width=o.width,i.height=o.height,r&&l&&(l=!1,p(o)),r&&m()?v():a.drawImage(o,0,0),g.setSource(new ol.source.Canvas({canvas:i,projection:f,canvasExtent:n,canvasSize:[i.width,i.height]}));var u=e.getCenter();(c||void 0===u[0]||void 0===u[1])&&(u=ol.extent.getCenter(n));var d=e.getZoom();t.setView(new ol.View({projection:f,center:u,zoom:d,zoomFactor:1.5,minResolution:.25,extent:n})),void 0===d&&t.getView().fit(n,t.getSize()),t.renderSync()},this.getExtent=function(){return n},this.getProjection=function(){return f},this.getLayer=function(){return g},this.colorAdjustment=function(t){if(r){var e=m();for(var n in h)t.hasOwnProperty(n)&&h.hasOwnProperty(n)&&(h[n]=t[n].map(parseFloat));(e||m())&&v(!0)}},this.supportsColorAdjustment=function(){return r}}]),angular.module("biigle.annotations").service("mapInteractions",["map","styles","AttachLabelInteraction","ExtendedTranslateInteraction",function(t,e,n,o){"use strict";var i=this,a={},r={select:function(t,n){return a.select=new ol.interaction.Select({style:e.highlight,layers:n,multi:!0}),a.select},modify:function(t,e){return a.modify=new ol.interaction.Modify({features:e,deleteCondition:function(t){return ol.events.condition.shiftKeyOnly(t)&&ol.events.condition.singleClick(t)}}),a.modify},draw:function(t,n,o){return a.draw=new ol.interaction.Draw({source:o,type:n,style:e.editing}),a.draw},translate:function(t,e){return a.translate=new o({features:e}),a.translate},attachLabel:function(t,e){return a.attachLabel=new n({features:e}),a.attachLabel}},l={select:function(t){t.target.getFeatures().clear()},draw:function(t){t.oldValue?(h("draw"),f("modify"),u("select")):(d("draw"),f("select"),f("translate"),f("attachLabel"),u("modify"))},translate:function(t){t.oldValue||(f("draw"),f("attachLabel"))},attachLabel:function(t){t.oldValue||(f("draw"),f("translate"))}},s=function(t){return a.hasOwnProperty(t)},c=function(t){return a[t]},u=function(t){s(t)&&a[t].setActive(!0)},f=function(t){s(t)&&a[t].setActive(!1)},g=function(t){return s(t)&&a[t].getActive()},d=function(e){s(e)&&t.addInteraction(a[e])},h=function(e){s(e)&&t.removeInteraction(a[e])},p=function(t,e,n){s(t)&&a[t].on(e,n)},m=function(t,e,n){s(t)&&a[t].on(e,n)},v=function(t){f(t),h(t);var e=r[t].apply(i,arguments);return d(t),l.hasOwnProperty(t)&&(p(t,"change:active",l[t]),l[t]({key:"active",target:e})),e};this.get=c,this.activate=u,this.deactivate=f,this.active=g,this.add=d,this.remove=h,this.on=p,this.un=m,this.init=v}]),angular.module("biigle.annotations").service("settings",["debounce",function(t){"use strict";var e=this,n="biigle.annotations.settings",o={},i={},a={},r=function(){var t=angular.copy(i);for(var e in t)t[e]===o[e]&&delete t[e];window.localStorage.setItem(n,JSON.stringify(t))},l=function(){t(r,250,n)},s=function(){var t={};return window.localStorage.getItem(n)&&(t=JSON.parse(window.localStorage.getItem(n))),angular.extend(t,o)};this.setPermanentSettings=function(t,e){i[t]=e,l()},this.getPermanentSettings=function(t){return i[t]},this.setDefaultSettings=function(t,n){o[t]=n,i.hasOwnProperty(t)||e.setPermanentSettings(t,n)},this.setVolatileSettings=function(t,e){a[t]=e},this.getVolatileSettings=function(t){return a[t]},angular.extend(i,s())}]),angular.module("biigle.annotations").service("styles",function(){"use strict";var t=this;this.colors={white:[255,255,255,1],blue:[0,153,255,1],orange:"#ff5e00"};var e=6,n=3,o=new ol.style.Stroke({color:this.colors.white,width:5}),i=new ol.style.Stroke({color:this.colors.white,width:6}),a=new ol.style.Stroke({color:this.colors.blue,width:n}),r=new ol.style.Stroke({color:this.colors.orange,width:n}),l=new ol.style.Fill({color:this.colors.blue}),s=new ol.style.Fill({color:this.colors.orange}),c=new ol.style.Stroke({color:this.colors.white,width:2}),u=new ol.style.Stroke({color:this.colors.white,width:n}),f=new ol.style.Stroke({color:this.colors.white,width:2,lineDash:[3]}),g=new ol.style.Stroke({color:this.colors.blue,width:n,lineDash:[5]});new ol.style.Fill({color:this.colors.blue}),new ol.style.Fill({color:this.colors.orange});this.features=function(n){var i=n.get("color");return i=i?"#"+i:t.colors.blue,[new ol.style.Style({stroke:o,image:new ol.style.Circle({radius:e,fill:new ol.style.Fill({color:i}),stroke:c})}),new ol.style.Style({stroke:new ol.style.Stroke({color:i,width:3})})]},this.highlight=[new ol.style.Style({stroke:i,image:new ol.style.Circle({radius:e,fill:s,stroke:u}),zIndex:200}),new ol.style.Style({stroke:r,zIndex:200})],this.editing=[new ol.style.Style({stroke:o,image:new ol.style.Circle({radius:e,fill:l,stroke:f})}),new ol.style.Style({stroke:g})],this.viewport=[new ol.style.Style({stroke:a}),new ol.style.Style({stroke:new ol.style.Stroke({color:this.colors.white,width:1})})]}),angular.module("biigle.annotations").service("viewport",["urlParams",function(t){"use strict";var e={zoom:t.get("z"),center:[t.get("x"),t.get("y")]};this.set=function(n){e.zoom=n.zoom,e.center[0]=Math.round(n.center[0]),e.center[1]=Math.round(n.center[1]),t.set({z:e.zoom,x:e.center[0],y:e.center[1]})},this.get=function(){return e},this.getZoom=function(){return e.zoom},this.getCenter=function(){return e.center}}]),biigle.annotations={},biigle.$declare("annotations.utils",{checkCors:function(t){var e=document.createElement("canvas").getContext("2d");e.drawImage(t,0,0);try{e.getImageData(0,0,1,1)}catch(t){return 18!==t.code}return!0}});