biigle.$viewModel("annotations-navbar",function(t){new Vue({el:t,mixins:[biigle.$require("annotations.mixins.imageFilenameTracker")],data:{defaultFilename:t.innerHTML,imageIdsToSee:biigle.$require("annotations.imagesIds").slice()},watch:{currentImageId:function(t){for(var e=this.imageIdsToSee,n=e.length-1;n>=0;n--)if(e[n]===t){e.splice(n,1);break}},imageIdsToSee:function(t){0===t.length&&biigle.$require("messages.store").info("You have now seen all images of this batch.")},currentImageFilename:function(t){document.title="Annotate "+t}},created:function(){var t=this;biigle.$require("events").$on("images.sequence",function(e){t.imageIdsToSee=e.slice()})}})}),biigle.$viewModel("annotator-container",function(t){var e=biigle.$require("events"),n=biigle.$require("annotations.volumeId"),i=biigle.$require("annotations.imagesIds"),o=biigle.$require("annotations.stores.images"),a=biigle.$require("annotations.stores.annotations"),s=biigle.$require("volumes.urlParams"),r=biigle.$require("messages.store"),l=biigle.$require("annotations.stores.utils"),h=biigle.$require("annotations.stores.settings");new Vue({el:t,mixins:[biigle.$require("core.mixins.loader")],components:{sidebar:biigle.$require("annotations.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),annotationsTab:biigle.$require("annotations.components.annotationsTab"),labelsTab:biigle.$require("annotations.components.labelsTab"),annotationModesTab:biigle.$require("annotations.components.annotationModesTab"),colorAdjustmentTab:biigle.$require("annotations.components.colorAdjustmentTab"),imageLabelTab:biigle.$require("annotations.components.imageLabelTab"),settingsTab:biigle.$require("annotations.components.settingsTab"),annotationCanvas:biigle.$require("annotations.components.annotationCanvas")},data:{isEditor:biigle.$require("annotations.isEditor"),imageIndex:null,image:null,annotations:[],annotationFilter:null,lastCreatedAnnotation:null,lastCreatedAnnotationTimeout:null,annotationOpacity:1,mapCenter:void 0,mapResolution:void 0,selectedLabel:null,annotationMode:"default",focussedAnnotationIndex:null,annotationModeCarry:null,showMousePosition:!1,showZoomLevel:!1,showAnnotationTooltip:!1,showMinimap:!0,showScaleLine:!1,imagesArea:null,openTab:null},computed:{imageId:function(){return this.imagesIds[this.imageIndex]},hasAnnotationFilter:function(){return"function"==typeof this.annotationFilter},filteredAnnotations:function(){var t=this.annotations.filter(function(t){return!t.markedForDeletion});return this.hasAnnotationFilter?t.filter(this.annotationFilter):t},selectedAnnotations:function(){return this.filteredAnnotations.filter(function(t){return t.selected})},supportsColorAdjustment:function(){return o.supportsColorAdjustment},focussedAnnotation:function(){return this.filteredAnnotations[this.focussedAnnotationIndex]},isDefaultAnnotationMode:function(){return"default"===this.annotationMode},isVolareAnnotationMode:function(){return"volare"===this.annotationMode},isLawnmowerAnnotationMode:function(){return"lawnmower"===this.annotationMode},isSamplingAnnotationMode:function(){return this.annotationMode.endsWith("Sampling")},imagesIds:function(){var t=window.localStorage.getItem("biigle.volumes."+n+".images");if(t){var e={};return i.forEach(function(t){e[t]=null}),JSON.parse(t).filter(function(t){return e.hasOwnProperty(t)})}return i}},methods:{getImageAndAnnotationsPromises:function(t){return[o.fetchAndDrawImage(t),a.fetchAnnotations(t)]},setCurrentImageAndAnnotations:function(t){t?(this.image=t[0],this.annotations=t[1]):(this.image=null,this.annotations=[])},updateUrlSlug:function(){s.setSlug(this.imageId)},getNextIndex:function(t){return(t+1)%this.imagesIds.length},getPreviousIndex:function(t){return(t+this.imagesIds.length-1)%this.imagesIds.length},handleNext:function(){if(!this.loading){if(this.isVolareAnnotationMode){if(this.focussedAnnotationIndex<this.filteredAnnotations.length-1)return void this.focussedAnnotationIndex++;this.focussedAnnotationIndex=-1/0}else if(this.isLawnmowerAnnotationMode){if(this.$refs.canvas.showNextImageSection())return;this.annotationModeCarry=0}else if(this.isSamplingAnnotationMode){if(this.$refs.canvas.showNextSamplingLocation())return;this.annotationModeCarry=0}this.imageIndex=this.getNextIndex(this.imageIndex)}},handlePrevious:function(){if(!this.loading){if(this.isVolareAnnotationMode){if(this.focussedAnnotationIndex>0)return void this.focussedAnnotationIndex--;this.focussedAnnotationIndex=1/0}else if(this.isLawnmowerAnnotationMode){if(this.$refs.canvas.showPreviousImageSection())return;this.annotationModeCarry=1/0}else if(this.isSamplingAnnotationMode){if(this.$refs.canvas.showPreviousSamplingLocation())return;this.annotationModeCarry=1/0}this.imageIndex=this.getPreviousIndex(this.imageIndex)}},maybeUpdateFocussedAnnotation:function(){this.isVolareAnnotationMode?this.filteredAnnotations.length>0?this.focussedAnnotationIndex===1/0?this.focussedAnnotationIndex=this.filteredAnnotations.length-1:this.focussedAnnotationIndex=0:(this.focussedAnnotationIndex=null,this.$refs.canvas.fitImage()):this.focussedAnnotationIndex=null},maybeUpdateShownImageSection:function(){this.isLawnmowerAnnotationMode&&(this.annotationModeCarry===1/0?this.$refs.canvas.showLastImageSection():this.$refs.canvas.showFirstImageSection())},maybeUpdateShownSampling:function(t){this.isSamplingAnnotationMode&&(this.$refs.canvas.setSamplingData(this.annotationMode,t),this.annotationModeCarry===1/0?this.$nextTick(this.$refs.canvas.showLastSamplingLocation):this.$nextTick(this.$refs.canvas.showFirstSamplingLocation))},maybeUpdateAnnotationMode:function(t){this.maybeUpdateFocussedAnnotation(),this.maybeUpdateShownImageSection(),this.maybeUpdateShownSampling(t)},handleMapMoveend:function(t){this.mapCenter=t.center,this.mapResolution=t.resolution,s.set({r:Math.round(100*t.resolution),x:Math.round(t.center[0]),y:Math.round(t.center[1])})},handleSelectAnnotation:function(t,e){if(e&&e.shiftKey)return void(t.selected=!0);this.annotations.forEach(function(e){e.selected=t.id===e.id})},handleSelectAnnotations:function(t,e){t.forEach(function(t){t.selected=!0}),e.forEach(function(t){t.selected=!1}),this.$refs.annotationsTab.scrollIntoView(this.selectedAnnotations)},handleDeselectAnnotation:function(t,e){if(e&&e.shiftKey)return void(t.selected=!1);this.annotations.forEach(function(t){t.selected=!1})},focusAnnotation:function(t,e){this.$refs.canvas.focusAnnotation(t,e)},handleDetachAnnotationLabel:function(t,e){this.isEditor&&a.detachLabel(t,e).catch(r.handleErrorResponse)},handleDeleteAnnotation:function(t){this.isEditor&&(this.lastCreatedAnnotation&&this.lastCreatedAnnotation.id===t.id&&(this.lastCreatedAnnotation=null),Vue.set(t,"markedForDeletion",!0),a.delete(t).catch(function(e){t.markedForDeletion=!1,r.handleErrorResponse(e)}))},handleDeleteAnnotations:function(t){t.forEach(this.handleDeleteAnnotation)},handleUpdateAnnotations:function(t){this.isEditor&&Vue.Promise.all(t.map(a.update)).catch(r.handleErrorResponse)},selectAndFocusAnnotation:function(t){this.selectedAnnotations.forEach(function(t){t.selected=!1}),t.selected=!0,this.focusAnnotation(t,!0)},handleFilter:function(t){this.annotationFilter=t},handleSelectedLabel:function(t){this.selectedLabel=t},handleNewAnnotation:function(t,e){this.isEditor&&(t.label_id=this.selectedLabel.id,t.confidence=1,a.create(this.imageId,t).then(this.setLastCreatedAnnotation).catch(r.handleErrorResponse).finally(e))},handleAttachLabel:function(t,e){if(e=e||this.selectedLabel,this.isEditor&&e){var n={label_id:e.id,confidence:1};a.attachLabel(t,n).catch(r.handleErrorResponse)}},handleAttachAllSelected:function(){this.selectedAnnotations.forEach(this.handleAttachLabel)},emitImageChanged:function(){e.$emit("images.change",this.imageId,this.image)},cachePreviousAndNext:function(){var t=this.imagesIds[this.getPreviousIndex(this.imageIndex)],e=this.imagesIds[this.getNextIndex(this.imageIndex)];Vue.Promise.all([a.fetchAnnotations(e),o.fetchImage(e),a.fetchAnnotations(t),o.fetchImage(t)]).catch(function(){})},setLastCreatedAnnotation:function(t){this.lastCreatedAnnotationTimeout&&window.clearTimeout(this.lastCreatedAnnotationTimeout);var e=this;this.lastCreatedAnnotation=t,this.lastCreatedAnnotationTimeout=window.setTimeout(function(){e.lastCreatedAnnotation=null},1e4)},updateColorAdjustment:function(t){var e=this.$refs.canvas;l.debounce(function(){o.updateColorAdjustment(t),e.render()},100,"annotations.color-adjustment.update")},handleSettingsChange:function(t,e){switch(t){case"annotationOpacity":this.annotationOpacity=e;break;case"mousePosition":this.showMousePosition=e;break;case"zoomLevel":this.showZoomLevel=e;break;case"scaleLine":this.showScaleLine=e;break;case"annotationTooltip":this.showAnnotationTooltip=e;break;case"minimap":this.showMinimap=e}},handleAnnotationModeChange:function(t,e){this.annotationMode=t,this.annotationModeCarry=null,this.maybeUpdateAnnotationMode(e)},handleOpenedTab:function(t){h.set("openTab",t)},handleClosedTab:function(t){h.delete("openTab")},handleLoadingError:function(t){r.danger(t)},createSampledAnnotation:function(){this.$refs.canvas.createSampledAnnotation()},setImagesArea:function(t){this.imagesArea=t.body}},watch:{imageId:function(t){t&&(this.startLoading(),Vue.Promise.all(this.getImageAndAnnotationsPromises(t)).catch(this.handleLoadingError).then(this.setCurrentImageAndAnnotations).then(this.updateUrlSlug).then(this.maybeUpdateAnnotationMode).then(this.emitImageChanged).then(this.cachePreviousAndNext).finally(this.finishLoading))},focussedAnnotation:function(t){t&&this.selectAndFocusAnnotation(t)},annotationFilter:function(){this.maybeUpdateFocussedAnnotation()},showScaleLine:function(t){t&&!this.imagesArea&&(this.imagesArea={},biigle.$require("annotations.api.volumeImageArea").get({id:n}).then(this.setImagesArea,r.handleErrorResponse))}},created:function(){if(this.startLoading(),0===this.imagesIds.length)return void r.info("Your current volume filtering contains no images.");var t=this.imagesIds.indexOf(biigle.$require("annotations.imageId"));if(-1===t&&(t=0,r.info("The requested image does not exist in your current volume filtering. Switching to the first image.")),this.imageIndex=t,e.$emit("images.sequence",this.imagesIds),void 0!==s.get("r")&&(this.mapResolution=parseInt(s.get("r"),10)/100),void 0!==s.get("x")&&void 0!==s.get("y")&&(this.mapCenter=[parseInt(s.get("x"),10),parseInt(s.get("y"),10)]),e.$on("annotations.select",this.handleSelectAnnotation),e.$on("annotations.deselect",this.handleDeselectAnnotation),e.$on("annotations.focus",this.focusAnnotation),e.$on("annotations.detachLabel",this.handleDetachAnnotationLabel),e.$on("annotations.delete",this.handleDeleteAnnotation),s.get("annotation")){var n=parseInt(s.get("annotation")),i=this;e.$once("images.change",function(){for(var t=i.annotations,e=t.length-1;e>=0;e--)if(t[e].id===n)return void i.selectAndFocusAnnotation(t[e])})}h.has("openTab")&&(this.openTab=h.get("openTab"))}})}),biigle.$declare("annotations.api.volumeImageArea",Vue.resource("api/v1/volumes{/id}/images/area")),biigle.$component("annotations.components.annotationCanvas",function(){var t,e,n,i,o,a,s,r,l={},h=new ol.layer.Image,c=new ol.layer.Tile,u=new ol.Collection,d=new ol.source.Vector({features:u}),g=new ol.layer.Vector({source:d,zIndex:100,updateWhileAnimating:!0,updateWhileInteracting:!0});return g.set("name","annotations"),{mixins:[biigle.$require("annotations.components.annotationCanvas.lawnmower"),biigle.$require("annotations.components.annotationCanvas.mousePosition"),biigle.$require("annotations.components.annotationCanvas.zoomLevel"),biigle.$require("annotations.components.annotationCanvas.annotationTooltip"),biigle.$require("annotations.components.annotationCanvas.sampling"),biigle.$require("annotations.components.annotationCanvas.scaleLine")],components:{minimap:biigle.$require("annotations.components.minimap"),labelIndicator:biigle.$require("annotations.components.labelIndicator"),controlButton:biigle.$require("annotations.components.controlButton")},props:{editable:{type:Boolean,default:!1},image:{type:Object,default:null},annotations:{type:Array,default:function(){return[]}},selectedAnnotations:{type:Array,default:function(){return[]}},center:{type:Array,default:void 0},resolution:{type:Number,default:void 0},selectedLabel:{default:null},lastCreatedAnnotation:{default:null},annotationOpacity:{type:Number,default:1},annotationMode:{type:String,default:"default"},showMinimap:{type:Boolean,default:!0},crossOrigin:{type:Boolean,default:!1}},data:function(){biigle.$require("annotations.stores.styles");return{initialized:!1,viewFitOptions:{padding:[50,50,50,50],minResolution:1},interactionMode:"default",mapSize:[0,0]}},computed:{extent:function(){return this.image?[0,0,this.image.width,this.image.height]:[0,0,0,0]},viewExtent:function(){return this.initialized&&this.resolution&&t?t.getView().calculateExtent(this.mapSize):[0,0,0,0]},projection:function(){return new ol.proj.Projection({code:"biigle-image",units:"pixels",extent:this.extent})},selectedFeatures:function(){return n?n.getFeatures():[]},isDefaultInteractionMode:function(){return"default"===this.interactionMode},isDrawing:function(){return this.interactionMode.startsWith("draw")},isDrawingPoint:function(){return"drawPoint"===this.interactionMode},isDrawingRectangle:function(){return"drawRectangle"===this.interactionMode},isDrawingCircle:function(){return"drawCircle"===this.interactionMode},isDrawingLineString:function(){return"drawLineString"===this.interactionMode},isDrawingPolygon:function(){return"drawPolygon"===this.interactionMode},isDrawingEllipse:function(){return"drawEllipse"===this.interactionMode},isTranslating:function(){return"translate"===this.interactionMode},isMagicWanding:function(){return"magicWand"===this.interactionMode},isAttaching:function(){return"attach"===this.interactionMode},hasSelectedLabel:function(){return Boolean(this.selectedLabel)},hasSelectedAnnotations:function(){return this.selectedAnnotations.length>0},hasLastCreatedAnnotation:function(){return null!==this.lastCreatedAnnotation},previousButtonTitle:function(){switch(this.annotationMode){case"volare":return"Previous annotation";case"lawnmower":return"Previous image section";case"randomSampling":case"regularSampling":return"Previous sample location";default:return"Previous image"}},nextButtonTitle:function(){switch(this.annotationMode){case"volare":return"Next annotation";case"lawnmower":return"Next image section";case"randomSampling":case"regularSampling":return"Next sample location";default:return"Next image"}}},methods:{updateMapSize:function(){this.mapSize=t.getSize()},updateMapView:function(t){var e=t.target.getView();this.$emit("moveend",{center:e.getCenter(),resolution:e.getResolution()})},invertPointsYAxis:function(t){for(var e=this.extent[3],n=1;n<t.length;n+=2)t[n]=e-t[n];return t},convertPointsFromOlToDb:function(t){return this.invertPointsYAxis(Array.prototype.concat.apply([],t))},convertPointsFromDbToOl:function(t){t=this.invertPointsYAxis(t.slice());for(var e=[],n=0;n<t.length;n+=2)e.push([t[n],t[n+1]||0]);return e},getGeometry:function(t){var e=this.convertPointsFromDbToOl(t.points);switch(t.shape){case"Point":return new ol.geom.Point(e[0]);case"Rectangle":return new ol.geom.Rectangle([e]);case"Polygon":return new ol.geom.Polygon([e]);case"LineString":return new ol.geom.LineString(e);case"Circle":return new ol.geom.Circle(e[0],e[1][0]);case"Ellipse":return new ol.geom.Ellipse([e]);default:return void console.error("Unknown annotation shape: "+t.shape)}},createFeature:function(t){var e=new ol.Feature(this.getGeometry(t));return e.setId(t.id),e.set("annotation",t),t.labels&&t.labels.length>0&&e.set("color",t.labels[0].label.color),e},handleFeatureModifyStart:function(t){t.features.forEach(function(t){l[t.getId()]=t.getRevision()})},handleFeatureModifyEnd:function(t){var e=this,n=t.features.getArray().filter(function(t){return l[t.getId()]!==t.getRevision()}).map(function(t){return{id:t.getId(),image_id:t.get("annotation").image_id,points:e.getPoints(t.getGeometry())}});n.length>0&&this.$emit("update",n)},focusAnnotation:function(e,n){var i=d.getFeatureById(e.id);i&&(n?delete this.viewFitOptions.duration:this.viewFitOptions.duration=250,t.getView().fit(i.getGeometry(),this.viewFitOptions))},fitImage:function(){t.getView().fit(this.extent,t.getSize())},extractAnnotationFromFeature:function(t){return t.get("annotation")},handleFeatureSelect:function(t){this.$emit("select",t.selected.map(this.extractAnnotationFromFeature),t.deselected.map(this.extractAnnotationFromFeature))},handlePrevious:function(){this.$emit("previous")},handleNext:function(){this.$emit("next")},resetInteractionMode:function(){this.interactionMode="default"},draw:function(t){this["isDrawing"+t]?this.resetInteractionMode():this.interactionMode="draw"+t},drawPoint:function(){this.draw("Point")},drawRectangle:function(){this.draw("Rectangle")},drawCircle:function(){this.draw("Circle")},drawLineString:function(){this.draw("LineString")},drawPolygon:function(){this.draw("Polygon")},drawEllipse:function(){this.draw("Ellipse")},getPoints:function(t){var e;switch(t.getType()){case"Circle":e=[t.getCenter(),[t.getRadius()]];break;case"Polygon":case"Rectangle":case"Ellipse":e=t.getCoordinates()[0];break;case"Point":e=[t.getCoordinates()];break;default:e=t.getCoordinates()}return this.convertPointsFromOlToDb(e)},handleNewFeature:function(t){if(this.hasSelectedLabel){var e=t.feature.getGeometry();t.feature.set("color",this.selectedLabel.color);var n=function(){try{d.removeFeature(t.feature)}catch(t){}};this.$emit("new",{shape:e.getType(),points:this.getPoints(e)},n)}else d.removeFeature(t.feature)},deleteSelectedAnnotations:function(){this.hasSelectedAnnotations&&confirm("Are you sure you want to delete all selected annotations?")&&this.$emit("delete",this.selectedAnnotations)},deleteLastCreatedAnnotation:function(){this.hasLastCreatedAnnotation&&this.$emit("delete",[this.lastCreatedAnnotation])},createPointAnnotationAt:function(t,e){if(this.hasSelectedLabel){var n=new ol.Feature(new ol.geom.Point([t,e]));d.addFeature(n),this.handleNewFeature({feature:n})}else this.requireSelectedLabel()},toggleTranslating:function(){this.isTranslating?this.resetInteractionMode():this.interactionMode="translate"},toggleAttaching:function(){this.isAttaching?this.resetInteractionMode():this.interactionMode="attach"},toggleMagicWand:function(){this.isMagicWanding?this.resetInteractionMode():r&&(this.interactionMode="magicWand")},handleAttachLabel:function(t){this.$emit("attach",t.feature.get("annotation"),this.selectedLabel)},requireSelectedLabel:function(){biigle.$require("events").$emit("sidebar.open","labels"),biigle.$require("messages.store").info("Please select a label first."),this.resetInteractionMode()},handleNewInteractionMode:function(l){if(i&&t.removeInteraction(i),n.setActive(!1),o.setActive(!1),a.setActive(!1),s.setActive(!1),r&&r.setActive(!1),this.isDrawing)this.hasSelectedLabel?(i=new ol.interaction.Draw({source:d,type:l.slice(4),style:e.editing}),i.on("drawend",this.handleNewFeature),t.addInteraction(i)):this.requireSelectedLabel();else if(this.isAttaching)this.hasSelectedLabel?s.setActive(!0):this.requireSelectedLabel();else if(this.isMagicWanding)this.hasSelectedLabel?r&&r.setActive(!0):this.requireSelectedLabel();else switch(l){case"translate":n.setActive(!0),a.setActive(!0);break;default:n.setActive(!0),o.setActive(!0)}this.showAnnotationTooltip&&(this.isDefaultInteractionMode?(t.on("pointermove",this.updateHoveredAnnotations),t.on("pointermove",this.updateMouseDomPosition)):(t.un("pointermove",this.updateHoveredAnnotations),t.un("pointermove",this.updateMouseDomPosition),this.resetHoveredAnnotations()))},render:function(){t&&t.render()},handleRegularImage:function(t,e){t?(e&&e.width===t.width&&e.height===t.height||h.setSource(new ol.source.Canvas({canvas:t.canvas,projection:this.projection,canvasExtent:this.extent,canvasSize:[t.width,t.height]})),this.isMagicWanding&&r.updateSnapshot()):h.setSource(null)},handleTiledImage:function(t,e){t?c.setSource(new ol.source.Zoomify({url:t.url,size:[t.width,t.height],extent:[0,0,t.width,t.height],transition:100})):c.setSource(null)}},watch:{image:function(e,n){e?!0===e.tiled?(n&&!0===n.tiled||(t.removeLayer(h),t.addLayer(c),r&&r.setLayer(c)),this.handleTiledImage(e,n)):(n&&!0!==n.tiled||(t.removeLayer(c),t.addLayer(h),r&&r.setLayer(h)),this.handleRegularImage(e,n)):(t.removeLayer(c),t.removeLayer(h))},annotations:function(t){var e={};t.forEach(function(t){e[t.id]=null});var n={},i=d.getFeatures(),o=i.filter(function(t){return n[t.getId()]=null,!e.hasOwnProperty(t.getId())});o.length===i.length?d.clear(!0):(o.filter(function(t){return void 0!==t.getId()}).forEach(function(t){d.removeFeature(t)}),t=t.filter(function(t){return!n.hasOwnProperty(t.id)})),d.addFeatures(t.map(this.createFeature)),this.resetHoveredAnnotations()},selectedAnnotations:function(t){var e=d,n=this.selectedFeatures;n.clear(),t.forEach(function(t){n.push(e.getFeatureById(t.id))})},extent:function(e,n){if(e[2]!==n[2]||e[3]!==n[3]){var i=ol.extent.getCenter(e);this.initialized||(i=this.center||i,this.initialized=!0);var o;this.image&&!0===this.image.tiled&&(o=c.getSource().getTileGrid().getResolutions()),t.setView(new ol.View({projection:this.projection,center:i,resolution:this.resolution,resolutions:o,zoomFactor:2,minResolution:.25,extent:e})),void 0===this.resolution&&t.getView().fit(e)}},selectedLabel:function(t){t||(this.isDrawing||this.isAttaching)&&this.resetInteractionMode()},annotationOpacity:function(t){g.setOpacity(t)}},created:function(){var i=this;e=biigle.$require("annotations.stores.styles"),t=biigle.$require("annotations.stores.map"),g.setStyle(e.features),t.addLayer(g),biigle.$require("events").$on("sidebar.toggle",function(){i.$nextTick(function(){t.updateSize()})}),t.on("change:size",this.updateMapSize),t.on("moveend",this.updateMapView),n=new ol.interaction.Select({condition:ol.events.condition.click,style:e.highlight,layers:[g],multi:!0}),n.on("select",this.handleFeatureSelect),t.addInteraction(n);var l=biigle.$require("keyboard");if(l.on(32,this.handleNext),l.on(39,this.handleNext),l.on(37,this.handlePrevious),l.on(27,this.resetInteractionMode),this.editable){o=new ol.interaction.Modify({features:n.getFeatures(),deleteCondition:function(t){return ol.events.condition.shiftKeyOnly(t)&&ol.events.condition.singleClick(t)}}),o.on("modifystart",this.handleFeatureModifyStart),o.on("modifyend",this.handleFeatureModifyEnd),t.addInteraction(o);var h=biigle.$require("annotations.ol.ExtendedTranslateInteraction");a=new h({features:n.getFeatures(),map:t}),a.setActive(!1),a.on("translatestart",this.handleFeatureModifyStart),a.on("translateend",this.handleFeatureModifyEnd),t.addInteraction(a);var c=biigle.$require("annotations.ol.AttachLabelInteraction");if(s=new c({features:u,map:t}),s.setActive(!1),s.on("attach",this.handleAttachLabel),t.addInteraction(s),this.crossOrigin)l.on("g",this.drawPolygon);else{var m=biigle.$require("annotations.ol.MagicWandInteraction");r=new m({map:t,source:d,style:e.editing,indicatorPointStyle:e.editing,indicatorCrossStyle:e.cross,simplifyTolerant:.1}),r.on("drawend",this.handleNewFeature),r.setActive(!1),t.addInteraction(r),l.on("g",function(t){t.shiftKey?i.toggleMagicWand():i.drawPolygon()})}l.on(46,this.deleteSelectedAnnotations),l.on(8,this.deleteLastCreatedAnnotation),l.on("a",this.drawPoint),l.on("s",this.drawRectangle),l.on("d",function(t){t.shiftKey?i.drawEllipse():i.drawCircle()}),l.on("f",this.drawLineString),l.on("m",this.toggleTranslating),l.on("l",this.toggleAttaching),this.$watch("interactionMode",this.handleNewInteractionMode)}},mounted:function(){t.setTarget(this.$el)}}}),biigle.$component("annotations.components.annotationModesTab",{components:{powerButton:biigle.$require("annotations.components.powerButton")},data:function(){return{mode:"default",defaults:{randomSamplingNumber:9,regularSamplingRows:3,regularSamplingColumns:3},randomSamplingNumber:9,regularSamplingRows:3,regularSamplingColumns:3}},computed:{keyboard:function(){return biigle.$require("keyboard")},isVolareActive:function(){return"volare"===this.mode},isLawnmowerActive:function(){return"lawnmower"===this.mode},isRandomSamplingActive:function(){return"randomSampling"===this.mode},isRegularSamplingActive:function(){return"regularSampling"===this.mode},settings:function(){return biigle.$require("annotations.stores.settings")}},methods:{startVolare:function(){this.mode="volare"},startLawnmower:function(){this.mode="lawnmower"},startRandomSampling:function(){this.mode="randomSampling"},startRegularSampling:function(){this.mode="regularSampling"},resetMode:function(){this.mode="default"},emitAttachLabel:function(){this.$emit("attach-label")},emitCreateSample:function(){this.$emit("create-sample")}},watch:{mode:function(t,e){switch(e){case"default":this.keyboard.on(27,this.resetMode);break;case"volare":this.keyboard.off(13,this.emitAttachLabel);break;case"randomSampling":case"regularSampling":this.keyboard.off(13,this.emitCreateSample)}switch(t){case"default":this.keyboard.off(27,this.resetMode);break;case"volare":this.keyboard.on(13,this.emitAttachLabel);break;case"randomSampling":case"regularSampling":this.keyboard.on(13,this.emitCreateSample)}switch(t){case"randomSampling":this.$emit("change",t,this.randomSamplingNumber);break;case"regularSampling":this.$emit("change",t,[this.regularSamplingRows,this.regularSamplingColumns]);break;default:this.$emit("change",t)}},randomSamplingNumber:function(t){t!==this.defaults.randomSamplingNumber?this.settings.set("randomSamplingNumber",t):this.settings.delete("randomSamplingNumber")},regularSamplingRows:function(t){t!==this.defaults.regularSamplingRows?this.settings.set("regularSamplingRows",t):this.settings.delete("regularSamplingRows")},regularSamplingColumns:function(t){t!==this.defaults.regularSamplingColumns?this.settings.set("regularSamplingColumns",t):this.settings.delete("regularSamplingColumns")}},created:function(){this.settings.restoreProperties(this,["randomSamplingNumber","regularSamplingRows","regularSamplingColumns"])}}),biigle.$component("annotations.components.annotationTooltip",{props:{annotations:{required:!0,type:Array},position:{required:!0,type:Array}},data:function(){return{delayPast:!1}},computed:{shown:function(){return this.annotations.length>0},styleObject:function(){return"transform: translate("+this.position[0]+"px,"+this.position[1]+"px);"}}}),biigle.$component("annotations.components.annotationsFilter",{components:{typeahead:biigle.$require("core.components.typeahead"),labelTypeahead:biigle.$require("labelTrees.components.labelTypeahead")},props:{annotations:{type:Array,required:!0}},data:function(){return{availableFilters:["label","user","shape","session"],selectedFilter:null,selectedData:null,active:!1}},computed:{typeaheadComponent:function(){return"label"===this.selectedFilter?"labelTypeahead":"typeahead"},placeholder:function(){return this.selectedFilter?this.selectedFilter+" name":"filter annotations"},labelData:function(){var t={},e=[];this.annotations.forEach(function(e){e.labels.forEach(function(e){t[e.label.id]=e.label})});for(var n in t)t.hasOwnProperty(n)&&e.push(t[n]);return e},userData:function(){var t={},e=[];this.annotations.forEach(function(e){e.labels.forEach(function(e){t[e.user.id]=e.user})});for(var n in t)t.hasOwnProperty(n)&&(t[n].name=t[n].firstname+" "+t[n].lastname,e.push(t[n]));return e},shapeData:function(){var t=biigle.$require("annotations.shapes"),e=[];for(var n in t)t.hasOwnProperty(n)&&e.push({id:parseInt(n,10),name:t[n]});return e},sessionData:function(){return biigle.$require("annotations.sessions").map(function(t){return t.starts_at=new Date(t.starts_at),t.ends_at=new Date(t.ends_at),t})},data:function(){return this.selectedFilter?this[this.selectedFilter+"Data"]||[]:[]},selectedDataName:function(){return this.selectedData?this.selectedData.name:""}},methods:{labelFilterFunction:function(t){return function(e){return e.labels.filter(function(e){return e.label.id===t.id}).length>0}},userFilterFunction:function(t){return function(e){return e.labels.filter(function(e){return e.user.id===t.id}).length>0}},shapeFilterFunction:function(t){return function(e){return e.shape_id===t.id}},sessionFilterFunction:function(t){var e={};return t.users.forEach(function(t){e[t.id]=null}),function(n){for(var i=n.labels.length-1;i>=0;i--)if(e.hasOwnProperty(n.labels[i].user.id)){var o=new Date(n.created_at);return o>=t.starts_at&&o<t.ends_at}return!1}},selectData:function(t){this.selectedData=t,this.activateFilter()},activateFilter:function(){this.selectedFilter&&this.selectedData&&(this.active=!0,this.$emit("filter",this[this.selectedFilter+"FilterFunction"](this.selectedData)))},deactivateFilter:function(){this.active=!1,this.selectedData=null,this.$emit("filter",null)}}}),biigle.$component("annotations.components.annotationsTab",{components:{labelItem:biigle.$require("annotations.components.annotationsTabItem"),annotationsFilter:biigle.$require("annotations.components.annotationsFilter")},props:{annotations:{type:Array,required:!0},filteredAnnotations:{type:Array,required:!0}},computed:{plugins:function(){return biigle.$require("annotations.components.annotationsTabPlugins")},items:function(){var t=[],e={};return this.filteredAnnotations.forEach(function(n){n.labels.forEach(function(i){var o={annotation:n,annotationLabel:i};e.hasOwnProperty(i.label.id)?e[i.label.id].push(o):(e[i.label.id]=[o],t.push(i.label))})}),t.sort(this.sortByName).map(function(t){return{label:t,annotations:e[t.id]}})}},methods:{sortByName:function(t,e){return t.name.toLowerCase()>e.name.toLowerCase()?1:-1},reallyScrollIntoView:function(t){var e,n=this.$refs.scrollList,i=n.scrollTop,o=n.offsetHeight,a=1/0,s=0;t.forEach(function(t){for(var i=n.querySelectorAll('[data-annotation-id="'+t.id+'"]'),o=i.length-1;o>=0;o--)e=i[o],a=Math.min(e.offsetTop,a),s=Math.max(e.offsetTop+e.offsetHeight,s)},this),i>a?n.scrollTop=a:i+o<s&&(n.scrollTop=o>=s-a?s-n.offsetHeight:a)},scrollIntoView:function(t){0!==t.length&&this.$nextTick(function(){this.reallyScrollIntoView(t)})},keepElementPosition:function(t){var e=this.$refs.scrollList,n=t.offsetTop-e.scrollTop;this.$nextTick(function(){this.$nextTick(function(){var i=t.offsetTop-e.scrollTop;e.scrollTop+=i-n})})},bubbleFilter:function(t){this.$emit("filter",t)}}}),biigle.$declare("annotations.components.annotationsTabPlugins",{}),biigle.$component("annotations.components.annotationsTabItem",{components:{annotationItem:biigle.$require("annotations.components.annotationsTabSubItem")},props:{item:{type:Object,required:!0}},data:function(){return{isOpen:!1}},computed:{label:function(){return this.item.label},annotationItems:function(){return this.item.annotations},count:function(){return this.annotationItems.length},hasSelectedAnnotation:function(){for(var t=this.annotationItems,e=t.length-1;e>=0;e--)if(!0===t[e].annotation.selected)return!0;return!1},isSelected:function(){return this.isOpen||this.hasSelectedAnnotation},classObject:function(){return{selected:this.isSelected}},colorStyle:function(){return{"background-color":"#"+this.label.color}},title:function(){return"List all annotations with label "+this.label.name},countTitle:function(){return"There are "+this.count+" annotations with this label"}},methods:{toggleOpen:function(){this.isOpen=!this.isOpen},bubbleSelect:function(t){this.$emit("select",t)}}}),biigle.$component("annotations.components.annotationsTabSubItem",{props:{item:{type:Object,required:!0},userId:{type:Number,required:!0}},computed:{annotation:function(){return this.item.annotation},label:function(){return this.item.annotationLabel},isSelected:function(){return this.annotation.selected},classObject:function(){return{selected:this.isSelected}},shapeClass:function(){return"icon-"+this.annotation.shape.toLowerCase()},username:function(){
return this.label.user?this.label.user.firstname+" "+this.label.user.lastname:"(user deleted)"},canBeDetached:function(){return this.label.user&&this.label.user.id===this.userId},events:function(){return biigle.$require("events")}},methods:{toggleSelect:function(t){this.$emit("select",this.$el),this.isSelected?this.events.$emit("annotations.deselect",this.annotation,t):this.events.$emit("annotations.select",this.annotation,t)},focus:function(){this.events.$emit("annotations.focus",this.annotation)},detach:function(){this.annotation.labels.length>1?this.events.$emit("annotations.detachLabel",this.annotation,this.label):confirm("Detaching the last label will delete the annotation. Proceed?")&&this.events.$emit("annotations.delete",this.annotation)}}}),biigle.$component("annotations.components.colorAdjustmentTab",{data:function(){return{isBrightnessRgbActive:!1,colorAdjustment:{brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]}}},methods:{resetType:function(t,e){void 0!==e?this.colorAdjustment[t].splice(e,1,0):this.colorAdjustment[t]=this.colorAdjustment[t].map(function(){return 0})},reset:function(){for(var t in this.colorAdjustment)this.colorAdjustment.hasOwnProperty(t)&&this.resetType(t)},toggleBrightnessRgb:function(){this.isBrightnessRgbActive?this.resetType("brightnessRGB"):this.resetType("brightnessContrast",0),this.isBrightnessRgbActive=!this.isBrightnessRgbActive}},watch:{colorAdjustment:{handler:function(){this.$emit("change",this.colorAdjustment)},deep:!0}}}),biigle.$component("annotations.components.controlButton",{template:'<span class="control-button btn" :title="title" :class="classObject" @click="handleClick" @mouseenter="handleMouseEnter" @mouseleave="handleMouseLeave"><i :class="iconClass" aria-hidden="true"></i><span v-if="hasSubControls" @click.stop class="control-button__sub-controls btn-group"><slot></slot></span></span>',props:{title:{type:String,default:""},icon:{type:String,required:!0},active:{type:Boolean,default:!1}},data:function(){return{mouseOver:!1,timeout:null,activeSubControls:0}},computed:{classObject:function(){return{active:this.active,"control-button--open":this.showSubControls}},iconClass:function(){return this.icon.startsWith("glyphicon-")?"glyphicon "+this.icon:this.icon.startsWith("fa-")?"fa "+this.icon:"icon icon-white "+this.icon},hasSubControls:function(){return this.$slots.hasOwnProperty("default")},showSubControls:function(){return this.mouseOver||this.hasActiveSubControl},hasActiveSubControl:function(){return this.activeSubControls>0}},methods:{handleClick:function(){this.$emit("click")},handleMouseEnter:function(){this.mouseOver=!0,window.clearTimeout(this.timeout)},handleMouseLeave:function(){var t=this;window.clearTimeout(this.timeout),this.timeout=window.setTimeout(function(){t.mouseOver=!1},200)},updateActiveSubControls:function(t){t?this.activeSubControls++:this.activeSubControls--}},watch:{active:function(t){this.$parent.$emit("control-button-active",t)}},created:function(){this.$on("control-button-active",this.updateActiveSubControls)}}),biigle.$component("annotations.components.imageLabelTab",{mixins:[biigle.$require("core.mixins.loader")],components:{imageLabelList:biigle.$require("volumes.components.imageLabelList")},props:{imageId:{required:!0,type:Number},selectedLabel:{type:Object,default:null}},data:function(){return{cache:{},open:!1,currentLabels:[],saving:!1}},computed:{userId:function(){return biigle.$require("annotations.userId")},isAdmin:function(){return biigle.$require("annotations.isAdmin")},imageLabelApi:function(){return biigle.$require("api.imageLabels")},hasLabels:function(){return this.currentLabels.length>0},hasSelectedLabel:function(){return null!==this.selectedLabel},canAttachSelectedLabel:function(){if(this.hasSelectedLabel){for(var t=this.currentLabels.length-1;t>=0;t--)if(this.currentLabels[t].label.id===this.selectedLabel.id)return!1;return!0}return!1},proposedLabelTitle:function(){return this.hasSelectedLabel?this.canAttachSelectedLabel?"Attach '"+this.selectedLabel.name+"' as new image label":"The selected label is already attached.":"Please select a label first."}},methods:{startSaving:function(){this.saving=!0},finishSaving:function(){this.saving=!1},showImageLabels:function(t){this.cache.hasOwnProperty(t)||(this.startLoading(),this.currentLabels=[],this.cache[t]=this.imageLabelApi.query({image_id:t}),this.cache[t].finally(this.finishLoading)),this.cache[t].then(this.updateCurrentLabels,biigle.$require("messages.store").handleErrorResponse)},updateCurrentLabels:function(t){this.currentLabels=t.body},handleDeletedLabel:function(t){for(var e=this.currentLabels.length-1;e>=0;e--)if(this.currentLabels[e].id===t.id){this.currentLabels.splice(e,1);break}},attachSelectedLabel:function(){this.startSaving();var t=this.currentLabels;this.imageLabelApi.save({image_id:this.imageId},{label_id:this.selectedLabel.id}).then(function(e){t.push(e.data)},biigle.$require("messages.store").handleErrorResponse).finally(this.finishSaving)}},watch:{imageId:function(t){this.open&&this.showImageLabels(t)},open:function(t){t&&this.showImageLabels(this.imageId)}},created:function(){var t=this;this.$parent.$watch("open",function(e){t.open=e})}}),biigle.$component("annotations.components.labelIndicator",{props:{label:{required:!0}}}),biigle.$component("annotations.components.labelsTab",{components:{labelTrees:biigle.$require("labelTrees.components.labelTrees")},data:function(){return{labelTrees:biigle.$require("annotations.labelTrees"),selectedLabel:null}},computed:{plugins:function(){return biigle.$require("annotations.components.labelsTabPlugins")}},methods:{handleSelectedLabel:function(t){this.selectedLabel=t,this.$emit("select",t)},handleDeselectedLabel:function(t){this.selectedLabel=null,this.$emit("select",null)}}}),biigle.$declare("annotations.components.labelsTabPlugins",{}),biigle.$component("annotations.components.minimap",function(){var t=!1,e=new ol.Map({controls:[],interactions:[]}),n=new ol.source.Vector,i=new ol.Feature;n.addFeature(i);var o,a;return{props:{extent:{type:Array,required:!0},projection:{type:Object,required:!0}},computed:{intendedWidth:function(){return this.$el.clientWidth},intendedHeight:function(){return this.$el.clientHeight}},methods:{updateViewport:function(){i.setGeometry(ol.geom.Polygon.fromExtent(o.calculateExtent(a)))},dragViewport:function(t){o.setCenter(t.coordinate)},updateMapSize:function(t){a=t.target.getSize()},updateMapView:function(t){o=t.target.getView()},updateElementSize:function(){var t=this.extent[2],n=this.extent[3],i=Math.max(t/this.intendedWidth,n/this.intendedHeight);e.setView(new ol.View({projection:this.projection,center:ol.extent.getCenter(this.extent),resolution:i})),this.$el.style.width=Math.round(t/i)+"px",this.$el.style.height=Math.round(n/i)+"px",e.updateSize()},refreshImageLayer:function(t){var n=e.getLayers();n.getLength()>1?n.setAt(0,t.target.item(t.target.getLength()-1)):n.insertAt(0,t.target.item(t.target.getLength()-1))}},created:function(){if(!t){t=!0;var i=biigle.$require("annotations.stores.map");a=i.getSize(),o=i.getView(),i.on("postcompose",this.updateViewport),i.on("change:size",this.updateMapSize),i.on("change:view",this.updateMapView),e.addLayer(new ol.layer.Vector({source:n,style:biigle.$require("annotations.stores.styles").viewport})),i.getLayers().on("add",this.refreshImageLayer),e.on("pointerdrag",this.dragViewport),e.on("click",this.dragViewport)}},watch:{extent:function(){this.updateElementSize()}},mounted:function(){e.setTarget(this.$el),this.updateElementSize()}}}),biigle.$component("annotations.components.mousePositionIndicator",{props:{position:{required:!0}},computed:{positionText:function(){return this.position[0]+" × "+this.position[1]}}}),biigle.$component("annotations.components.powerButton",{template:'<span class="power-button"><button type="button" class="btn btn-default" :class="objectClass" @click="handleClick" :title="currentTitle"><i class="fa fa-power-off"></i></button><span v-if="label" class="power-button__label" v-text="label"></span></span>',props:{active:{type:Boolean,required:!0},title:{type:String,default:""},titleOn:{type:String,default:""},titleOff:{type:String,default:""}},computed:{currentTitle:function(){return this.active?this.titleOn||this.title:this.titleOff||this.title},label:function(){return this.$slots.default?this.$slots.default[0].text:""},objectClass:function(){return{active:this.active,"btn-info":this.active}}},methods:{handleClick:function(){this.active?this.$emit("off"):this.$emit("on")}}}),biigle.$component("annotations.components.scaleLineIndicator",{props:{image:{required:!0},resolution:{required:!0},areas:{required:!0}},data:function(){return{targetWidth:100,leadingDigits:[1,2,5],unitMultipliers:[1e3,1,.01,.001,1e-6,1e-9],unitNames:["km","m","cm","mm","µm","nm"]}},computed:{area:function(){return this.areas&&this.image&&this.areas.hasOwnProperty(this.image.id)?this.areas[this.image.id]:-1},hasArea:function(){return-1!==this.area},pxWidthInMeter:function(){return Math.sqrt(this.area/(this.image.width*this.image.height))},scaleMultiplier:function(){return this.hasArea?this.resolution*this.pxWidthInMeter:this.resolution},scale:function(){return this.targetWidth*this.scaleMultiplier},powerOfTen:function(){return Math.pow(10,Math.floor(Math.log10(this.scale)))},scaleNearest:function(){for(var t=0,e=1/0,n=this.leadingDigits.length-1;n>=0;n--){var i=this.leadingDigits[n]*this.powerOfTen;Math.abs(this.scale-i)<e&&(t=n,e=Math.abs(this.scale-i))}return this.leadingDigits[t]*this.powerOfTen},unitNearest:function(){for(var t=0,e=1/0,n=this.unitMultipliers.length-1;n>=0;n--)Math.abs(this.unitMultipliers[n]-this.powerOfTen)<e&&(t=n,e=Math.abs(this.unitMultipliers[n]-this.powerOfTen));return t},width:function(){return Math.round(this.scaleNearest/this.scaleMultiplier)},styleObject:function(){return{width:this.width+"px"}},text:function(){return this.hasArea?this.scaleNearest/this.unitMultipliers[this.unitNearest]+" "+this.unitNames[this.unitNearest]:this.scaleNearest+" px"}}}),biigle.$component("annotations.components.screenshotButton",{mixins:[biigle.$require("annotations.mixins.imageFilenameTracker")],computed:{map:function(){return biigle.$require("annotations.stores.map")},messages:function(){return biigle.$require("messages.store")},screenshotSupported:function(){return!biigle.$require("annotations.volumeIsRemote")},screenshotTitle:function(){return this.screenshotSupported?"Get a screenshot of the visible area":"Screenshots are not available for remote images"},filename:function(){if(this.currentImageFilename){var t=this.currentImageFilename.split(".");return t.length>1&&(t[t.length-1]="png"),"biigle_screenshot_"+(t=t.join(".").toLowerCase())}return"biigle_screenshot.png"}},methods:{trimCanvas:function(t){var e,n,i,o=t.getContext("2d"),a=document.createElement("canvas").getContext("2d"),s=o.getImageData(0,0,t.width,t.height),r=s.data.length,l={top:null,left:null,right:null,bottom:null};for(e=0;e<r;e+=4)0!==s.data[e+3]&&(n=e/4%t.width,i=~~(e/4/t.width),null===l.top&&(l.top=i),null===l.left?l.left=n:n<l.left&&(l.left=n),null===l.right?l.right=n:l.right<n&&(l.right=n),null===l.bottom?l.bottom=i:l.bottom<i&&(l.bottom=i));var h=l.bottom-l.top,c=l.right-l.left,u=o.getImageData(l.left,l.top,c,h);return a.canvas.width=c,a.canvas.height=h,a.putImageData(u,0,0),a.canvas},makeBlob:function(t){try{t=this.trimCanvas(t)}catch(t){return Vue.Promise.reject("Could not create screenshot. Maybe the image is not loaded yet?")}var e="image/png";if(HTMLCanvasElement.prototype.toBlob)return new Vue.Promise(function(n){t.toBlob(n,e)});for(var n=atob(t.toDataURL(e).split(",")[1]),i=n.length,o=new Uint8Array(i),a=0;a<i;a++)o[a]=n.charCodeAt(a);return new Vue.Promise(function(t){t(new Blob([o],{type:e}))})},download:function(t){var e=document.createElement("a");e.style="display: none",e.download=this.filename,e.href=URL.createObjectURL(t),document.body.appendChild(e),e.click(),window.setTimeout(function(){document.body.removeChild(e),URL.revokeObjectURL(e.href)},100)},capture:function(){var t=this;this.map.once("postcompose",function(e){t.makeBlob(e.context.canvas).then(t.download).catch(t.handleError)}),this.map.renderSync()},handleError:function(t){this.messages.danger(t)}}}),biigle.$component("annotations.components.settingsTab",{components:{screenshotButton:biigle.$require("annotations.components.screenshotButton"),powerButton:biigle.$require("annotations.components.powerButton")},data:function(){return{annotationOpacity:1,mousePosition:!1,zoomLevel:!1,scaleLine:!1,annotationTooltip:!1,minimap:!0}},computed:{settings:function(){return biigle.$require("annotations.stores.settings")},plugins:function(){return biigle.$require("annotations.components.settingsTabPlugins")}},methods:{showMousePosition:function(){this.mousePosition=!0},hideMousePosition:function(){this.mousePosition=!1},showZoomLevel:function(){this.zoomLevel=!0},hideZoomLevel:function(){this.zoomLevel=!1},showScaleLine:function(){this.scaleLine=!0},hideScaleLine:function(){this.scaleLine=!1},showAnnotationTooltip:function(){this.annotationTooltip=!0},hideAnnotationTooltip:function(){this.annotationTooltip=!1},showMinimap:function(){this.minimap=!0},hideMinimap:function(){this.minimap=!1}},watch:{annotationOpacity:function(t){t=parseFloat(t),1===t?this.settings.delete("annotationOpacity"):this.settings.set("annotationOpacity",t),this.$emit("change","annotationOpacity",t)},mousePosition:function(t){t?this.settings.set("mousePosition",!0):this.settings.delete("mousePosition"),this.$emit("change","mousePosition",t)},zoomLevel:function(t){t?this.settings.set("zoomLevel",!0):this.settings.delete("zoomLevel"),this.$emit("change","zoomLevel",t)},scaleLine:function(t){t?this.settings.set("scaleLine",!0):this.settings.delete("scaleLine"),this.$emit("change","scaleLine",t)},annotationTooltip:function(t){t?this.settings.set("annotationTooltip",!0):this.settings.delete("annotationTooltip"),this.$emit("change","annotationTooltip",t)},minimap:function(t){t?this.settings.delete("minimap"):this.settings.set("minimap",!1),this.$emit("change","minimap",t)}},created:function(){this.settings.restoreProperties(this,["annotationOpacity","mousePosition","zoomLevel","scaleLine","annotationTooltip","minimap"])}}),biigle.$declare("annotations.components.settingsTabPlugins",{}),biigle.$component("annotations.components.sidebar",{mixins:[biigle.$require("core.components.sidebar")],created:function(){var t=this;biigle.$require("events").$on("sidebar.open",function(e){t.$emit("open",e)})}}),biigle.$component("annotations.components.zoomLevelIndicator",{props:{resolution:{required:!0}},computed:{zoomLevelText:function(){return(Math.round(100/this.resolution)/100||0)+"x"}}}),biigle.$component("annotations.mixins.imageFilenameTracker",{data:function(){return{filenameMap:{},currentImageId:null,defaultFilename:""}},computed:{currentImageFilename:function(){return this.filenameMap[this.currentImageId]||this.defaultFilename}},methods:{updateImageId:function(t){this.currentImageId=t}},created:function(){var t=biigle.$require("events"),e=biigle.$require("annotations.imagesIds"),n=biigle.$require("annotations.imagesFilenames"),i=this.filenameMap;e.forEach(function(t,e){i[t]=n[e]}),t.$on("images.change",this.updateImageId)}}),biigle.$declare("annotations.ol.AttachLabelInteraction",function(){function t(t){ol.interaction.Pointer.call(this,{handleUpEvent:this.handleUpEvent,handleDownEvent:this.handleDownEvent,handleMoveEvent:this.handleMoveEvent}),this.on("change:active",this.toggleActive),this.features=void 0!==t.features?t.features:null,this.currentFeature=void 0,this.map=t.map}return ol.inherits(t,ol.interaction.Pointer),t.prototype.toggleActive=function(t){if(t.oldValue){var e=this.map.getTargetElement();e&&(e.style.cursor="")}},t.prototype.handleDownEvent=function(t){return this.currentFeature=this.featuresAtPixel(t.pixel,t.map),!!this.currentFeature},t.prototype.handleUpEvent=function(t){this.currentFeature&&this.currentFeature.get("annotation")&&this.dispatchEvent({type:"attach",feature:this.currentFeature}),this.currentFeature=void 0},t.prototype.handleMoveEvent=function(t){var e=t.map.getTargetElement(),n=this.featuresAtPixel(t.pixel,t.map);e.style.cursor=n?"pointer":""},t.prototype.featuresAtPixel=function(t,e){var n=null,i=e.forEachFeatureAtPixel(t,function(t){return t},this);return this.handlesFeature(i)&&(n=i),n},t.prototype.handlesFeature=function(t){return!!this.features&&-1!==this.features.getArray().indexOf(t)},t}),biigle.$declare("annotations.ol.ExtendedTranslateInteraction",function(){function t(t){ol.interaction.Translate.call(this,t),this.features=void 0!==t.features?t.features:null,this.on("change:active",this.toggleListeners);var e=this;this.translateUp=function(){return e.translate(0,1)},this.translateDown=function(){return e.translate(0,-1)},this.translateLeft=function(){return e.translate(-1,0)},this.translateRight=function(){return e.translate(1,0)},this.keyboard=biigle.$require("keyboard"),this.utils=biigle.$require("annotations.stores.utils"),this.setMap(t.map),this.translating=!1}return ol.inherits(t,ol.interaction.Translate),t.prototype.toggleListeners=function(t){if(t.oldValue){this.keyboard.off(37,this.translateLeft),this.keyboard.off(38,this.translateUp),this.keyboard.off(39,this.translateRight),this.keyboard.off(40,this.translateDown);var e=this.getMap().getTargetElement();e&&(e.style.cursor="")}else this.keyboard.on(37,this.translateLeft,10),this.keyboard.on(38,this.translateUp,10),this.keyboard.on(39,this.translateRight,10),this.keyboard.on(40,this.translateDown,10)},t.prototype.translate=function(t,e){if(this.features&&this.features.getLength()>0){this.translating||(this.dispatchEvent({type:"translatestart",features:this.features}),this.translating=!0),this.features.forEach(function(n){var i=n.getGeometry();i.translate(t,e),n.setGeometry(i)});var n=this,i=function(){n.translating=!1,n.dispatchEvent({type:"translateend",features:n.features})};return this.utils.debounce(i,500,"ol.interactions.Translate.translateend"),!1}return!0},t}),biigle.$declare("annotations.ol.MagicWandInteraction",function(){function t(t){ol.interaction.Pointer.call(this,{handleUpEvent:this.handleUpEvent,handleDownEvent:this.handleDownEvent,handleMoveEvent:this.handleMoveEvent,handleDragEvent:this.handleDragEvent}),this.on("change:active",this.toggleActive),this.layer=t.layer,this.colorThreshold=void 0===t.colorThreshold?15:t.colorThreshold,this.currentThreshold=this.colorThreshold,this.blurRadius=void 0===t.blurRadius?5:t.blurRadius,this.simplifyTolerant=void 0===t.simplifyTolerant?0:t.simplifyTolerant,this.simplifyCount=void 0===t.simplifyCount?3:t.simplifyCount,this.downPoint=[0,0],this.map=t.map,this.snapshotCanvas=document.createElement("canvas"),this.snapshotContext=this.snapshotCanvas.getContext("2d"),this.snapshot=null,this.updatingSnapshot=!1,this.discardRadius=void 0===t.discardRadius?20:t.discardRadius,this.sketchFeature=null,this.sketchSource=t.source,void 0===this.sketchSource&&(this.sketchSource=new ol.source.Vector,this.map.addLayer(new ol.layer.Vector({source:this.sketchSource,zIndex:200}))),this.sketchStyle=void 0===t.style?null:t.style,this.isShowingPoint=!1,this.indicatorPoint=new ol.Feature(new ol.geom.Point([20,20])),void 0!==t.indicatorPointStyle&&this.indicatorPoint.setStyle(t.indicatorPointStyle),this.isShowingCross=!1,this.indicatorCross=new ol.Feature(new ol.geom.Point([100,100])),void 0!==t.indicatorCrossStyle?this.indicatorCross.setStyle(t.indicatorCrossStyle):this.indicatorCross.setStyle([new ol.style.Style({image:new ol.style.RegularShape({stroke:new ol.style.Stroke({color:[0,153,255,1],width:3}),points:4,radius1:6,radius2:0,angle:Math.PI/4})}),new ol.style.Style({image:new ol.style.RegularShape({stroke:new ol.style.Stroke({color:[255,255,255,.75],width:1.5}),points:4,radius1:6,radius2:0,angle:Math.PI/4})})]),this.indicatorSource=new ol.source.Vector,this.map.addLayer(new ol.layer.Vector({source:this.indicatorSource,zIndex:200})),this.toggleActive()}return ol.inherits(t,ol.interaction.Pointer),t.prototype.getHighDpiScaling=function(){return this.snapshot.height/this.map.getSize()[1]},t.prototype.toSnapshotCoordinates=function(t){var e=this.map.getView().calculateExtent(this.map.getSize()),n=this.snapshot.height,i=this.getHighDpiScaling()/this.map.getView().getResolution();return t.map(function(t){return[Math.round((t[0]-e[0])*i),n-Math.round((t[1]-e[1])*i)]})},t.prototype.fromSnapshotCoordinates=function(t){var e=this.map.getView().calculateExtent(this.map.getSize()),n=this.snapshot.height,i=this.map.getView().getResolution()/this.getHighDpiScaling();return t.map(function(t){return[Math.round(t[0]*i+e[0]),Math.round((n-t[1])*i+e[1])]})},t.prototype.fromMagicWandCoordinates=function(t){return t.map(function(t){return[t.x,t.y]})},t.prototype.handleUpEvent=function(t){return this.currentThreshold=this.colorThreshold,this.isShowingCross?this.sketchSource.removeFeature(this.sketchFeature):this.dispatchEvent({type:"drawend",feature:this.sketchFeature}),this.sketchFeature=null,this.indicatorSource.clear(),this.isShowingPoint=!1,this.isShowingCross=!1,!1},t.prototype.handleDownEvent=function(t){return this.downPoint[0]=Math.round(t.coordinate[0]),this.downPoint[1]=Math.round(t.coordinate[1]),this.drawSketch(),this.indicatorPoint.getGeometry().setCoordinates(this.downPoint),this.indicatorCross.getGeometry().setCoordinates(this.downPoint),this.indicatorSource.clear(),this.indicatorSource.addFeature(this.indicatorCross),this.isShowingCross=!0,this.isShowingPoint=!1,!0},t.prototype.handleDragEvent=function(t){var e=this.toSnapshotCoordinates([t.coordinate]).shift(),n=Math.round(e[0]),i=Math.round(e[1]),o=this.toSnapshotCoordinates([this.downPoint]).shift(),a=o[0],s=o[1];if(n!==a||i!==s){var r=n-a,l=i-s,h=Math.sqrt(r*r+l*l);h<=this.discardRadius?this.isShowingCross||(this.indicatorSource.clear(),this.indicatorSource.addFeature(this.indicatorCross),this.isShowingCross=!0,this.isShowingPoint=!1):this.isShowingPoint||(this.indicatorSource.clear(),this.indicatorSource.addFeature(this.indicatorPoint),this.isShowingCross=!1,this.isShowingPoint=!0);var c=Math.min(Math.max(this.colorThreshold+Math.round(h/2-this.colorThreshold),1),255);c!=this.currentThreshold&&(this.currentThreshold=c,this.drawSketch())}},t.prototype.handleMoveEvent=function(t){this.isShowingPoint||(this.indicatorSource.clear(),this.indicatorSource.addFeature(this.indicatorPoint),this.isShowingPoint=!0,this.isShowingCross=!1),this.indicatorPoint.getGeometry().setCoordinates(t.coordinate)},t.prototype.toggleActive=function(){this.getActive()?(this.map.on(["moveend","change:size"],this.updateSnapshot,this),this.updateSnapshot()):(this.map.un(["moveend","change:size"],this.updateSnapshot,this),this.indicatorSource.clear(),this.isShowingPoint=!1,this.isShowingCross=!1,this.sketchFeature&&(this.sketchSource.removeFeature(this.sketchFeature),this.sketchFeature=null))},t.prototype.updateSnapshot=function(){!this.updatingSnapshot&&this.layer&&(this.layer.once("postcompose",function(t){this.snapshotCanvas.width=t.context.canvas.width,this.snapshotCanvas.height=t.context.canvas.height,this.snapshotContext.drawImage(t.context.canvas,0,0),this.snapshot=this.snapshotContext.getImageData(0,0,this.snapshotCanvas.width,this.snapshotCanvas.height),this.snapshot.bytes=4},this),this.updatingSnapshot=!0,this.map.renderSync(),this.updatingSnapshot=!1)},t.prototype.setLayer=function(t){this.layer=t},t.prototype.drawSketch=function(){var t=this.toSnapshotCoordinates([this.downPoint]).shift(),e=MagicWand.floodFill(this.snapshot,t[0],t[1],this.currentThreshold);this.blurRadius>0&&(e=MagicWand.gaussBlurOnlyBorder(e,this.blurRadius));for(var n=e.data,i=this.snapshot.data,o=n.length-1;o>=0;o--)0===i[4*o]&&(n[o]=0);var a=MagicWand.traceContours(e).filter(function(t){return!t.innner}).shift();if(a){this.simplifyTolerant>0&&(a=MagicWand.simplifyContours([a],this.simplifyTolerant,this.simplifyCount).shift());var s=this.fromSnapshotCoordinates(this.fromMagicWandCoordinates(a.points));this.sketchFeature?this.sketchFeature.getGeometry().setCoordinates([s]):(this.sketchFeature=new ol.Feature(new ol.geom.Polygon([s])),this.sketchStyle&&this.sketchFeature.setStyle(this.sketchStyle),this.sketchSource.addFeature(this.sketchFeature))}},t}),biigle.$declare("annotations.ol.ZoomToNativeControl",function(){function t(t){var e=t||{},n=e.label?e.label:"1",i=document.createElement("button"),o=this;i.innerHTML=n,i.title="Zoom to original resolution",i.addEventListener("click",function(){o.zoomToNative.call(o)});var a=document.createElement("div");a.className="zoom-to-native ol-unselectable ol-control",a.appendChild(i),ol.control.Control.call(this,{element:a,target:e.target}),this.duration_=void 0!==e.duration?e.duration:250}return ol.inherits(t,ol.control.Control),t.prototype.zoomToNative=function(){var t=this.getMap(),e=t.getView();if(e){e.getResolution()&&(this.duration_>0?e.animate({resolution:e.constrainResolution(1),duration:this.duration_}):e.setResolution(e.constrainResolution(1)))}},t}),biigle.$declare("annotations.stores.annotations",function(){var t=(biigle.$require("events"),biigle.$require("api.images")),e=biigle.$require("api.annotations");return new Vue({data:{cache:{}},computed:{imageFileUri:function(){return biigle.$require("annotations.imageFileUri")},shapeMap:function(){return biigle.$require("annotations.shapes")},inverseShapeMap:function(){var t={};for(var e in this.shapeMap)t[this.shapeMap[e]]=parseInt(e,10);return t}},methods:{parseResponse:function(t){return t.data},resolveShape:function(t){return t.shape=this.shapeMap[t.shape_id],t},resolveAllShapes:function(t){return t.forEach(this.resolveShape,this),t},setDeselected:function(t){return t.selected=!1,t},setAllDeselected:function(t){return t.forEach(this.setDeselected),t},fetchAnnotations:function(e){return this.cache.hasOwnProperty(e)||(this.cache[e]=t.getAnnotations({id:e}).catch(function(){return Vue.Promise.reject("Failed to load annotations for image "+e+"!")}).then(this.parseResponse).then(this.resolveAllShapes)),this.cache[e].then(this.setAllDeselected)},create:function(e,n){n.shape_id=this.inverseShapeMap[n.shape],delete n.shape;var i=this;return t.saveAnnotations({id:e},n).then(this.parseResponse).then(this.resolveShape).then(this.setDeselected).then(function(t){return i.cache[e].then(function(e){e.unshift(t)}),t})},update:function(t){var n=this,i=e.update({id:t.id},{points:t.points});return i.then(function(){n.cache[t.image_id].then(function(e){for(var n=e.length-1;n>=0;n--)if(e[n].id===t.id)return void(e[n].points=t.points)})}),i},attachLabel:function(t,n){var i=e.attachLabel({id:t.id},n);return i.then(function(e){t.labels.unshift(e.data)}),i},detachLabel:function(t,n){var i=e.detachLabel({annotation_label_id:n.id});return i.then(function(){for(var e=t.labels.length-1;e>=0;e--)if(t.labels[e].id===n.id)return void t.labels.splice(e,1)}),i},delete:function(t){var n=e.delete({id:t.id}),i=this.cache[t.image_id];return n.then(function(){i.then(function(e){for(var n=e.length-1;n>=0;n--)if(e[n].id===t.id)return void e.splice(n,1)})}),n}}})}),biigle.$declare("annotations.stores.images",function(){var t,e=biigle.$require("events"),n=document.createElement("canvas");if(window.hasOwnProperty("fx"))try{t=fx.canvas();var i=null,o=null}catch(t){console.log("WebGL not supported. Color adjustment disabled.")}return window.addEventListener("beforeunload",function(e){i&&(i.destroy(),t.width=1,t.height=1)}),new Vue({data:{cache:{},cachedIds:[],maxCacheSize:10,supportsColorAdjustment:!1,currentlyDrawnImage:null,colorAdjustment:{brightnessContrast:[0,0],brightnessRGB:[0,0,0],hueSaturation:[0,0],vibrance:[0]}},computed:{imageFileUri:function(){return biigle.$require("annotations.imageFileUri")},tilesUri:function(){return biigle.$require("annotations.tilesUri")},supportedTextureSize:function(){return t?t._.gl.getParameter(t._.gl.MAX_TEXTURE_SIZE):0},isRemoteVolume:function(){return biigle.$require("annotations.volumeIsRemote")},hasColorAdjustment:function(){for(var t in this.colorAdjustment)if(this.colorAdjustment.hasOwnProperty(t)&&this.isAdjustmentActive(t))return!0;return!1}},methods:{isTiledImage:function(t){return!0===t.tiled},isAdjustmentActive:function(t){return 0!==this.colorAdjustment[t].reduce(function(t,e){return t+e})},checkSupportsColorAdjustment:function(e){if(!t||this.isRemoteVolume)return!1;if(this.isTiledImage(e))return void(this.supportsColorAdjustment=!1);if(this.currentlyDrawnImage&&this.currentlyDrawnImage.width===e.width&&this.currentlyDrawnImage.height===e.height)return this.supportsColorAdjustment;var n=this.supportedTextureSize;return n<e.width||n<e.height?(console.log("Insufficient WebGL texture size. Required: "+e.width+"x"+e.height+", available: "+n+"x"+n+". Color adjustment disabled."),void(this.supportsColorAdjustment=!1)):(t.width=e.width,t.height=e.height,e.width!==t._.gl.drawingBufferWidth||e.height!==t._.gl.drawingBufferHeight?(console.log("Your browser does not allow a WebGL drawing buffer with the size of the original image. Color adjustment disabled."),void(this.supportsColorAdjustment=!1)):void(this.supportsColorAdjustment=!0))},createImage:function(t){var e=this,i=document.createElement("img"),o=new Vue.Promise(function(e,o){i.onload=function(){e({id:t,source:i,width:i.width,height:i.height,canvas:n})},i.onerror=function(){o("Failed to load image "+t+"!")}});return this.isRemoteVolume?(i.src=this.imageFileUri.replace("{id}",t),o):Vue.http.get(this.imageFileUri.replace("{id}",t)).catch(function(){return Vue.Promise.reject("Failed to load image "+t+"!")}).then(function(t){if("application/json"===t.bodyBlob.type){var n=t.body.uuid;return t.body.url=e.tilesUri.replace("{uuid}",n[0]+n[1]+"/"+n[2]+n[3]+"/"+n),t.body}var a=window.URL||window.webkitURL;return i.src=a.createObjectURL(t.bodyBlob),o})},drawSimpleImage:function(t){return t.canvas.width=t.width,t.canvas.height=t.height,t.canvas.getContext("2d").drawImage(t.source,0,0),t},drawColorAdjustedImage:function(e){o!==e.source.src&&(i?i.loadContentsOf(e.source):i=t.texture(e.source),o=e.source.src),t.draw(i);for(var n in this.colorAdjustment)this.colorAdjustment.hasOwnProperty(n)&&this.isAdjustmentActive(n)&&t[n].apply(t,this.colorAdjustment[n]);return t.update(),e.canvas.width=e.width,e.canvas.height=e.height,e.canvas.getContext("2d").drawImage(t,0,0),e},drawImage:function(t){return this.checkSupportsColorAdjustment(t),this.currentlyDrawnImage=t,this.supportsColorAdjustment&&this.hasColorAdjustment?this.drawColorAdjustedImage(t):this.isTiledImage(t)?t:this.drawSimpleImage(t)},fetchImage:function(t){return this.cache.hasOwnProperty(t)||(e.$emit("images.fetching",t),this.cache[t]=this.createImage(t),this.cachedIds.push(t)),this.cache[t]},fetchAndDrawImage:function(t){return this.fetchImage(t).then(this.drawImage)},updateColorAdjustment:function(t){if(this.supportsColorAdjustment){var e,n,i=this.colorAdjustment,o=this.hasColorAdjustment;for(e in t)if(t.hasOwnProperty(e))for(n=t[e].length-1;n>=0;n--)i[e].splice(n,1,t[e][n]);this.hasColorAdjustment?this.drawColorAdjustedImage(this.currentlyDrawnImage):o&&this.drawSimpleImage(this.currentlyDrawnImage)}}},watch:{cachedIds:function(t){if(t.length>this.maxCacheSize){var e=t.shift();this.cache[e];delete this.cache[e]}}}})}),biigle.$declare("annotations.stores.map",function(){var t=new ol.Map({renderer:"canvas",controls:[new ol.control.Zoom,new ol.control.ZoomToExtent({tipLabel:"Zoom to show whole image",label:""})],interactions:ol.interaction.defaults({altShiftDragRotate:!1,doubleClickZoom:!1,keyboard:!1,shiftDragZoom:!1,pinchRotate:!1,pinchZoom:!1})}),e=biigle.$require("annotations.ol.ZoomToNativeControl");return t.addControl(new e({label:""})),t}),biigle.$declare("annotations.stores.settings",new Vue({data:function(){return{settings:{},storageKey:"biigle.annotations.settings"}},computed:{debounce:function(){
return biigle.$require("annotations.stores.utils").debounce}},methods:{set:function(t,e){this.settings.hasOwnProperty(t)?this.settings[t]=e:Vue.set(this.settings,t,e)},delete:function(t){Vue.delete(this.settings,t)},get:function(t){return this.settings[t]},has:function(t){return this.settings.hasOwnProperty(t)},storeSettings:function(){for(var t in this.settings)if(this.settings.hasOwnProperty(t))return void window.localStorage.setItem(this.storageKey,JSON.stringify(this.settings));window.localStorage.removeItem(this.storageKey)},restoreProperties:function(t,e){e.forEach(function(e){this.has(e)&&Vue.set(t,e,this.get(e))},this)}},created:function(){var t=JSON.parse(window.localStorage.getItem(this.storageKey));t&&Vue.set(this,"settings",t)},watch:{settings:{handler:function(){this.debounce(this.storeSettings,100,"annotations.settings")},deep:!0}}})),biigle.$declare("annotations.stores.styles",function(){var t={white:[255,255,255,1],blue:[0,153,255,1],orange:"#ff5e00"},e={},n=new ol.style.Stroke({color:t.white,width:5}),i=new ol.style.Stroke({color:t.white,width:6}),o=new ol.style.Stroke({color:t.blue,width:3}),a=new ol.style.Stroke({color:t.orange,width:3}),s=new ol.style.Fill({color:t.blue}),r=new ol.style.Fill({color:t.orange}),l=new ol.style.Stroke({color:t.white,width:2}),h=new ol.style.Stroke({color:t.white,width:3}),c=new ol.style.Stroke({color:t.white,width:2,lineDash:[3]}),u=new ol.style.Stroke({color:t.blue,width:3,lineDash:[5]});new ol.style.Fill({color:t.blue}),new ol.style.Fill({color:t.orange});return{colors:t,features:function(i){var o=i.get("color");return o=o?"#"+o:t.blue,e.hasOwnProperty(o)||(e[o]=[new ol.style.Style({stroke:n,image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:o}),stroke:l})}),new ol.style.Style({stroke:new ol.style.Stroke({color:o,width:3})})]),e[o]},highlight:[new ol.style.Style({stroke:i,image:new ol.style.Circle({radius:6,fill:r,stroke:h}),zIndex:200}),new ol.style.Style({stroke:a,zIndex:200})],editing:[new ol.style.Style({stroke:n,image:new ol.style.Circle({radius:6,fill:s,stroke:c})}),new ol.style.Style({stroke:u})],viewport:[new ol.style.Style({stroke:o}),new ol.style.Style({stroke:new ol.style.Stroke({color:t.white,width:1})})],cross:[new ol.style.Style({image:new ol.style.RegularShape({stroke:i,points:4,radius1:6,radius2:0,angle:Math.PI/4})}),new ol.style.Style({image:new ol.style.RegularShape({stroke:a,points:4,radius1:6,radius2:0,angle:Math.PI/4})})]}}),biigle.$declare("annotations.stores.utils",function(){var t={},e={},n={};return{debounce:function(e,n,i){t.hasOwnProperty(i)&&window.clearTimeout(t[i]),t[i]=window.setTimeout(e,n)},throttle:function(t,i,o){n[o]=t,e.hasOwnProperty(o)||(e[o]=window.setTimeout(function(){n[o](),delete e[o]},i))}}}),biigle.$component("annotations.components.annotationCanvas.annotationTooltip",function(){var t;return{components:{annotationTooltip:biigle.$require("annotations.components.annotationTooltip")},props:{showAnnotationTooltip:{type:Boolean,default:!1}},data:function(){return{hoveredAnnotationHash:"",hoveredAnnotations:[]}},methods:{updateHoveredAnnotations:function(e){var n=[];t.forEachFeatureAtPixel(e.pixel,function(t){t.get("annotation")&&n.push(t.get("annotation"))},{layerFilter:function(t){return"annotations"===t.get("name")}});var i=n.map(function(t){return t.id}).sort().join("");this.hoveredAnnotationHash!==i&&(this.hoveredAnnotationHash=i,this.hoveredAnnotations=n)},resetHoveredAnnotations:function(){this.hoveredAnnotationHash="",this.hoveredAnnotations=[]}},watch:{showAnnotationTooltip:function(e){e?(t.on("pointermove",this.updateMouseDomPosition),t.on("pointermove",this.updateHoveredAnnotations)):(t.un("pointermove",this.updateMouseDomPosition),t.un("pointermove",this.updateHoveredAnnotations),this.resetHoveredAnnotations())}},created:function(){t=biigle.$require("annotations.stores.map")}}}),biigle.$component("annotations.components.annotationCanvas.lawnmower",function(){var t;return{data:function(){return{imageSection:[0,0],imageSectionCenter:[0,0]}},computed:{imageSectionSteps:function(){return[Math.ceil(this.image.width/(this.viewExtent[2]-this.viewExtent[0])),Math.ceil(this.image.height/(this.viewExtent[3]-this.viewExtent[1]))]},imageSectionStepSize:function(){var t,e=[this.viewExtent[2]-this.viewExtent[0],this.viewExtent[3]-this.viewExtent[1]];return this.imageSectionSteps[0]>1?(t=e[0]*this.imageSectionSteps[0]-this.image.width,e[0]-=t/(this.imageSectionSteps[0]-1)):e[0]=this.viewExtent[2],this.imageSectionSteps[1]>1?(t=e[1]*this.imageSectionSteps[1]-this.image.height,e[1]-=t/(this.imageSectionSteps[1]-1)):e[1]=this.viewExtent[3],e},imageSectionStartCenter:function(){var t=[(this.viewExtent[2]-this.viewExtent[0])/2,(this.viewExtent[3]-this.viewExtent[1])/2];return this.imageSectionSteps[0]<=1&&(t[0]=this.extent[2]/2),this.imageSectionSteps[1]<=1&&(t[1]=this.extent[3]/2),t},isLawnmowerAnnotationMode:function(){return"lawnmower"===this.annotationMode}},methods:{getImageSectionCenter:function(t){return[t[0]*this.imageSectionStepSize[0]+this.imageSectionStartCenter[0],t[1]*this.imageSectionStepSize[1]+this.imageSectionStartCenter[1]]},showImageSection:function(e){return e[0]<this.imageSectionSteps[0]&&e[1]<this.imageSectionSteps[1]&&e[0]>=0&&e[1]>=0&&(this.imageSection=e,this.imageSectionCenter=this.getImageSectionCenter(e),t.getView().setCenter(this.imageSectionCenter),!0)},showLastImageSection:function(){this.showImageSection([this.imageSectionSteps[0]-1,this.imageSectionSteps[1]-1])},showFirstImageSection:function(){this.showImageSection([0,0])},showPreviousImageSection:function(){var t=this.imageSection[0]-1;return t>=0?this.showImageSection([t,this.imageSection[1]]):this.showImageSection([this.imageSectionSteps[0]-1,this.imageSection[1]-1])},showNextImageSection:function(){var t=this.imageSection[0]+1;return t<this.imageSectionSteps[0]?this.showImageSection([t,this.imageSection[1]]):this.showImageSection([0,this.imageSection[1]+1])}},watch:{viewExtent:function(){if(this.isLawnmowerAnnotationMode&&Number.isInteger(this.imageSectionSteps[0])&&Number.isInteger(this.imageSectionSteps[1])){for(var t=1/0,e=0,n=[0,0],i=0;i<this.imageSectionSteps[1];i++)for(var o=0;o<this.imageSectionSteps[0];o++)(e=function(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))}(this.imageSectionCenter,this.getImageSectionCenter([o,i])))<t&&(n[0]=o,n[1]=i,t=e);this.showImageSection(n)}}},created:function(){t=biigle.$require("annotations.stores.map")}}}),biigle.$component("annotations.components.annotationCanvas.mousePosition",function(){var t,e;return{components:{mousePositionIndicator:biigle.$require("annotations.components.mousePositionIndicator")},props:{showMousePosition:{type:Boolean,default:!1}},data:function(){return{mousePosition:[0,0],mouseDomPosition:[0,0]}},methods:{updateMouseDomPosition:function(t){this.mouseDomPosition=t.pixel},updateMousePosition:function(t){var n=this;e(function(){n.mousePosition=n.invertPointsYAxis(t.coordinate).map(Math.round)},100,"annotations.canvas.mouse-position")}},watch:{showMousePosition:function(e){e?t.on("pointermove",this.updateMousePosition):t.un("pointermove",this.updateMousePosition)}},created:function(){t=biigle.$require("annotations.stores.map"),e=biigle.$require("annotations.stores.utils").throttle}}}),biigle.$component("annotations.components.annotationCanvas.sampling",function(){var t,e=new ol.layer.Vector({source:new ol.source.Vector,style:[new ol.style.Style({image:new ol.style.Circle({radius:6,stroke:new ol.style.Stroke({color:"white",width:4})})}),new ol.style.Style({image:new ol.style.Circle({radius:6,stroke:new ol.style.Stroke({color:[0,153,255,1],width:2,lineDash:[3]})})})],zIndex:90,updateWhileAnimating:!0,updateWhileInteracting:!0}),n=new ol.Feature(new ol.geom.Point([0,0]));return e.getSource().addFeature(n),e.setVisible(!1),{data:function(){return{regularSamplingRows:null,regularSamplingColumns:null,currentSamplingIndex:null,randomSamplingCount:null,randomLocationMemory:{}}},computed:{regularSamplingLocations:function(){for(var t=[this.image.width/this.regularSamplingColumns,this.image.height/this.regularSamplingRows],e=[t[0]/2,t[1]/2],n=[],i=this.regularSamplingColumns-1;i>=0;i--)for(var o=this.regularSamplingRows-1;o>=0;o--)n.unshift([e[0]+o*t[0],e[1]+i*t[1]]);return n},randomSamplingLocations:function(){if(!this.randomLocationMemory.hasOwnProperty(this.image.id)){for(var t=[],e=this.image.width,n=this.image.height,i=this.randomSamplingCount;i>0;i--)t.push([Math.round(Math.random()*e),Math.round(Math.random()*n)]);this.randomLocationMemory[this.image.id]=t}return this.randomLocationMemory[this.image.id]},samplingLocations:function(){return this[this.annotationMode+"Locations"]},isSamplingAnnotationMode:function(){return this.annotationMode.endsWith("Sampling")}},methods:{setSamplingData:function(t,e){"regularSampling"===t?Array.isArray(e)&&e[0]>0&&e[1]>0&&(this.regularSamplingRows=e[0],this.regularSamplingColumns=e[1]):"randomSampling"===t&&e>0&&(this.randomSamplingCount=e)},updateShownSamplingLocation:function(){var e=this.currentSamplingIndex;null!==e&&e>=0&&e<this.samplingLocations.length&&(t.getView().setCenter(this.samplingLocations[e]),n.getGeometry().setCoordinates(this.samplingLocations[e]))},showFirstSamplingLocation:function(){this.currentSamplingIndex=0,this.updateShownSamplingLocation()},showLastSamplingLocation:function(){this.currentSamplingIndex=this.samplingLocations.length-1,this.updateShownSamplingLocation()},showPreviousSamplingLocation:function(){var t=this.currentSamplingIndex-1;return!(t<0)&&(this.currentSamplingIndex=t,this.updateShownSamplingLocation(),!0)},showNextSamplingLocation:function(){var t=this.currentSamplingIndex+1;return!(t>=this.samplingLocations.length)&&(this.currentSamplingIndex=t,this.updateShownSamplingLocation(),!0)},createSampledAnnotation:function(){var t=this.samplingLocations[this.currentSamplingIndex];this.createPointAnnotationAt(t[0],t[1])}},watch:{isSamplingAnnotationMode:function(t){e.setVisible(t)},randomSamplingCount:function(){this.randomLocationMemory={}}},created:function(){t=biigle.$require("annotations.stores.map"),t.addLayer(e)}}}),biigle.$component("annotations.components.annotationCanvas.scaleLine",function(){return{components:{scaleLineIndicator:biigle.$require("annotations.components.scaleLineIndicator")},props:{showScaleLine:{type:Boolean,default:!1},imagesArea:{type:Object,default:null}}}}),biigle.$component("annotations.components.annotationCanvas.zoomLevel",function(){return{props:{showZoomLevel:{type:Boolean,default:!1}},components:{zoomLevelIndicator:biigle.$require("annotations.components.zoomLevelIndicator")}}});