angular.module("dias.annotations",["dias.api","dias.ui"]),angular.module("dias.annotations").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("dias.annotations").directive("annotationListItem",["labels",function(e){"use strict";return{scope:!0,controller:["$scope",function(t){t.shapeClass="icon-"+t.annotation.shape.toLowerCase(),t.selected=function(){return t.isSelected(t.annotation.id)},t.attachLabel=function(){e.attachToAnnotation(t.annotation)},t.removeLabel=function(n){e.removeFromAnnotation(t.annotation,n)},t.canAttachLabel=function(){return t.selected()&&e.hasSelected()},t.currentLabel=e.getSelected,t.currentConfidence=e.getCurrentConfidence}]}}]),angular.module("dias.annotations").directive("labelCategoryItem",["$compile","$timeout","$templateCache",function(e,t,n){"use strict";return{restrict:"C",templateUrl:"label-item.html",scope:!0,link:function(o,i,a){var r=angular.element(n.get("label-subtree.html"));t(function(){i.append(e(r)(o))})},controller:["$scope","labels",function(e,t){var n=!1,o=!1,i=!1,a=function(){t.isOpen(e.item)?n=!0:t.isSelected(e.item)?(n=!0,i=!0):(n=!1,i=!1)},r=function(){o=e.tree&&!!e.tree[e.item.id]};e.getSubtree=function(){return n?e.tree[e.item.id]:[]},e.getClass=function(){return{open:n,expandable:o,selected:i}},e.$on("categories.selected",a),a(),r()}]}}]),angular.module("dias.annotations").directive("labelItem",function(){"use strict";return{controller:["$scope",function(e){var t=e.annotationLabel.confidence;.25>=t?e["class"]="label-danger":.5>=t?e["class"]="label-warning":.75>=t?e["class"]="label-success":e["class"]="label-primary"}]}}),angular.module("dias.annotations").controller("AnnotationsController",["$scope","mapAnnotations","labels","annotations","shapes",function(e,t,n,o,i){"use strict";var a=t.getSelectedFeatures();e.selectedFeatures=a.getArray();var r=function(){e.annotations=o.current()};e.annotations=[],e.clearSelection=t.clearSelection,e.selectAnnotation=function(n,o){n.shiftKey||e.clearSelection(),t.select(o)},e.fitAnnotation=t.fit,e.isSelected=function(e){var t=!1;return a.forEach(function(n){n.annotation&&n.annotation.id==e&&(t=!0)}),t},e.$on("image.shown",r)}]),angular.module("dias.annotations").controller("AnnotatorController",["$scope","images","urlParams","msg","IMAGE_ID","keyboard",function(e,t,n,o,i,a){"use strict";var r=document.querySelector(".navbar-annotations-filename");e.imageLoading=!0,e.viewport={zoom:n.get("z"),center:[n.get("x"),n.get("y")]};var l=function(e){return r.innerHTML=e._filename,e},c=function(t){return e.imageLoading=!1,e.$broadcast("image.shown",t),t},s=function(e){return n.setSlug(e._id),e},u=function(){e.imageLoading=!0},f=function(e){return u(),t.show(e).then(c)["catch"](o.responseError)};e.nextImage=function(){return u(),t.next().then(l).then(c).then(s)["catch"](o.responseError)},e.prevImage=function(){return u(),t.prev().then(l).then(c).then(s)["catch"](o.responseError)},e.$on("canvas.moveend",function(t,o){e.viewport.zoom=o.zoom,e.viewport.center[0]=Math.round(o.center[0]),e.viewport.center[1]=Math.round(o.center[1]),n.set({z:e.viewport.zoom,x:e.viewport.center[0],y:e.viewport.center[1]})}),a.on(37,function(){e.prevImage(),e.$apply()}),a.on(39,function(){e.nextImage(),e.$apply()}),a.on(32,function(){e.nextImage(),e.$apply()}),t.init(),f(parseInt(i)).then(s)}]),angular.module("dias.annotations").controller("CanvasController",["$scope","mapImage","mapAnnotations","map","$timeout","debounce",function(e,t,n,o,i,a){"use strict";var r=o.getView();o.on("moveend",function(t){var n=function(){e.$emit("canvas.moveend",{center:r.getCenter(),zoom:r.getZoom()})};a(n,100,"annotator.canvas.moveend")}),o.on("change:view",function(){r=o.getView()}),t.init(e),n.init(e);var l=function(){i(function(){o.updateSize()},50,!1)};e.$on("sidebar.foldout.open",l),e.$on("sidebar.foldout.close",l)}]),angular.module("dias.annotations").controller("CategoriesController",["$scope","labels","keyboard",function(e,t,n){"use strict";var o=9,i="dias.annotations.label-favourites",a=function(){var t=e.favourites.map(function(e){return e.id});window.localStorage[i]=JSON.stringify(t)},r=function(){if(window.localStorage[i]){var t=JSON.parse(window.localStorage[i]);e.favourites=e.categories.filter(function(e){return-1!==t.indexOf(e.id)})}},l=function(t){t>=0&&t<e.favourites.length&&e.selectItem(e.favourites[t])};e.hotkeysMap=["𝟭","𝟮","𝟯","𝟰","𝟱","𝟲","𝟳","𝟴","𝟵"],e.categories=[],e.favourites=[],e.categories=t.getList(),e.categoriesTree=t.getTree(),r(),e.selectItem=function(n){t.setSelected(n),e.searchCategory="",e.$broadcast("categories.selected")},e.isFavourite=function(t){return-1!==e.favourites.indexOf(t)},e.toggleFavourite=function(t,n){t.stopPropagation();var i=e.favourites.indexOf(n);-1===i&&e.favourites.length<o?e.favourites.push(n):e.favourites.splice(i,1),a()},e.favouritesLeft=function(){return e.favourites.length<o},n.on("1",function(){l(0),e.$apply()}),n.on("2",function(){l(1),e.$apply()}),n.on("3",function(){l(2),e.$apply()}),n.on("4",function(){l(3),e.$apply()}),n.on("5",function(){l(4),e.$apply()}),n.on("6",function(){l(5),e.$apply()}),n.on("7",function(){l(6),e.$apply()}),n.on("8",function(){l(7),e.$apply()}),n.on("9",function(){l(8),e.$apply()})}]),angular.module("dias.annotations").controller("ConfidenceController",["$scope","labels",function(e,t){"use strict";e.confidence=1,e.$watch("confidence",function(n){t.setCurrentConfidence(parseFloat(n)),.25>=n?e.confidenceClass="label-danger":.5>=n?e.confidenceClass="label-warning":.75>=n?e.confidenceClass="label-success":e.confidenceClass="label-primary"})}]),angular.module("dias.annotations").controller("DrawingControlsController",["$scope","mapAnnotations","labels","msg","$attrs","keyboard",function(e,t,n,o,i,a){"use strict";e.selectShape=function(a){if(null!==a&&e.selectedShape()!==a){if(!n.hasSelected())return e.$emit("sidebar.foldout.do-open","categories"),void o.info(i.selectCategory);t.startDrawing(a)}else t.finishDrawing()},e.selectedShape=t.getSelectedDrawingType,a.on(27,function(){e.selectShape(null),e.$apply()}),a.on("a",function(){e.selectShape("Point"),e.$apply()}),a.on("s",function(){e.selectShape("Rectangle"),e.$apply()}),a.on("d",function(){e.selectShape("Circle"),e.$apply()}),a.on("f",function(){e.selectShape("LineString"),e.$apply()}),a.on("g",function(){e.selectShape("Polygon"),e.$apply()})}]),angular.module("dias.annotations").controller("EditControlsController",["$scope","mapAnnotations","keyboard","$timeout",function(e,t,n,o){"use strict";var i,a=!1,r=1e4;e.deleteSelectedAnnotations=function(){t.hasSelectedFeatures()&&confirm("Are you sure you want to delete all selected annotations?")&&t.deleteSelected()},e.hasSelectedAnnotations=t.hasSelectedFeatures;var l=function(){t.startMoving()},c=function(){t.finishMoving()};e.moveSelectedAnnotations=function(){e.isMoving()?c():l()},e.canDeleteLastAnnotation=function(){return a&&t.hasDrawnAnnotation()},e.deleteLastDrawnAnnotation=function(){t.deleteLastDrawnAnnotation()},e.isMoving=t.isMoving,e.$on("annotations.drawn",function(e,t){a=!0,o.cancel(i),i=o(function(){a=!1},r)}),n.on(46,function(t){e.deleteSelectedAnnotations(),e.$apply()}),n.on(27,function(){e.isMoving()&&e.$apply(c)}),n.on(8,function(t){e.canDeleteLastAnnotation()&&(t.preventDefault(),e.deleteLastDrawnAnnotation(),e.$apply())}),n.on("m",function(){e.$apply(e.moveSelectedAnnotations)})}]),angular.module("dias.annotations").controller("MinimapController",["$scope","map","mapImage","$element","styles",function(e,t,n,o,i){"use strict";var a=o[0],r=new ol.source.Vector,l=new ol.Map({target:a,controls:[],interactions:[]}),c=t.getSize(),s=t.getView();l.addLayer(n.getLayer()),l.addLayer(new ol.layer.Vector({source:r,style:i.viewport}));var u=new ol.Feature;r.addFeature(u),e.$on("image.shown",function(){var e=n.getExtent();l.setView(new ol.View({projection:n.getProjection(),center:ol.extent.getCenter(e),resolution:Math.max(e[2]/a.clientWidth,e[3]/a.clientHeight)}))});var f=function(){u.setGeometry(ol.geom.Polygon.fromExtent(s.calculateExtent(c)))};t.on("change:size",function(){c=t.getSize()}),t.on("change:view",function(){s=t.getView()}),t.on("postcompose",f);var d=function(e){s.setCenter(e.coordinate)};l.on("pointerdrag",d),o.on("mouseleave",function(){l.un("pointerdrag",d)}),o.on("mouseenter",function(){l.on("pointerdrag",d)})}]),angular.module("dias.annotations").controller("SelectedLabelController",["$scope","labels",function(e,t){"use strict";e.getSelectedLabel=t.getSelected,e.hasSelectedLabel=t.hasSelected}]),angular.module("dias.annotations").controller("SettingsAnnotationOpacityController",["$scope","mapAnnotations",function(e,t){"use strict";e.setDefaultSettings("annotation_opacity","1"),e.$watch("settings.annotation_opacity",function(e){t.setOpacity(e)})}]),angular.module("dias.annotations").controller("SettingsAnnotationsCyclingController",["$scope","mapAnnotations","labels","keyboard",function(e,t,n,o){"use strict";var i=!1,a="annotations",r=function(n){return!i&&e.cycling()?(t.hasNext()?t.cycleNext():(e.nextImage().then(t.jumpToFirst),i=!0),n&&e.$apply(),!1):void 0},l=function(n){return!i&&e.cycling()?(t.hasPrevious()?t.cyclePrevious():(e.prevImage().then(t.jumpToLast),i=!0),n&&e.$apply(),!1):void 0},c=function(o){i||(o&&o.preventDefault(),e.cycling()&&n.hasSelected()?n.attachToAnnotation(t.getCurrent()).$promise.then(function(){t.flicker(1)}):t.flicker())},s=function(t){return t.preventDefault(),e.stopCycling(),e.$apply(),!1};e.attributes={restrict:!1},e.cycling=function(){return e.getVolatileSettings("cycle")===a},e.startCycling=function(){e.setVolatileSettings("cycle",a)},e.stopCycling=function(){e.setVolatileSettings("cycle","")},e.$watch("volatileSettings.cycle",function(e,n){e===a?(o.on(37,l,10),o.on(39,r,10),o.on(32,r,10),o.on(13,c,10),o.on(27,s,10),t.jumpToCurrent()):n===a&&(o.off(37,l),o.off(39,r),o.off(32,r),o.off(13,c),o.off(27,s),t.clearSelection())});var u,f=function(){u&&u(),u=e.$watch(n.getSelected,function(){e.cycling()&&t.jumpToFirst()})};e.$watch("attributes.restrict",function(n){t.setRestrictLabelCategory(n),e.cycling()&&t.jumpToFirst(),n?f():u&&u()}),e.$on("image.shown",function(){i=!1}),e.prevAnnotation=l,e.nextAnnotation=r,e.attachLabel=c}]),angular.module("dias.annotations").controller("SettingsController",["$scope","debounce",function(e,t){"use strict";var n="dias.annotations.settings",o={};e.settings={},e.volatileSettings={};var i=function(){var t=angular.copy(e.settings);for(var i in t)t[i]===o[i]&&delete t[i];window.localStorage[n]=JSON.stringify(t)},a=function(){t(i,250,n)},r=function(){var e={};return window.localStorage[n]&&(e=JSON.parse(window.localStorage[n])),angular.extend(e,o)};e.setSettings=function(t,n){e.settings[t]=n},e.getSettings=function(t){return e.settings[t]},e.setDefaultSettings=function(t,n){o[t]=n,e.settings.hasOwnProperty(t)||e.setSettings(t,n)},e.setVolatileSettings=function(t,n){e.volatileSettings[t]=n},e.getVolatileSettings=function(t){return e.volatileSettings[t]},e.$watch("settings",a,!0),angular.extend(e.settings,r())}]),angular.module("dias.annotations").controller("SettingsSectionCyclingController",["$scope","map","mapImage","keyboard",function(e,t,n,o){"use strict";var i,a=!1,r="sections",l=[0,0],c=[0,0],s=[0,0],u=[0,0],f=function(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))},d=function(e){for(var t=1/0,n=0,o=[0,0],i=0;i<=s[1];i++)for(var a=0;a<=s[0];a++)n=f(e,y([a,i])),t>n&&(o[0]=a,o[1]=i,t=n);return o},g=function(){i=t.getView(),i.on("change:resolution",h);var e=n.getExtent(),o=i.calculateExtent(t.getSize());c[0]=o[2]-o[0],c[1]=o[3]-o[1],l[0]=c[0]/2,l[1]=c[1]/2,s[0]=Math.ceil(e[2]/c[0])-1,s[1]=Math.ceil(e[3]/c[1])-1;var a;s[0]>0?(a=c[0]*(s[0]+1)-e[2],c[0]-=a/s[0]):(c[0]=o[2],l[0]=e[2]/2),s[1]>0?(a=c[1]*(s[1]+1)-e[3],c[1]-=a/s[1]):(c[1]=o[3],l[1]=e[3]/2)},h=function(){g();var e=d(y(u));u[0]=e[0],u[1]=e[1]},p=function(){g(),w(d(i.getCenter()))},m=function(){w([0,0])},v=function(){w(s)},y=function(e){return[e[0]*c[0]+l[0],e[1]*c[1]+l[1]]},w=function(e){u[0]=e[0],u[1]=e[1],i.setCenter(y(u))},S=function(){return u[0]<s[0]?[u[0]+1,u[1]]:[0,u[1]+1]},b=function(){return u[0]>0?[u[0]-1,u[1]]:[s[0],u[1]-1]},$=function(t){return!a&&e.cycling()?(u[0]<s[0]||u[1]<s[1]?w(S()):(e.nextImage().then(g).then(m),a=!0),t&&e.$apply(),!1):void 0},C=function(t){return!a&&e.cycling()?(u[0]>0||u[1]>0?w(b()):(e.prevImage().then(g).then(v),a=!0),t&&e.$apply(),!1):void 0},A=function(t){return t.preventDefault(),e.stopCycling(),e.$apply(),!1};e.cycling=function(){return e.getVolatileSettings("cycle")===r},e.startCycling=function(){e.setVolatileSettings("cycle",r)},e.stopCycling=function(){e.setVolatileSettings("cycle","")},e.$watch("volatileSettings.cycle",function(e,n){e===r?(t.on("change:size",p),g(),m(),o.on(37,C,10),o.on(39,$,10),o.on(32,$,10),o.on(27,A,10)):n===r&&(t.un("change:size",p),i.un("change:resolution",h),o.off(37,C),o.off(39,$),o.off(32,$),o.off(27,A))}),e.$on("image.shown",function(){a=!1}),e.prevSection=C,e.nextSection=$}]),angular.module("dias.annotations").controller("SidebarCategoryFoldoutController",["$scope","keyboard",function(e,t){"use strict";t.on(9,function(t){t.preventDefault(),e.toggleFoldout("categories"),e.$apply()})}]),angular.module("dias.annotations").controller("SidebarController",["$scope","$rootScope",function(e,t){"use strict";var n="dias.annotations.sidebar-foldout";e.foldout="",e.openFoldout=function(o){window.localStorage[n]=o,e.foldout=o,t.$broadcast("sidebar.foldout.open",o)},e.closeFoldout=function(){window.localStorage.removeItem(n),e.foldout="",t.$broadcast("sidebar.foldout.close")},e.toggleFoldout=function(t){e.foldout===t?e.closeFoldout():e.openFoldout(t)},t.$on("sidebar.foldout.do-open",function(t,n){e.openFoldout(n)}),window.localStorage[n]&&e.openFoldout(window.localStorage[n])}]),angular.module("dias.annotations").factory("ZoomToNativeControl",function(){"use strict";function e(e){var t=e||{},n=t.label?t.label:"1",o=document.createElement("button"),i=this;o.innerHTML=n,o.title="Zoom to original resolution",o.addEventListener("click",function(){i.zoomToNative.call(i)});var a=document.createElement("div");a.className="zoom-to-native ol-unselectable ol-control",a.appendChild(o),ol.control.Control.call(this,{element:a,target:t.target}),this.duration_=void 0!==t.duration?t.duration:250}return ol.inherits(e,ol.control.Control),e.prototype.zoomToNative=function(){var e=this.getMap(),t=e.getView();if(t){var n=t.getResolution();n&&(this.duration_>0&&e.beforeRender(ol.animation.zoom({resolution:n,duration:this.duration_,easing:ol.easing.easeOut})),t.setResolution(t.constrainResolution(1)))}},e}),angular.module("dias.annotations").factory("map",["ZoomToNativeControl",function(e){"use strict";var t=new ol.Map({target:"canvas",renderer:"canvas",controls:[new ol.control.Zoom,new ol.control.ZoomToExtent({tipLabel:"Zoom to show whole image",label:""}),new ol.control.FullScreen({label:""}),new e({label:""})],interactions:ol.interaction.defaults({keyboard:!1})});return t}]),angular.module("dias.annotations").service("annotations",["Annotation","shapes","msg",function(e,t,n){"use strict";var o,i,a=function(e){return e.shape=t.getName(e.shape_id),e},r=function(e){return o.push(e),e};this.query=function(t){return o=e.query(t),i=o.$promise,i.then(function(e){e.forEach(a)}),o},this.add=function(o){!o.shape_id&&o.shape&&(o.shape_id=t.getId(o.shape));var i=e.add(o);return i.$promise.then(a).then(r)["catch"](n.responseError),i},this["delete"]=function(e){var t=o.indexOf(e);return t>-1?e.$delete(function(){t=o.indexOf(e),o.splice(t,1)},n.responseError):void 0},this.forEach=function(e){return o.forEach(e)},this.current=function(){return o},this.getPromise=function(){return i}}]),angular.module("dias.annotations").service("images",["$rootScope","URL","$q","filterSubset","TRANSECT_ID","IMAGES_IDS","IMAGES_FILENAMES",function(e,t,n,o,i,a,r){"use strict";var l=this,c=[],s=10,u=[];this.currentImage=void 0;var f=function(e){var t=a.indexOf(e);return r[t]},d=function(e){e=e||l.currentImage._id;var t=c.indexOf(e);return c[(t+1)%c.length]},g=function(e){e=e||l.currentImage._id;var t=c.indexOf(e),n=c.length;return c[(t-1+n)%n]},h=function(e){e=e||l.currentImage._id;for(var t=u.length-1;t>=0;t--)if(u[t]._id==e)return u[t]},p=function(e){return l.currentImage=e,e},m=function(o){var i=n.defer(),a=h(o);return a?i.resolve(a):(a=document.createElement("img"),a._id=o,a._filename=f(o),a.onload=function(){u.push(a),u.length>s&&u.shift(),i.resolve(a)},a.onerror=function(e){i.reject(e)},a.src=t+"/api/v1/images/"+o+"/file"),e.$broadcast("image.fetching",a),i.promise},v=function(e){return m(d(e._id)),m(g(e._id)),e};this.init=function(){c=a;var e=window.localStorage["dias.transects."+i+".images"];e&&(e=JSON.parse(e),o(e,c),c=e)},this.show=function(e){return m(e).then(p).then(v)},this.next=function(){return l.show(d())},this.prev=function(){return l.show(g())},this.getCurrentId=function(){return l.currentImage._id}}]),angular.module("dias.annotations").service("labels",["AnnotationLabel","msg","LABEL_TREES",function(e,t,n){"use strict";var o,i=1,a=n,r={},l=[],c=[],s=function(){for(var e=null,t=function(t){var n=t.parent_id;r[e][n]?r[e][n].push(t):r[e][n]=[t]},n=a.length-1;n>=0;n--)e=a[n].name,r[e]={},a[n].labels.forEach(t),l=l.concat(a[n].labels)},u=function(e){for(var t=l.length-1;t>=0;t--)if(l[t].id===e)return l[t];return null},f=function(e){var t=e;if(c.length=0,t)for(;null!==t.parent_id;)c.unshift(t.parent_id),t=u(t.parent_id)};this.fetchForAnnotation=function(t){return t?(t.labels||(t.labels=e.query({annotation_id:t.id})),t.labels):void 0},this.attachToAnnotation=function(n){var a=e.attach({annotation_id:n.id,label_id:o.id,confidence:i});return a.$promise.then(function(){n.labels.push(a)}),a.$promise["catch"](t.responseError),a},this.removeFromAnnotation=function(n,o){var i=n.labels.indexOf(o);return i>-1?e["delete"]({id:o.id},function(){i=n.labels.indexOf(o),n.labels.splice(i,1)},t.responseError):void 0},this.getTree=function(){return r},this.getList=function(){return l},this.setSelected=function(e){o=e,f(e)},this.getSelected=function(){return o},this.hasSelected=function(){return!!o},this.getSelectedId=function(){return o?o.id:null},this.setCurrentConfidence=function(e){i=e},this.getCurrentConfidence=function(){return i},this.isOpen=function(e){return-1!==c.indexOf(e.id)},this.isSelected=function(e){return o&&o.id===e.id},s()}]),angular.module("dias.annotations").service("mapAnnotations",["map","images","annotations","debounce","styles","$interval","labels",function(e,t,n,o,i,a,r){"use strict";var l=new ol.Collection,c=new ol.source.Vector({features:l}),s=new ol.layer.Vector({source:c,style:i.features,zIndex:100}),u=new ol.interaction.Select({style:i.highlight,layers:[s],multi:!0}),f=u.getFeatures(),d=new ol.interaction.Modify({features:l,deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}});d.setActive(!1);var g=new ol.interaction.Translate({features:f});g.setActive(!1);var h,p,m,v,y=0,w=!1,S=this,b=function(t){S.clearSelection(),t&&(f.push(t),e.getView().fit(t.getGeometry(),e.getSize(),{padding:[50,50,50,50]}))},$=function(e,n){return n%2===1?t.currentImage.height-e:e},C=function(e){var t;switch(e.getType()){case"Circle":t=[e.getCenter(),[e.getRadius()]];break;case"Polygon":case"Rectangle":t=e.getCoordinates()[0];break;case"Point":t=[e.getCoordinates()];break;default:t=e.getCoordinates()}return[].concat.apply([],t).map(Math.round).map($)},A=function(e){var t=e.target,n=function(){t.annotation.points=C(t.getGeometry()),t.annotation.$save()};o(n,500,t.annotation.id)},I=function(e){for(var n,o=e.points,i=[],a=t.currentImage.height,r=0;r<o.length;r+=2)i.push([o[r],a-(o[r+1]||0)]);switch(e.shape){case"Point":n=new ol.geom.Point(i[0]);break;case"Rectangle":n=new ol.geom.Rectangle([i]);break;case"Polygon":n=new ol.geom.Polygon([i]);break;case"LineString":n=new ol.geom.LineString(i);break;case"Circle":n=new ol.geom.Circle(i[0],i[1][0]);break;default:return void console.error("Unknown annotation shape: "+e.shape)}var l=new ol.Feature({geometry:n});l.annotation=e,e.labels&&e.labels.length>0&&(l.color=e.labels[0].label.color),l.on("change",A),c.addFeature(l)},L=function(e,t){c.clear(),S.clearSelection(),m=null,n.query({id:t._id}).$promise.then(function(){n.forEach(I)})},x=function(e){var o=e.feature.getGeometry(),i=r.getSelected();return e.feature.color=i.color,e.feature.annotation=n.add({id:t.getCurrentId(),shape:o.getType(),points:C(o),label_id:i.id,confidence:r.getCurrentConfidence()}),e.feature.annotation.$promise["catch"](function(){c.removeFeature(e.feature)}),e.feature.on("change",A),m=e.feature,e.feature.annotation.$promise},k=function(e){e&&e.annotation&&(e===m&&(m=null),n["delete"](e.annotation).then(function(){c.removeFeature(e),f.remove(e)}))},F=function(e){if(!e.labels)return!1;for(var t=r.getSelectedId(),n=0;n<e.labels.length;n++)if(e.labels[n].label&&e.labels[n].label.id===t)return!0;return!1},E=function(e){return!w||F(e.annotation)},T=function(){return l.getArray().filter(E)};this.init=function(t){v=t,e.addLayer(s),e.addInteraction(u),e.addInteraction(g),e.addInteraction(d),t.$on("image.shown",L);var n=function(){t.$$phase||t.$apply()};f.on("change:length",n)},this.startDrawing=function(t){u.setActive(!1),d.setActive(!0),S.finishMoving(),e.removeInteraction(h),p=t||"Point",h=new ol.interaction.Draw({source:c,type:p,style:i.editing}),e.addInteraction(h),h.on("drawend",x),h.on("drawend",function(e){v.$broadcast("annotations.drawn",e.feature)})},this.finishDrawing=function(){e.removeInteraction(h),h.setActive(!1),p=void 0,u.setActive(!0),d.setActive(!1),S.clearSelection()},this.isDrawing=function(){return h&&h.getActive()},this.startMoving=function(){S.isDrawing()&&S.finishDrawing(),g.setActive(!0)},this.finishMoving=function(){g.setActive(!1)},this.isMoving=function(){return g.getActive()},this.hasDrawnAnnotation=function(){return m&&m.annotation&&m.annotation.$resolved},this.deleteLastDrawnAnnotation=function(){k(m)},this.deleteSelected=function(){f.forEach(k)},this.select=function(e){var t;c.forEachFeature(function(n){n.annotation.id===e&&(t=n)}),f.remove(t)||f.push(t)},this.hasSelectedFeatures=function(){return f.getLength()>0},this.fit=function(t){c.forEachFeature(function(n){if(n.annotation.id===t){var o=e.getView(),i=ol.animation.pan({source:o.getCenter()}),a=ol.animation.zoom({resolution:o.getResolution()});e.beforeRender(i,a),o.fit(n.getGeometry(),e.getSize())}})},this.clearSelection=function(){f.clear()},this.getSelectedFeatures=function(){return f},this.getSelectedDrawingType=function(){return p},this.addFeature=function(e){return c.addFeature(e),x({feature:e})},this.setOpacity=function(e){s.setOpacity(e)},this.cycleNext=function(){y=(y+1)%T().length,S.jumpToCurrent()},this.hasNext=function(){return y+1<T().length},this.cyclePrevious=function(){var e=T().length;y=(y+e-1)%e,S.jumpToCurrent()},this.hasPrevious=function(){return y>0},this.jumpToCurrent=function(){n.getPromise().then(function(){b(T()[y])})},this.jumpToFirst=function(){y=0,S.jumpToCurrent()},this.jumpToLast=function(){n.getPromise().then(function(){var e=T().length;0!==e&&(y=e-1),S.jumpToCurrent()})},this.flicker=function(e){var t=f.item(0);if(t){e=e||3;var n=function(){f.getLength()>0?f.clear():f.push(t)};a(n,100,2*e)}},this.getCurrent=function(){return T()[y].annotation},this.setRestrictLabelCategory=function(e){w=e}}]),angular.module("dias.annotations").service("mapImage",["map",function(e){"use strict";var t=[0,0,0,0],n=new ol.proj.Projection({code:"dias-image",units:"pixels",extent:t}),o=new ol.layer.Image;this.init=function(i){e.addLayer(o),i.$on("image.shown",function(a,r){t[2]=r.width,t[3]=r.height;var l=i.viewport.zoom,c=i.viewport.center;void 0===c[0]&&void 0===c[1]&&(c=ol.extent.getCenter(t));var s=new ol.source.ImageStatic({url:r.src,projection:n,imageExtent:t});o.setSource(s),e.setView(new ol.View({projection:n,center:c,zoom:l,zoomFactor:1.5,minResolution:.25,extent:t})),void 0===l&&e.getView().fit(t,e.getSize())})},this.getExtent=function(){return t},this.getProjection=function(){return n},this.getLayer=function(){return o}}]),angular.module("dias.annotations").service("styles",function(){"use strict";var e=this;this.colors={white:[255,255,255,1],blue:[0,153,255,1],orange:"#ff5e00"};var t=6,n=3,o=new ol.style.Stroke({color:this.colors.white,width:5}),i=new ol.style.Stroke({color:this.colors.white,width:6}),a=new ol.style.Stroke({color:this.colors.blue,width:n}),r=new ol.style.Stroke({color:this.colors.orange,width:n}),l=new ol.style.Fill({color:this.colors.blue}),c=new ol.style.Fill({color:this.colors.orange}),s=new ol.style.Stroke({color:this.colors.white,width:2}),u=new ol.style.Stroke({color:this.colors.white,width:n}),f=new ol.style.Stroke({color:this.colors.white,width:2,lineDash:[3]}),d=new ol.style.Stroke({color:this.colors.blue,width:n,lineDash:[5]});new ol.style.Fill({color:this.colors.blue}),new ol.style.Fill({color:this.colors.orange});this.features=function(n){var i=n.color?"#"+n.color:e.colors.blue;return[new ol.style.Style({stroke:o,image:new ol.style.Circle({radius:t,fill:new ol.style.Fill({color:i}),stroke:s})}),new ol.style.Style({stroke:new ol.style.Stroke({color:i,width:3})})]},this.highlight=[new ol.style.Style({stroke:i,image:new ol.style.Circle({radius:t,fill:c,stroke:u}),zIndex:200}),new ol.style.Style({stroke:r,zIndex:200})],this.editing=[new ol.style.Style({stroke:o,image:new ol.style.Circle({radius:t,fill:l,stroke:f})}),new ol.style.Style({stroke:d})],this.viewport=[new ol.style.Style({stroke:a}),new ol.style.Style({stroke:new ol.style.Stroke({color:this.colors.white,width:1})})]});